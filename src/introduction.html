

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>DTU Special Course</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'src/introduction';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="#">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1 current active">
                <a class="reference internal" href="#">
                    <no title>
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">





</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/FPWRasmussen/DTU-Special-Course" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/FPWRasmussen/DTU-Special-Course/issues/new?title=Issue%20on%20page%20%2Fsrc/introduction.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1><no title></h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/map/elevation_handler">Elevation Handler</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/noise_map">Noise Map</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/geometrical_spreading_of_sound">Geometrical Spreading of Sound</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/atmospheric_attenuation">Atmospheric Attenuation</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/ground_effect">Ground Effect</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/barrier_attenuation">Barrier Attenuation</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/verification">Barrier Verification</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/shadow_map">Shadow Map</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/fast_voxel_traversal">Fast Voxel Traversal</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/sun_calc">Solar Calculations</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/rotor_point_cloud">Rotor Point Cloud</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/multiprocessing">Multiprocessing</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/visual/visual_impact">Visual Impact</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/visual/google_street_view">Google Street View</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/visual/camera_calibration">Camera Calibration</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/visual/3d_object_to_image">3D Object to Image</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/bibliography">Bibliography</a></li>
</ul>

            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <!DOCTYPE html> <html> <head> <title>Wind Energy Impact Analysis Tools</title> </head> <body> <h1>Wind Energy Analysis Tools</h1> <p> This repository contains a collection of Jupyter notebooks developed as a part of the special course "Noise and Visual Impact Analysis in Wind Energy" at DTU (Technical University of Denmark). The notebooks are designed to assist in wind turbine impact assessments, specifically addressing shadow flickering, noise calculations (ISO 9613-2), and generating visual impact assessments using the Google Street View API. </p> <h2>Disclaimer</h2> <p> This project is a student initiative, and as such, the author does not assume any liability or provide any warranty for the quality of the product. Users are encouraged to contribute to further development under the terms of the <a href="../LICENSE">GNU Affero General Public License v3.0</a> license agreement. </p> <h2>Usage</h2> <ol> <li> Clone the repository using the following command: <pre><code>git clone https://github.com/FPWRasmussen/DTU-Special-Course.git</code></pre> </li> <li> Execute each individual Jupyter Notebook as needed. You can find the notebooks in the <code>src</code> directory. </li> <li> Alternatively, you can access the deployed GitHub page for direct access to the Jupyter Notebooks: <br> <a href="https://fpwrasmussen.github.io/DTU-Special-Course/">https://fpwrasmussen.github.io/DTU-Special-Course/</a> </li> </ol> <h2>Acknowledgments</h2> <p> Special thanks to the course instructors at the DTU Wind department for their guidance and support during the development of these tools. </p> </body> </html><div class="toctree-wrapper compound">
<span id="document-src/map/elevation_handler"></span><section class="tex2jax_ignore mathjax_ignore" id="elevation-handler">
<h1>Elevation Handler<a class="headerlink" href="#elevation-handler" title="Permalink to this heading">#</a></h1>
<p>The Shuttle Radar Topography Mission (SRTM) conducted by NASA in February 2000 <span id="id1">[<a class="reference internal" href="src/introduction.html#id10" title="NASA. Icesat - srtm30 documentation. 2000. URL: https://icesat.gsfc.nasa.gov/icesat/tools/SRTM30_Documentation.html (visited on 2023-11-27).">4</a>]</span> remains a important mission for collecting precise topographic data of the Earth’s surface. One of the notable resolutions of the SRTM data is 30 meters, indicating that elevation values are recorded at intervals of 30 meters across the Earth’s surface.</p>
<p>Spatially, the data is organized into a grid structure, where each cell represents a spatial unit of 1 degree of latitude by 1 degree of longitude. This 1° x 1° resolution simplifies the representation of geographic locations.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>

<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ElevationHandler</span><span class="p">,</span>
    <span class="n">print_code</span><span class="p">,</span>
    <span class="n">transform_coordinates</span><span class="p">,</span>
    <span class="n">resample_to_straight_axis</span><span class="p">,</span>
    <span class="n">generate_voxel_map</span><span class="p">,</span>
    <span class="n">download_elevation</span>
<span class="p">)</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">cartopy.io.img_tiles</span> <span class="kn">import</span> <span class="n">GoogleTiles</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">AutoLocator</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="kn">from</span> <span class="nn">matplotlib.cm</span> <span class="kn">import</span> <span class="n">ScalarMappable</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="import-of-srtm-data">
<h2>Import of SRTM data<a class="headerlink" href="#import-of-srtm-data" title="Permalink to this heading">#</a></h2>
<p>To utilize the data, a script has been developed. This script automates the download of the pertinent .hgt files and seamlessly integrates them to construct the comprehensive elevation map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">download_elevation</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">download_elevation</span><span style="color: #d0d0d0">(map_boundaries):</span>
<a id="True-2" name="True-2" href="#True-2"></a>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">long_min</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.minimum(map_boundaries[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">map_boundaries[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">])</span>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">long_max</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.maximum(map_boundaries[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">map_boundaries[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">])</span>
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #d0d0d0">lat_min</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.minimum(map_boundaries[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">map_boundaries[</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">])</span>
<a id="True-6" name="True-6" href="#True-6"></a>    <span style="color: #d0d0d0">lat_max</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.maximum(map_boundaries[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">map_boundaries[</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">])</span>
<a id="True-7" name="True-7" href="#True-7"></a>
<a id="True-8" name="True-8" href="#True-8"></a>    <span style="color: #d0d0d0">long_range</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.arange(np.floor(long_min),</span> <span style="color: #d0d0d0">np.ceil(long_max),</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)</span>
<a id="True-9" name="True-9" href="#True-9"></a>    <span style="color: #d0d0d0">lat_range</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.arange(np.floor(lat_min),</span> <span style="color: #d0d0d0">np.ceil(lat_max),</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)</span>
<a id="True-10" name="True-10" href="#True-10"></a>
<a id="True-11" name="True-11" href="#True-11"></a>    <span style="color: #d0d0d0">merged_map</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.zeros([</span><span style="color: #2fbccd">len</span><span style="color: #d0d0d0">(lat_range)*</span><span style="color: #51b2fd">3601</span><span style="color: #d0d0d0">,</span> <span style="color: #2fbccd">len</span><span style="color: #d0d0d0">(long_range)*</span><span style="color: #51b2fd">3601</span><span style="color: #d0d0d0">])</span>
<a id="True-12" name="True-12" href="#True-12"></a>
<a id="True-13" name="True-13" href="#True-13"></a>    <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">i,</span> <span style="color: #d0d0d0">latitude</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #2fbccd">enumerate</span><span style="color: #d0d0d0">(lat_range):</span>
<a id="True-14" name="True-14" href="#True-14"></a>        <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">j,</span> <span style="color: #d0d0d0">longitude</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #2fbccd">enumerate</span><span style="color: #d0d0d0">(long_range):</span>
<a id="True-15" name="True-15" href="#True-15"></a>            <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">latitude</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">:</span>
<a id="True-16" name="True-16" href="#True-16"></a>                <span style="color: #d0d0d0">lat_str</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;S&quot;</span><span style="color: #d0d0d0">+</span><span style="color: #2fbccd">str</span><span style="color: #d0d0d0">(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">(np.floor(-latitude))).zfill(</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">)</span>
<a id="True-17" name="True-17" href="#True-17"></a>            <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-18" name="True-18" href="#True-18"></a>                <span style="color: #d0d0d0">lat_str</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;N&quot;</span><span style="color: #d0d0d0">+</span><span style="color: #2fbccd">str</span><span style="color: #d0d0d0">(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">(np.floor(latitude))).zfill(</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">)</span>
<a id="True-19" name="True-19" href="#True-19"></a>                
<a id="True-20" name="True-20" href="#True-20"></a>            <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">longitude</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">:</span>
<a id="True-21" name="True-21" href="#True-21"></a>                <span style="color: #d0d0d0">long_str</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;W&quot;</span><span style="color: #d0d0d0">+</span><span style="color: #2fbccd">str</span><span style="color: #d0d0d0">(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">(np.floor(-longitude))).zfill(</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">)</span>
<a id="True-22" name="True-22" href="#True-22"></a>            <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-23" name="True-23" href="#True-23"></a>                <span style="color: #d0d0d0">long_str</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;E&quot;</span><span style="color: #d0d0d0">+</span><span style="color: #2fbccd">str</span><span style="color: #d0d0d0">(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">(np.floor(longitude))).zfill(</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">)</span>
<a id="True-24" name="True-24" href="#True-24"></a>
<a id="True-25" name="True-25" href="#True-25"></a>            <span style="color: #d0d0d0">output_name</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">f&quot;{</span><span style="color: #d0d0d0">lat_str</span><span style="color: #ed9d13">}{</span><span style="color: #d0d0d0">long_str</span><span style="color: #ed9d13">}&quot;</span>
<a id="True-26" name="True-26" href="#True-26"></a>            <span style="color: #ababab; font-style: italic"># hgt_gz_file = &quot;../../temp/&quot;+output_name+&quot;.hgt.gz&quot;</span>
<a id="True-27" name="True-27" href="#True-27"></a>            <span style="color: #ababab; font-style: italic"># hgt_file = &#39;../../temp/&#39;+ output_name+ &#39;.hgt&#39;</span>
<a id="True-28" name="True-28" href="#True-28"></a>
<a id="True-29" name="True-29" href="#True-29"></a>            <span style="color: #d0d0d0">hgt_gz_file</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">Path.joinpath(ROOT_DIR,</span> <span style="color: #ed9d13">&quot;temp/&quot;</span><span style="color: #d0d0d0">+output_name+</span><span style="color: #ed9d13">&quot;.hgt.gz&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-30" name="True-30" href="#True-30"></a>            <span style="color: #d0d0d0">hgt_file</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">Path.joinpath(ROOT_DIR,</span> <span style="color: #ed9d13">&quot;temp/&quot;</span><span style="color: #d0d0d0">+output_name+</span><span style="color: #ed9d13">&quot;.hgt&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-31" name="True-31" href="#True-31"></a>
<a id="True-32" name="True-32" href="#True-32"></a>            <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">os.path.exists(hgt_file):</span>
<a id="True-33" name="True-33" href="#True-33"></a>                <span style="color: #ababab; font-style: italic"># print(&quot;File exists!&quot;)</span>
<a id="True-34" name="True-34" href="#True-34"></a>                <span style="color: #6ebf26; font-weight: bold">pass</span>
<a id="True-35" name="True-35" href="#True-35"></a>            <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-36" name="True-36" href="#True-36"></a>                <span style="color: #2fbccd">print</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">&quot;File does not exist.&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-37" name="True-37" href="#True-37"></a>
<a id="True-38" name="True-38" href="#True-38"></a>                <span style="color: #d0d0d0">url</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">f&quot;https://s3.amazonaws.com/elevation-tiles-prod/skadi/{</span><span style="color: #d0d0d0">lat_str</span><span style="color: #ed9d13">}/{</span><span style="color: #d0d0d0">output_name</span><span style="color: #ed9d13">}&quot;</span><span style="color: #d0d0d0">+</span><span style="color: #ed9d13">&quot;.hgt.gz&quot;</span>
<a id="True-39" name="True-39" href="#True-39"></a>                
<a id="True-40" name="True-40" href="#True-40"></a>                <span style="color: #d0d0d0">urllib.request.urlretrieve(url,</span> <span style="color: #d0d0d0">hgt_gz_file)</span>
<a id="True-41" name="True-41" href="#True-41"></a>
<a id="True-42" name="True-42" href="#True-42"></a>                <span style="color: #6ebf26; font-weight: bold">with</span> <span style="color: #d0d0d0">gzip.open(hgt_gz_file,</span> <span style="color: #ed9d13">&#39;rb&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ebf26; font-weight: bold">as</span> <span style="color: #d0d0d0">f_in:</span>
<a id="True-43" name="True-43" href="#True-43"></a>                    <span style="color: #6ebf26; font-weight: bold">with</span> <span style="color: #2fbccd">open</span><span style="color: #d0d0d0">(hgt_file,</span> <span style="color: #ed9d13">&#39;wb&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ebf26; font-weight: bold">as</span> <span style="color: #d0d0d0">f_out:</span>
<a id="True-44" name="True-44" href="#True-44"></a>                        <span style="color: #d0d0d0">f_out.write(f_in.read())</span>
<a id="True-45" name="True-45" href="#True-45"></a>                <span style="color: #d0d0d0">os.remove(hgt_gz_file)</span>
<a id="True-46" name="True-46" href="#True-46"></a>            
<a id="True-47" name="True-47" href="#True-47"></a>            <span style="color: #6ebf26; font-weight: bold">with</span> <span style="color: #2fbccd">open</span><span style="color: #d0d0d0">(hgt_file,</span> <span style="color: #ed9d13">&#39;rb&#39;</span><span style="color: #d0d0d0">)</span> <span style="color: #6ebf26; font-weight: bold">as</span> <span style="color: #d0d0d0">f:</span>
<a id="True-48" name="True-48" href="#True-48"></a>                <span style="color: #d0d0d0">data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.frombuffer(f.read(),</span> <span style="color: #d0d0d0">np.dtype(</span><span style="color: #ed9d13">&#39;&gt;i2&#39;</span><span style="color: #d0d0d0">)).reshape((</span><span style="color: #51b2fd">3601</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">3601</span><span style="color: #d0d0d0">))</span>
<a id="True-49" name="True-49" href="#True-49"></a>                <span style="color: #d0d0d0">data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.flip(data,</span> <span style="color: #d0d0d0">axis=</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">)</span>
<a id="True-50" name="True-50" href="#True-50"></a>
<a id="True-51" name="True-51" href="#True-51"></a>            <span style="color: #d0d0d0">merged_map[i*</span><span style="color: #51b2fd">3601</span><span style="color: #d0d0d0">:(i+</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)*</span><span style="color: #51b2fd">3601</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">j*</span><span style="color: #51b2fd">3601</span><span style="color: #d0d0d0">:(j+</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)*</span><span style="color: #51b2fd">3601</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">data</span>
<a id="True-52" name="True-52" href="#True-52"></a>
<a id="True-53" name="True-53" href="#True-53"></a>    <span style="color: #d0d0d0">srtm_latitude</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.linspace(np.floor(lat_min),</span> <span style="color: #d0d0d0">np.ceil(lat_max),</span> <span style="color: #d0d0d0">merged_map.shape[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])</span>
<a id="True-54" name="True-54" href="#True-54"></a>    <span style="color: #d0d0d0">srtm_longitude</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.linspace(np.floor(long_min),</span> <span style="color: #d0d0d0">np.ceil(long_max),</span> <span style="color: #d0d0d0">merged_map.shape[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">])</span>
<a id="True-55" name="True-55" href="#True-55"></a>
<a id="True-56" name="True-56" href="#True-56"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">srtm_longitude,</span> <span style="color: #d0d0d0">srtm_latitude,</span> <span style="color: #d0d0d0">merged_map</span>
</pre></div>
</div></div>
</div>
<section id="test-of-function">
<h3>Test of function<a class="headerlink" href="#test-of-function" title="Permalink to this heading">#</a></h3>
<p>A simple test is performed to test the script.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">9.6</span><span class="p">,</span> <span class="mf">9.7</span><span class="p">,</span> <span class="mf">56.05</span><span class="p">,</span> <span class="mf">56.2</span><span class="p">])</span>
<span class="n">srtm_longitude</span><span class="p">,</span> <span class="n">srtm_latitude</span><span class="p">,</span> <span class="n">merged_map</span> <span class="o">=</span> <span class="n">download_elevation</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">)</span>

<span class="n">vmin</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">merged_map</span><span class="p">))</span> <span class="c1"># round down to two significant digits</span>
<span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">srtm_longitude</span><span class="p">,</span> <span class="n">srtm_latitude</span><span class="p">,</span> <span class="n">merged_map</span><span class="p">,</span> 
                 <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
                 <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Elevation (meters)&#39;</span><span class="p">)</span>

<span class="c1"># Add the rectangle to the plot</span>
<span class="n">rect</span> <span class="o">=</span> <span class="n">Rectangle</span><span class="p">(</span>
    <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">map_boundaries</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>  <span class="c1"># bottom-left corner</span>
    <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">map_boundaries</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>  <span class="c1"># width</span>
    <span class="n">height</span><span class="o">=</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">map_boundaries</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>  <span class="c1"># height</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
    <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
<span class="n">rect</span><span class="o">.</span><span class="n">set_zorder</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Elevation Map&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/bb97a365b5f93067e2b1ae61214aaf7406ad44479631ddd6674072b28ac88c76.png" src="../_images/bb97a365b5f93067e2b1ae61214aaf7406ad44479631ddd6674072b28ac88c76.png" />
</div>
</div>
<p>The depicted plot showcases the complete data range for a singular SRTM file. The small black square displays the subdomain of the map, as defined by the <code class="docutils literal notranslate"><span class="pre">map_boundaries</span></code>. Given the substantial file size of a single SRTM30 dataset, approximately (<span class="math notranslate nohighlight">\(3601 \cdot 3601 \approx 1.3\cdot10^7\)</span>), and considering that the boundaries frequently exceed those of a typical wind park, there is a need to scale down the dataset and confine the boundaries to the pertinent area. This task is achieved through the utilization of the following function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">ElevationHandler</span><span class="o">.</span><span class="n">generate_scaled_subarray</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a>    <span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">generate_scaled_subarray</span><span style="color: #d0d0d0">(</span><span style="color: #2fbccd">self</span><span style="color: #d0d0d0">):</span>
<a id="True-2" name="True-2" href="#True-2"></a>        <span style="color: #d0d0d0">x_old</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.linspace(</span><span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.full_map_boundaries[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">],</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.full_map_boundaries[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">],</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.full_map.shape[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">])</span>
<a id="True-3" name="True-3" href="#True-3"></a>        <span style="color: #d0d0d0">y_old</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.linspace(</span><span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.full_map_boundaries[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">],</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.full_map_boundaries[</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">],</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.full_map.shape[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])</span>
<a id="True-4" name="True-4" href="#True-4"></a>
<a id="True-5" name="True-5" href="#True-5"></a>        <span style="color: #d0d0d0">interp_spline</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">RectBivariateSpline(y_old,</span> <span style="color: #d0d0d0">x_old,</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.full_map)</span>
<a id="True-6" name="True-6" href="#True-6"></a>            
<a id="True-7" name="True-7" href="#True-7"></a>        <span style="color: #d0d0d0">x_new</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.linspace(</span><span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.map_boundaries[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">],</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.map_boundaries[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">],</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.map_shape[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">])</span>
<a id="True-8" name="True-8" href="#True-8"></a>        <span style="color: #d0d0d0">y_new</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.linspace(</span><span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.map_boundaries[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">],</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.map_boundaries[</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">],</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.map_shape[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])</span>
<a id="True-9" name="True-9" href="#True-9"></a>
<a id="True-10" name="True-10" href="#True-10"></a>        <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.scaled_subarray</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">interp_spline(y_new,</span> <span style="color: #d0d0d0">x_new)</span>
<a id="True-11" name="True-11" href="#True-11"></a>        <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #2fbccd">self</span><span style="color: #d0d0d0">.scaled_subarray</span>
</pre></div>
</div></div>
</div>
<p>The function uses bivariate spline interpolation to recalculate the elevation for the scaled elevation grid. The results of the function are plotted below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">]</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span>

<span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">map_array</span><span class="p">)))</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">map_array</span><span class="p">)))</span> <span class="c1"># round down to two significant digits</span>
<span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">map_array</span><span class="p">,</span> 
                <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Elevation (meters)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Elevation Map&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6ee5dbadb271b9ff1c4dfd3f14da32219e8347c641ded119d0b420405c34bd8c.png" src="../_images/6ee5dbadb271b9ff1c4dfd3f14da32219e8347c641ded119d0b420405c34bd8c.png" />
</div>
</div>
</section>
</section>
<section id="coordinate-reference-systems">
<h2>Coordinate Reference Systems<a class="headerlink" href="#coordinate-reference-systems" title="Permalink to this heading">#</a></h2>
<p>For effective utilization of elevation data in computations for shadow and noise solvers, it is advantageous to transform the Coordinate Reference System (CRS) from EPSG:4326 to EPSG:3035. The advantage of EPSG:3035 lies in the fact that each integer step in the longitude or latitude direction approximately corresponds to a meter (note that EPSG:3035 is specifically accurate for Europe).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">transform_coordinates</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">transform_coordinates</span><span style="color: #d0d0d0">(long_list,</span> <span style="color: #d0d0d0">lat_list,</span> <span style="color: #d0d0d0">input_crs_str</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;EPSG:4326&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">output_crs_str</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;EPSG:3035&quot;</span><span style="color: #d0d0d0">):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">input_crs</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">pyproj.CRS(input_crs_str)</span>  <span style="color: #ababab; font-style: italic"># WGS84</span>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">output_crs</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">pyproj.CRS(output_crs_str)</span>
<a id="True-5" name="True-5" href="#True-5"></a>
<a id="True-6" name="True-6" href="#True-6"></a>    <span style="color: #d0d0d0">transformer</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">pyproj.Transformer.from_crs(input_crs,</span> <span style="color: #d0d0d0">output_crs,</span> <span style="color: #d0d0d0">always_xy=</span><span style="color: #6ebf26; font-weight: bold">True</span><span style="color: #d0d0d0">)</span>
<a id="True-7" name="True-7" href="#True-7"></a>
<a id="True-8" name="True-8" href="#True-8"></a>    <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #2fbccd">hasattr</span><span style="color: #d0d0d0">(long_list,</span> <span style="color: #ed9d13">&quot;__len__&quot;</span><span style="color: #d0d0d0">):</span>
<a id="True-9" name="True-9" href="#True-9"></a>        <span style="color: #d0d0d0">trans_cords</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.empty((</span><span style="color: #2fbccd">len</span><span style="color: #d0d0d0">(lat_list),</span> <span style="color: #2fbccd">len</span><span style="color: #d0d0d0">(long_list),</span> <span style="color: #51b2fd">2</span><span style="color: #d0d0d0">))</span>
<a id="True-10" name="True-10" href="#True-10"></a>    <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-11" name="True-11" href="#True-11"></a>        <span style="color: #d0d0d0">trans_cords</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.empty((</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">2</span><span style="color: #d0d0d0">))</span>
<a id="True-12" name="True-12" href="#True-12"></a>        <span style="color: #d0d0d0">long_list</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[long_list]</span>
<a id="True-13" name="True-13" href="#True-13"></a>        <span style="color: #d0d0d0">lat_list</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[lat_list]</span>
<a id="True-14" name="True-14" href="#True-14"></a>
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">i,</span> <span style="color: #d0d0d0">lon</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #2fbccd">enumerate</span><span style="color: #d0d0d0">(long_list):</span>
<a id="True-16" name="True-16" href="#True-16"></a>        <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">j,</span> <span style="color: #d0d0d0">lat</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #2fbccd">enumerate</span><span style="color: #d0d0d0">(lat_list):</span>
<a id="True-17" name="True-17" href="#True-17"></a>            <span style="color: #d0d0d0">x,</span> <span style="color: #d0d0d0">y</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">transformer.transform(lon,</span> <span style="color: #d0d0d0">lat)</span>
<a id="True-18" name="True-18" href="#True-18"></a>            <span style="color: #d0d0d0">trans_cords[j,</span> <span style="color: #d0d0d0">i,</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">x</span>
<a id="True-19" name="True-19" href="#True-19"></a>            <span style="color: #d0d0d0">trans_cords[j,</span> <span style="color: #d0d0d0">i,</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">y</span>
<a id="True-20" name="True-20" href="#True-20"></a>
<a id="True-21" name="True-21" href="#True-21"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">trans_cords</span>
</pre></div>
</div></div>
</div>
<p>The map with transformed coordinates can be found below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">trans_cords</span> <span class="o">=</span> <span class="n">transform_coordinates</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span>  <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">input_crs_str</span> <span class="o">=</span> <span class="s2">&quot;EPSG:4326&quot;</span><span class="p">,</span> <span class="n">output_crs_str</span> <span class="o">=</span> <span class="s2">&quot;EPSG:3035&quot;</span><span class="p">)</span>

<span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">map_array</span><span class="p">)))</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">map_array</span><span class="p">)))</span> <span class="c1"># round down to two significant digits</span>
<span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">ct</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">trans_cords</span><span class="p">[:,:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">trans_cords</span><span class="p">[:,:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">map_array</span><span class="p">,</span> 
                <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Elevation (meters)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Elevation Map&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/435e59c0cc7cbfa3794643842e3ab584e2300d59435a6b4684164333e12a424f.png" src="../_images/435e59c0cc7cbfa3794643842e3ab584e2300d59435a6b4684164333e12a424f.png" />
</div>
</div>
<section id="rotation-of-map">
<h3>Rotation of map<a class="headerlink" href="#rotation-of-map" title="Permalink to this heading">#</a></h3>
<p>Given that the transformation to different Coordinate Reference Systems (CRS) introduces a slight rotation to the map, particularly noticeable on a larger length scale and at higher latitudes, the subsequent function is designed to produce a subarray of the original array with straight axes through cubic interpolation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">resample_to_straight_axis</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">resample_to_straight_axis</span><span style="color: #d0d0d0">(trans_cords,</span> <span style="color: #d0d0d0">map_array,</span> <span style="color: #d0d0d0">shape):</span>
<a id="True-2" name="True-2" href="#True-2"></a>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">x_min</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.max(trans_cords[:,</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])</span>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">x_max</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.min(trans_cords[:,-</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">,</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])</span>
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #d0d0d0">y_min</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.max(trans_cords[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,:,</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">])</span>
<a id="True-6" name="True-6" href="#True-6"></a>    <span style="color: #d0d0d0">y_max</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.min(trans_cords[-</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">,:,</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">])</span>
<a id="True-7" name="True-7" href="#True-7"></a>
<a id="True-8" name="True-8" href="#True-8"></a>    <span style="color: #d0d0d0">X,</span> <span style="color: #d0d0d0">Y</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.meshgrid(np.linspace(x_min,</span> <span style="color: #d0d0d0">x_max,</span> <span style="color: #d0d0d0">shape[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]),</span> <span style="color: #d0d0d0">np.linspace(y_min,</span> <span style="color: #d0d0d0">y_max,</span> <span style="color: #d0d0d0">shape[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]))</span>
<a id="True-9" name="True-9" href="#True-9"></a>    <span style="color: #d0d0d0">Z</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">griddata((trans_cords[:,:,</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">].flatten(),</span> <span style="color: #d0d0d0">trans_cords[:,:,</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">].flatten()),</span> <span style="color: #d0d0d0">map_array.flatten(),</span> <span style="color: #d0d0d0">(X,</span> <span style="color: #d0d0d0">Y),</span> <span style="color: #d0d0d0">method=</span><span style="color: #ed9d13">&#39;cubic&#39;</span><span style="color: #d0d0d0">)</span>
<a id="True-10" name="True-10" href="#True-10"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">X,</span> <span style="color: #d0d0d0">Y,</span> <span style="color: #d0d0d0">Z</span>
</pre></div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="o">=</span> <span class="n">resample_to_straight_axis</span><span class="p">(</span><span class="n">trans_cords</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">map_array</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Z</span><span class="p">)))</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Z</span><span class="p">)))</span> <span class="c1"># round down to two significant digits</span>
<span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">ct</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> 
                <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Elevation (meters)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Elevation Map&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/eaa9550d1a1869f2e75cb765cabefce67929366de3c8f8ee5cb9f2ffadcd78ad.png" src="../_images/eaa9550d1a1869f2e75cb765cabefce67929366de3c8f8ee5cb9f2ffadcd78ad.png" />
</div>
</div>
</section>
</section>
<section id="google-maps-layer">
<h2>Google Maps Layer<a class="headerlink" href="#google-maps-layer" title="Permalink to this heading">#</a></h2>
<p>To enhance result visualization, incorporating satellite imagery underneath the outcomes can provide a valuable reference for the affected areas of shadow flickering and noise disturbance. Google Maps images can be seamlessly integrated, as illustrated below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">epsg</span><span class="p">(</span><span class="mi">3035</span><span class="p">)},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Z</span><span class="p">)))</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Z</span><span class="p">)))</span> <span class="c1"># round down to two significant digits</span>
<span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="n">ct</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> 
                <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;terrain&#39;</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Elevation (meters)&#39;</span><span class="p">)</span>

<span class="c1"># ax.set_extent(map_boundaries)</span>
<span class="n">imagery</span> <span class="o">=</span> <span class="n">GoogleTiles</span><span class="p">(</span><span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;satellite&quot;</span><span class="p">)</span> <span class="c1"># Valid styles: street, satellite, terrain, only_streets</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">imagery</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="c1"># 16</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">epsg</span><span class="p">(</span><span class="mi">3035</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">epsg</span><span class="p">(</span><span class="mi">3035</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>

<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Elevation Map&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/872da32aff8452738553b2371515dc5761e58e3e65b86a1443bb7af76c3190f9.png" src="../_images/872da32aff8452738553b2371515dc5761e58e3e65b86a1443bb7af76c3190f9.png" />
</div>
</div>
</section>
<section id="convert-elevation-to-voxel-map">
<h2>Convert Elevation to Voxel Map<a class="headerlink" href="#convert-elevation-to-voxel-map" title="Permalink to this heading">#</a></h2>
<p>For the computation of shadow flickering, a ray tracing algorithm is employed to determine the trajectory of sun rays. This algorithm is made for a voxel environment. The terrain undergoes conversion into a voxel map through an iterative process that spans each elevation level—from the lowest to the highest in the map. For each iteration, a boolean slice is generated, where a True boolean signifies elevations below the current iteration, effectively indicating the terrain. Each slice is thereafter stacked on eachother to form the 3D voxel map. The script for the voxel map generator is presented below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">generate_voxel_map</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">generate_voxel_map</span><span style="color: #d0d0d0">(map_boundaries,</span> <span style="color: #d0d0d0">shape):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #d0d0d0">srtm_longitude,</span> <span style="color: #d0d0d0">srtm_latitude,</span> <span style="color: #d0d0d0">map_array</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">download_elevation(map_boundaries)</span>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">map_array,</span> <span style="color: #d0d0d0">sublong_points,</span> <span style="color: #d0d0d0">sublat_points,</span> <span style="color: #d0d0d0">map_boundaries</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">generate_subarray(map_array,</span> <span style="color: #d0d0d0">srtm_longitude,</span> <span style="color: #d0d0d0">srtm_latitude,</span> <span style="color: #d0d0d0">map_boundaries)</span>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">map_array,</span> <span style="color: #d0d0d0">sublong_points,</span> <span style="color: #d0d0d0">sublat_points</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">scale_array_func(map_array,</span> <span style="color: #d0d0d0">sublong_points,</span> <span style="color: #d0d0d0">sublat_points,</span> <span style="color: #d0d0d0">new_shape</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">shape)</span>
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #d0d0d0">trans_cords</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">transform_coordinates(sublong_points,</span> <span style="color: #d0d0d0">sublat_points,</span> <span style="color: #d0d0d0">input_crs_str</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;EPSG:4326&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">output_crs_str</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;EPSG:3035&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-6" name="True-6" href="#True-6"></a>    <span style="color: #d0d0d0">X,</span> <span style="color: #d0d0d0">Y,</span> <span style="color: #d0d0d0">map_array</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">resample_to_straight_axis(trans_cords,</span> <span style="color: #d0d0d0">map_array,</span> <span style="color: #d0d0d0">shape)</span>
<a id="True-7" name="True-7" href="#True-7"></a>    
<a id="True-8" name="True-8" href="#True-8"></a>    <span style="color: #d0d0d0">map_array_min</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.floor(np.min(map_array)).astype(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">)</span>
<a id="True-9" name="True-9" href="#True-9"></a>    <span style="color: #d0d0d0">map_array_max</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.ceil(np.max(map_array)).astype(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">)</span>
<a id="True-10" name="True-10" href="#True-10"></a>
<a id="True-11" name="True-11" href="#True-11"></a>    <span style="color: #d0d0d0">elevation_range</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.arange(map_array_min,</span> <span style="color: #d0d0d0">map_array_max,</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)</span>
<a id="True-12" name="True-12" href="#True-12"></a>    <span style="color: #d0d0d0">voxel_map</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.zeros((map_array.shape[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">map_array.shape[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">],</span> <span style="color: #2fbccd">len</span><span style="color: #d0d0d0">(elevation_range)),</span> <span style="color: #d0d0d0">dtype=np.uint8)</span>
<a id="True-13" name="True-13" href="#True-13"></a>    <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">i,</span> <span style="color: #d0d0d0">elev</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #2fbccd">enumerate</span><span style="color: #d0d0d0">(elevation_range):</span>
<a id="True-14" name="True-14" href="#True-14"></a>        <span style="color: #d0d0d0">voxel_map[:,</span> <span style="color: #d0d0d0">:,</span> <span style="color: #d0d0d0">i][map_array</span> <span style="color: #d0d0d0">&gt;</span> <span style="color: #d0d0d0">elev]</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">1</span>
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">X,</span> <span style="color: #d0d0d0">Y,</span> <span style="color: #d0d0d0">voxel_map,</span> <span style="color: #d0d0d0">map_array</span>
</pre></div>
</div></div>
</div>
<section id="id2">
<h3>Test of function<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h3>
<p>The code is executed by specifying the map boundararies and pixel shape of the map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">9.65</span><span class="p">,</span> <span class="mf">9.75</span><span class="p">,</span> <span class="mf">56.05</span><span class="p">,</span> <span class="mf">56.15</span><span class="p">])</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">voxel_map</span><span class="p">,</span> <span class="n">map_array</span> <span class="o">=</span> <span class="n">generate_voxel_map</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="s2">&quot;brown&quot;</span><span class="p">]</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span>
<span class="n">sm</span> <span class="o">=</span> <span class="n">ScalarMappable</span><span class="p">(</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">)</span>
<span class="n">sm</span><span class="o">.</span><span class="n">set_array</span><span class="p">(</span><span class="n">voxel_map</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">voxel_map</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">50</span><span class="p">],</span>        
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">sm</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;&lt;-- Below (Level) Above --&gt;&#39;</span><span class="p">,</span> <span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Voxel Map&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8551101bd75e3b84f2d43eddec54c5418d4cbf8305dc3a0f353d600437ef0a22.png" src="../_images/8551101bd75e3b84f2d43eddec54c5418d4cbf8305dc3a0f353d600437ef0a22.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-src/noise/noise_map"></span><section class="tex2jax_ignore mathjax_ignore" id="noise-map">
<h1>Noise Map<a class="headerlink" href="#noise-map" title="Permalink to this heading">#</a></h1>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">ElevationHandler</span><span class="p">,</span> <span class="n">A_weighting</span><span class="p">,</span> <span class="n">import_point_source_data</span><span class="p">,</span> <span class="n">calc_extent</span><span class="p">,</span> <span class="n">solve_noise_map</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">cartopy.io.img_tiles</span> <span class="kn">import</span> <span class="n">GoogleTiles</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="iso-9613-2-calculation-of-noise-from-wind-turbines">
<h2>ISO 9613-2: Calculation of Noise from Wind Turbines<a class="headerlink" href="#iso-9613-2-calculation-of-noise-from-wind-turbines" title="Permalink to this heading">#</a></h2>
<p>ISO 9613-2 is an international standard that provides guidelines for the calculation of outdoor sound propagation from industrial sources <span id="id1">[<a class="reference internal" href="src/introduction.html#id11" title="Technical Committee ISO/TC 43/SC 1. ISO 9613-2:1996, Acoustics — Attenuation of sound during propagation outdoors — Part 2: General method of calculation. Technical Report, International Organization for Standardization, Geneva, Switzerland, 1996. URL: https://www.iso.org/standard/20649.html (visited on 2023-08-06).">13</a>]</span>. The widely utilized engineering model outlined in the International Standard provides a simplified and structured approach for calculating sound propagation in accordance with legal requirements. While the model does not explicitly consider diverse meteorological conditions or allow for customized calculations based on wind speed, wind direction, or temperature gradients, it effectively addresses the majority of parameter variations through the predicted mean sound pressure level. Consequently, it is commonly employed to describe downwind propagation or sound transmission under well-developed moderate ground-based temperature inversions.</p>
<p>This implementation of the standard incorporates four distinct forms of attenuation: geometric spreading attenuation from the point source (<span class="math notranslate nohighlight">\(A_{div}\)</span>), atmospheric absorption attenuation (<span class="math notranslate nohighlight">\(A_{atm}\)</span>), attenuation due to ground effects (<span class="math notranslate nohighlight">\(A_{gr}\)</span>), and attenuation resulting from barriers like terrain (<span class="math notranslate nohighlight">\(A_{bar}\)</span>). These attenuations are combined such that the total attenuation is given by:</p>
<div class="math notranslate nohighlight">
\[A = A_{div} + A_{atm} + A_{gr} + A_{bar}\]</div>
<p>In this model, wind turbines are treated as point sources of noise emission, located at the hub of each turbine. The model considers the sound power level for each octave band of each point source. The noise level for each map tile is then calculated as:</p>
<div class="math notranslate nohighlight">
\[ L_{AT} = 10 \cdot \log_{10}\left(\sum_{i=1}^n\left(\sum_{j=1}^8 10^{0.1(L_{fT}(ij) + A_f(j))}\right)\right)\]</div>
<p>Here, <span class="math notranslate nohighlight">\(L_{fT}\)</span> represents the sound power level of the individual point source for each octave band:</p>
<div class="math notranslate nohighlight">
\[L_{fT} = L_W - A\]</div>
<p><span class="math notranslate nohighlight">\(A_f\)</span> denotes the A-weighting function that ensures normalization to 0 dB at a frequency of 1000 Hz, and can be calculated as such:</p>
<div class="math notranslate nohighlight">
\[
    R_a(f) = \frac{{12194^2 \cdot f^4}}{{(f^2 + 20.6^2) \cdot \sqrt{{(f^2 + 107.7^2) \cdot (f^2 + 737.9^2)}} \cdot (f^2 + 12194^2)}}
\]</div>
<div class="math notranslate nohighlight">
\[
    A(f) = 20 \cdot \log_{10}(R_{af}) + 2.00
\]</div>
<p>As seen below, the A-weighting mostly impacts the influence of the lower frequencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">Af</span> <span class="o">=</span> <span class="n">A_weighting</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">axes</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">Af</span><span class="p">,</span> <span class="s2">&quot;r--&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;A-weighting&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;f [Hz]&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Gain [dB]&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">axes</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/267d2d667f5ca059034f9d5beedfeb7dd4fd08c2ea49a0088fb87254d82231d7.png" src="../_images/267d2d667f5ca059034f9d5beedfeb7dd4fd08c2ea49a0088fb87254d82231d7.png" />
</div>
</div>
</section>
<section id="test-of-function">
<h2>Test of function<a class="headerlink" href="#test-of-function" title="Permalink to this heading">#</a></h2>
<p>Below a few instances of noise calculations for various wind parks, each with distinct input parameters.</p>
<section id="wind-park-svanninge-bjerge-fictive">
<h3>Wind Park Svanninge Bjerge (Fictive)<a class="headerlink" href="#wind-park-svanninge-bjerge-fictive" title="Permalink to this heading">#</a></h3>
<p>Fictive wind farm situated in the hills of Svanninge Bjerge in Faaborg, Denmark. Unrealistically low turbines were employed for the simulation to highlight the effects of barrier attenuation in the model. A ground factor of 0.5 was applied.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">55.124232837087455</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">10.270998350214546</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;octave_band&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;63&quot;</span><span class="p">:</span> <span class="mf">90.0</span><span class="p">,</span>
            <span class="s2">&quot;125&quot;</span><span class="p">:</span> <span class="mf">95.0</span><span class="p">,</span>
            <span class="s2">&quot;250&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
            <span class="s2">&quot;500&quot;</span><span class="p">:</span> <span class="mf">102.5</span><span class="p">,</span>
            <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="mf">104.0</span><span class="p">,</span>
            <span class="s2">&quot;2000&quot;</span><span class="p">:</span> <span class="mf">98.5</span><span class="p">,</span>
            <span class="s2">&quot;4000&quot;</span><span class="p">:</span> <span class="mf">93.0</span><span class="p">,</span>
            <span class="s2">&quot;8000&quot;</span><span class="p">:</span> <span class="mf">89.5</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">55.12513732938618</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">10.264118289154899</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>
        <span class="s2">&quot;octave_band&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;63&quot;</span><span class="p">:</span> <span class="mf">88.0</span><span class="p">,</span>
            <span class="s2">&quot;125&quot;</span><span class="p">:</span> <span class="mf">92.5</span><span class="p">,</span>
            <span class="s2">&quot;250&quot;</span><span class="p">:</span> <span class="mf">98.0</span><span class="p">,</span>
            <span class="s2">&quot;500&quot;</span><span class="p">:</span> <span class="mf">101.0</span><span class="p">,</span>
            <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="mf">105.5</span><span class="p">,</span>
            <span class="s2">&quot;2000&quot;</span><span class="p">:</span> <span class="mf">97.0</span><span class="p">,</span>
            <span class="s2">&quot;4000&quot;</span><span class="p">:</span> <span class="mf">91.5</span><span class="p">,</span>
            <span class="s2">&quot;8000&quot;</span><span class="p">:</span> <span class="mf">88.0</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">55.12851309352396</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">10.268908586941558</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">25</span><span class="p">,</span>
        <span class="s2">&quot;octave_band&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;63&quot;</span><span class="p">:</span> <span class="mf">85.0</span><span class="p">,</span>
            <span class="s2">&quot;125&quot;</span><span class="p">:</span> <span class="mf">90.0</span><span class="p">,</span>
            <span class="s2">&quot;250&quot;</span><span class="p">:</span> <span class="mf">95.5</span><span class="p">,</span>
            <span class="s2">&quot;500&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
            <span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="mf">102.0</span><span class="p">,</span>
            <span class="s2">&quot;2000&quot;</span><span class="p">:</span> <span class="mf">96.5</span><span class="p">,</span>
            <span class="s2">&quot;4000&quot;</span><span class="p">:</span> <span class="mf">92.0</span><span class="p">,</span>
            <span class="s2">&quot;8000&quot;</span><span class="p">:</span> <span class="mf">89.0</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">])</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">dist</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">calc_extent</span><span class="p">(</span><span class="n">point_source_data</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span>
<span class="n">LDW</span> <span class="o">=</span> <span class="n">solve_noise_map</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">ground_factor</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vmin</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LDW</span><span class="p">))</span> <span class="c1"># round down to two significant digits</span>
<span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">imagery</span> <span class="o">=</span> <span class="n">GoogleTiles</span><span class="p">(</span><span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;satellite&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">imagery</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">)</span>
<span class="n">cp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">,</span> 
                <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Noise Level [dB(A)]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">imagery</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="c1"># 16</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Svanninge Bjerge Wind Park&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3250d138e1a139d6302cb07279bca4bec22565fced76e90a716d0e13d03cf457.png" src="../_images/3250d138e1a139d6302cb07279bca4bec22565fced76e90a716d0e13d03cf457.png" />
</div>
</div>
</section>
<section id="wind-park-provestenen">
<h3>Wind Park Prøvestenen<a class="headerlink" href="#wind-park-provestenen" title="Permalink to this heading">#</a></h3>
<p>Prøvestenen Wind Park is a wind facility situated in Copenhagen, Denmark, featuring 3 turbines with a total capacity of 6.0 MW. The specific turbine models and hub heights are Vestas V80-2.0 MW VCS Mark 7. The wind park was established in 2013. In compliance with the Vindmøllebekendtgørelsen noise regulations <span id="id2">[<a class="reference internal" href="src/introduction.html#id14" title="Indenrigs og Boligministeriet. Bekendtgørelse om støj fra vindmøller. Indenrigs og Boligmin. Bolig og planstyrelsen j.nr, 2019. URL: https://www.retsinformation.dk/eli/lta/2019/135 (visited on 2023-08-06).">9</a>]</span>, the Jupyter Notebook simulations uses a temperature of 10°C, a relative humidity of 80%, and a receiver height of 1.5 meters. The computations for Prøvestenen Wind Park were done with a ground factor of <span class="math notranslate nohighlight">\(G = 0.0\)</span> to closely align with the calculation methods prescribed in the Vindmøllebekendtgørelsen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dist</span> <span class="o">=</span> <span class="mi">1500</span>
<span class="n">point_source_data</span> <span class="o">=</span> <span class="n">import_point_source_data</span><span class="p">(</span><span class="s2">&quot;Prøvestenen_noise.json&quot;</span><span class="p">)</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">calc_extent</span><span class="p">(</span><span class="n">point_source_data</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">calc_extent</span><span class="p">(</span><span class="n">point_source_data</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span>
<span class="n">LDW</span> <span class="o">=</span> <span class="n">solve_noise_map</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">ground_factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">rh</span> <span class="o">=</span> <span class="mi">80</span><span class="p">,</span> <span class="n">receiver_height</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vmin</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LDW</span><span class="p">))</span> 
<span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">imagery</span> <span class="o">=</span> <span class="n">GoogleTiles</span><span class="p">(</span><span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;satellite&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">imagery</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">)</span>
<span class="n">cp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">,</span> 
                <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Noise Level [dB(A)]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">imagery</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="c1"># 16</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Prøvestenen Wind Park&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5b0e72d133645c6906f4f81ddde46061c15a5362227e644ac2017b153c36de31.png" src="../_images/5b0e72d133645c6906f4f81ddde46061c15a5362227e644ac2017b153c36de31.png" />
</div>
</div>
<section id="comparison-with-provestenen-eia">
<h4>Comparison with Prøvestenen EIA<a class="headerlink" href="#comparison-with-provestenen-eia" title="Permalink to this heading">#</a></h4>
<p>The environmental impact assessment conducted for Prøvestenen utilized WindPRO version 2.7.999 Beta for the calculations, employing the methodologies outlined in the Vindmøllebekendtgørelsen noise regulations <span id="id3">[<a class="reference internal" href="src/introduction.html#id14" title="Indenrigs og Boligministeriet. Bekendtgørelse om støj fra vindmøller. Indenrigs og Boligmin. Bolig og planstyrelsen j.nr, 2019. URL: https://www.retsinformation.dk/eli/lta/2019/135 (visited on 2023-08-06).">9</a>]</span>.</p>
<a class="bg-primary reference internal image-reference" href="../_images/prøvestenen.jpg"><img alt="prøvestenen" class="bg-primary" src="../_images/prøvestenen.jpg" style="width: 800px;" /></a>
<p><em>Fig 1: Calculated noise propagation for the turbines at a wind speed of 8 m/s (Source: <span id="id4">[<a class="reference internal" href="src/introduction.html#id15" title="Københavns Kommune. Vindmøller på prøvestenen. 2011. URL: https://www.kk.dk/sites/default/files/agenda/90ae9f00-a1e1-469e-bbd5-018f54baa076/491190df-8954-4ca4-b787-131c4a2ed031-bilag-6.pdf (visited on 2023-08-06).">10</a>]</span>).</em></p>
</section>
</section>
<section id="wind-park-juurakko">
<h3>Wind Park Juurakko<a class="headerlink" href="#wind-park-juurakko" title="Permalink to this heading">#</a></h3>
<p>Juurakko Wind Park is a 40 MW wind facility located in Kalajoki, Finland, featuring 7 Nordex N163 5.7 MW turbines with a hub height of 148 meters, built in 2022 <span id="id5">[<a class="reference internal" href="src/introduction.html#id5" title="Etha Wind Oy. Noise study wind farm juurakko. 2014. URL: https://kalajoki.fi/wp-content/uploads/2020/11/Liite4_Juurakko_Noise_Study_CG200603-1AM.pdf (visited on 2023-11-29).">8</a>]</span>. The calculations are done using a ground factor of <span class="math notranslate nohighlight">\(G = 0.4\)</span> and using a receiver height of 4 meters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">map_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="mf">24.025</span><span class="p">,</span> <span class="mf">24.2</span><span class="p">,</span> <span class="mf">64.285</span><span class="p">,</span> <span class="mf">64.37</span><span class="p">]</span> 
<span class="n">point_source_data</span> <span class="o">=</span> <span class="n">import_point_source_data</span><span class="p">(</span><span class="s2">&quot;Juurakko.json&quot;</span><span class="p">)</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span>
<span class="n">LDW</span> <span class="o">=</span> <span class="n">solve_noise_map</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">ground_factor</span> <span class="o">=</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="n">rh</span> <span class="o">=</span> <span class="mi">70</span><span class="p">,</span> <span class="n">receiver_height</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vmin</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">vmax</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2g</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LDW</span><span class="p">))</span> <span class="c1"># round down to two significant digits</span>
<span class="n">levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">imagery</span> <span class="o">=</span> <span class="n">GoogleTiles</span><span class="p">(</span><span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;satellite&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">imagery</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">)</span>
<span class="n">cp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">,</span> 
                <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">,</span> <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">extend</span> <span class="o">=</span> <span class="s2">&quot;both&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Noise Level [dB(A)]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">imagery</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="c1"># 16</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">plt</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Juurakko Wind Park&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7a1789eb9d3bac4feb8605607549fa649e3347adb7ab139cca49a8663c218668.png" src="../_images/7a1789eb9d3bac4feb8605607549fa649e3347adb7ab139cca49a8663c218668.png" />
</div>
</div>
<section id="comparison-with-juurakko-eia">
<h4>Comparison with Juurakko EIA<a class="headerlink" href="#comparison-with-juurakko-eia" title="Permalink to this heading">#</a></h4>
<p>As an integral step in the wind farm planning process, an environmental impact assessment was conducted. This assessment utilized ISO 9613-2 for predicting the noise levels generated by the turbines. The noise assessment conducted in the study by Juurakko utilized WindPro v3.3 <span id="id6">WindPro [<a class="reference internal" href="src/introduction.html#id6" title="WindPro. Introduction to environmental calculations. 2002. URL: https://help.emd.dk/knowledgebase/content/windPRO3.6/c6-UK_WindPRO3.6-Environment.pdf (visited on 2023-11-29).">6</a>]</span>. This software automatically applies a 2 dB penalty for each turbine when the base height level between the turbine and receptor exceeds 60 meters. This penalty is directly incorporated into the .json file, resulting in an assigned noise level of 110.7 dB for each turbine.</p>
<a class="bg-primary reference internal image-reference" href="../_images/juurakko.jpg"><img alt="juurakko" class="bg-primary" src="../_images/juurakko.jpg" style="width: 800px;" /></a>
<p><em>Fig 2: Calculated noise propagation for the turbines at 107.2 dB(A) + 1.5 dB(A) (Source: <span id="id7">[<a class="reference internal" href="src/introduction.html#id5" title="Etha Wind Oy. Noise study wind farm juurakko. 2014. URL: https://kalajoki.fi/wp-content/uploads/2020/11/Liite4_Juurakko_Noise_Study_CG200603-1AM.pdf (visited on 2023-11-29).">8</a>]</span>).</em></p>
</section>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-src/noise/geometrical_spreading_of_sound"></span><section class="tex2jax_ignore mathjax_ignore" id="geometrical-spreading-of-sound">
<h2>Geometrical spreading of sound<a class="headerlink" href="#geometrical-spreading-of-sound" title="Permalink to this heading">#</a></h2>
<p>As a point source extends from its origin, the intensity diminishes inversely proportional to the distance traveled, following the Inverse-square law. In the context of noise propagation, this phenomenon significantly influences the attenuation of turbine noise levels.</p>
<a class="bg-primary reference internal image-reference" href="../_images/inverse_square_law.png"><img alt="inverse_square_law" class="bg-primary" src="../_images/inverse_square_law.png" style="width: 600px;" /></a>
<p><em>Fig 1: S denotes the noise source, and r represents the measured points. The lines illustrate noise propagation from the sources. The total noise lines, linked to source strength, remain constant, but denser lines indicate a louder noise field. The line density is inversely proportional to distance from the source squared, reflecting increased surface area on a sphere. Consequently, noise intensity inversely scales with the square of the distance from the source (<a class="reference external" href="https://en.wikipedia.org/wiki/Inverse-square_law">Source</a>).</em></p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.animation</span> <span class="kn">import</span> <span class="n">FuncAnimation</span><span class="p">,</span> <span class="n">PillowWriter</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="derivation">
<h3>Derivation<a class="headerlink" href="#derivation" title="Permalink to this heading">#</a></h3>
<p>The intensity, <span class="math notranslate nohighlight">\(I\)</span>, measured in watts per square meter (<span class="math notranslate nohighlight">\(W/m^2\)</span>), is a fundamental quantity in acoustics. The sound power of a source, denoted as <span class="math notranslate nohighlight">\(P\)</span>, can be related to intensity through the formula:</p>
<div class="math notranslate nohighlight">
\[ I = \dfrac{P}{4 \pi r^2} = \dfrac{p^2}{\rho c} = \dfrac{p^2}{z_0} \]</div>
<p>Here, <span class="math notranslate nohighlight">\(z_0\)</span> represents the characteristic specific acoustic impedance as is equal to <span class="math notranslate nohighlight">\(z_0 = 400 \text{Pa} \cdot \text{s}/\text{m}\)</span>.</p>
<p>Rearranging the equation in terms of sound power <span class="math notranslate nohighlight">\(P\)</span>, we get:</p>
<div class="math notranslate nohighlight">
\[ P = \dfrac{p^2}{z_0}4 \pi r^2 \]</div>
<p>In the context of a reference sound power <span class="math notranslate nohighlight">\(P_0 = 10^{-12} \text{W}\)</span>, the ratio <span class="math notranslate nohighlight">\(\dfrac{P}{P_0}\)</span> can be expressed as:</p>
<div class="math notranslate nohighlight">
\[ \dfrac{P}{P_0} = \dfrac{p_0^2}{P_0} \dfrac{p^2}{p_0^2} \dfrac{1}{z_0} 4 \pi r^2\]</div>
<p>Where the reference sound pressure is <span class="math notranslate nohighlight">\(p_0 = 2\cdot 10^{-5} \text{Pa}\)</span>. Taking the logarithm of both sides, we arrive at:</p>
<div class="math notranslate nohighlight">
\[ 10\log\left(\dfrac{P}{P_0}\right) = 10\log\left(\dfrac{p_0^2}{P_0} \dfrac{p^2}{p_0^2} \dfrac{1}{z_0} 4 \pi r^2\right) \]</div>
<p>This expression can be further simplified to represent the sound power level as <span class="math notranslate nohighlight">\(L_W = 10\log\left(\dfrac{P}{P_0}\right)\)</span> and the sound pressure level as <span class="math notranslate nohighlight">\(L_P = 10\log\left(\dfrac{p^2}{p_0^2}\right)\)</span>:</p>
<div class="math notranslate nohighlight">
\[ L_W = L_P + 10\log\left(\dfrac{p_0^2}{P_0 z_0}4 \pi r^2\right) \]</div>
<p>With the used reference values <span class="math notranslate nohighlight">\(\dfrac{p_0^2}{P_0 z_0} = 1\)</span>, and the equation simplifies to:</p>
<div class="math notranslate nohighlight">
\[ L_W = L_P + 20\log(r) + 10\log(4 \pi) \]</div>
<p>Lastly, be rearranging the equation, the final expression for the sound pressure level can be found:</p>
<div class="math notranslate nohighlight">
\[ L_P = L_W - 20\log(r) - 10\log(4 \pi) \approx  L_W - 20\log(r) - 11 \]</div>
<p>This derivation provides insights into the relationship between sound power, intensity, and their representation in logarithmic scales.</p>
<section id="application-of-function">
<h4>Application of function<a class="headerlink" href="#application-of-function" title="Permalink to this heading">#</a></h4>
<p>Utilizing the formula on a fluctuating noise signal, oscillating between 0 dB and 100 dB, reveals the impact of geometrical spreading on the noise amplitude. It’s worth mentioning that this effect is not exclusive to oscillating values; I chose to create the plot simply because of its visually interesting representation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">width</span> <span class="o">=</span> <span class="mi">3000</span>  <span class="c1"># Width of the simulation grid</span>
<span class="n">height</span> <span class="o">=</span> <span class="n">width</span>  <span class="c1"># Height of the simulation grid</span>
<span class="n">center_x</span> <span class="o">=</span><span class="mi">0</span> <span class="c1"># # X-coordinate of the point source</span>
<span class="n">center_y</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1">#  # Y-coordinate of the point source</span>
<span class="n">frequency</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># frequency</span>
<span class="n">amplitude</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># Amplitude of the oscillation</span>
<span class="n">speed</span> <span class="o">=</span> <span class="mi">300</span>  <span class="c1"># Speed of wave propagation</span>
<span class="n">duration</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># Duration of the simulation</span>
<span class="n">fps</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># Frames per second</span>
<span class="n">res</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">/</span> <span class="n">frequency</span>
<span class="n">angular_frequency</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">frequency</span>
<span class="n">wave_number</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">wavelength</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">res</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">height</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">time</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">/</span> <span class="n">fps</span>
<span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">center_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">amplitude</span> <span class="o">-</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">-</span> <span class="mi">11</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angular_frequency</span> <span class="o">*</span> <span class="n">time</span> <span class="o">-</span> <span class="n">wave_number</span> <span class="o">*</span> <span class="n">distance</span><span class="p">))</span>
<span class="n">cb</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="o">-</span><span class="n">height</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">amplitude</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;SPL [dB]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span> <span class="s2">&quot; X [m]&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Y [m]&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">frame</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">grid</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">frame</span> <span class="o">/</span> <span class="n">fps</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">center_x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">center_y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,(</span><span class="n">amplitude</span> <span class="o">-</span> <span class="mi">20</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">distance</span><span class="p">)</span> <span class="o">-</span> <span class="mi">11</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">angular_frequency</span> <span class="o">*</span> <span class="n">time</span> <span class="o">-</span> <span class="n">wave_number</span><span class="o">*</span> <span class="n">distance</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;jet&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="o">-</span><span class="n">height</span><span class="p">,</span> <span class="n">height</span><span class="p">],</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">amplitude</span><span class="p">)</span>
<span class="n">animation</span> <span class="o">=</span> <span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">update</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">fps</span><span class="p">),</span> <span class="n">interval</span><span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">fps</span><span class="p">)</span>

<span class="n">animation</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s1">&#39;../../temp/ripple.gif&#39;</span><span class="p">,</span><span class="n">writer</span><span class="o">=</span><span class="n">PillowWriter</span><span class="p">(</span><span class="n">fps</span><span class="o">=</span><span class="n">fps</span><span class="p">))</span>
<span class="n">Image</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;../../temp/ripple.gif&#39;</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/40d0f2511eb5fd72d0fcb4d8cf0e6f597ad722d24bfc71208a2922f765065219.png" src="../_images/40d0f2511eb5fd72d0fcb4d8cf0e6f597ad722d24bfc71208a2922f765065219.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-src/noise/atmospheric_attenuation"></span><section class="tex2jax_ignore mathjax_ignore" id="atmospheric-attenuation">
<h2>Atmospheric Attenuation<a class="headerlink" href="#atmospheric-attenuation" title="Permalink to this heading">#</a></h2>
<p>Atmospheric attenuation of sound is the decrease in sound intensity as it travels through the Earth’s atmosphere. Various factors contribute to this attenuation, such as absorption and scattering. Sound absorption occurs when sound energy is converted into heat energy as it interacts with atmospheric molecules. This process is frequency-dependent, as it can be seen below, with higher frequencies experiencing greater attenuation. The calculations in this section is based on <span id="id1">Bugaru <em>et al.</em> [<a class="reference internal" href="src/introduction.html#id7" title="Mihai Bugaru, Ovidiu Vasile, and Marian Neagoe. Recent Developments of Noise Attenuation Using Acoustic Barriers for a Specific Edge Geometry. Computation, 9(12):129, Dec 2021. Number: 12. URL: https://www.mdpi.com/2079-3197/9/12/129 (visited on 2023-11-16), doi:10.3390/computation9120129.">2</a>]</span> and <span id="id2">Technical Committee ISO/TC 43/SC 1 [<a class="reference internal" href="src/introduction.html#id12" title="Technical Committee ISO/TC 43/SC 1. ISO 9613-2:1996, Acoustics — Attenuation of sound during propagation outdoors — Part 1: Calculation of the absorption of Sound by the atmosphere. Technical Report, International Organization for Standardization, Geneva, Switzerland, 1993. URL: https://www.iso.org/standard/17426.html (visited on 2023-08-06).">12</a>]</span>.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">atmospheric_absorption</span><span class="p">,</span> <span class="n">print_code</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="sound-attenuation-coefficient">
<h3>Sound attenuation coefficient<a class="headerlink" href="#sound-attenuation-coefficient" title="Permalink to this heading">#</a></h3>
<p>To calculate atmospheric attenuation, it is necessary to determine the sound attenuation coefficient, <span class="math notranslate nohighlight">\(\alpha\)</span>. This coefficient quantifies the amount of sound absorbed by the air per meter traveled from the sound source. The sound attenuation coefficient is determined by considering factors such as frequency, temperature, relative humidity, and ambient atmospheric pressure. By incorporating these variables into the calculation, the attenuation of sound in the atmosphere can be accurately estimated. The power level of the noise decreases in a linear manner with distance, and it can be calculated using the formula <span class="math notranslate nohighlight">\(A_{atm} = \alpha \cdot d\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">atmospheric_absorption</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">atmospheric_absorption</span><span style="color: #d0d0d0">(f=</span><span style="color: #51b2fd">1000</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">t=</span><span style="color: #51b2fd">10</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">rh=</span><span style="color: #51b2fd">80</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">ps=</span><span style="color: #51b2fd">1.01325e5</span><span style="color: #d0d0d0">):</span>
<a id="True-2" name="True-2" href="#True-2"></a><span style="color: #666666">    </span><span style="color: #ed9d13">&quot;&quot;&quot; </span>
<a id="True-3" name="True-3" href="#True-3"></a><span style="color: #ed9d13">    Calculate the attenuation coefficient for a given frequency, temperature, relative humidity, and atmospheric pressure.</span>
<a id="True-4" name="True-4" href="#True-4"></a><span style="color: #ed9d13">    </span>
<a id="True-5" name="True-5" href="#True-5"></a><span style="color: #ed9d13">    Input:</span>
<a id="True-6" name="True-6" href="#True-6"></a><span style="color: #ed9d13">    f: frequency in Hz</span>
<a id="True-7" name="True-7" href="#True-7"></a><span style="color: #ed9d13">    t: temperature in C</span>
<a id="True-8" name="True-8" href="#True-8"></a><span style="color: #ed9d13">    rh: relative humidity in %</span>
<a id="True-9" name="True-9" href="#True-9"></a><span style="color: #ed9d13">    ps: atmospheric pressure in Pa</span>
<a id="True-10" name="True-10" href="#True-10"></a><span style="color: #ed9d13">    </span>
<a id="True-11" name="True-11" href="#True-11"></a><span style="color: #ed9d13">    Output:</span>
<a id="True-12" name="True-12" href="#True-12"></a><span style="color: #ed9d13">    alpha: attenuation coefficient</span>
<a id="True-13" name="True-13" href="#True-13"></a><span style="color: #ed9d13">    &quot;&quot;&quot;</span>
<a id="True-14" name="True-14" href="#True-14"></a>    
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #ababab; font-style: italic"># Convert atmospheric pressure to a variable that won&#39;t be modified</span>
<a id="True-16" name="True-16" href="#True-16"></a>    <span style="color: #d0d0d0">ps0</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">1.01325e5</span>
<a id="True-17" name="True-17" href="#True-17"></a>    
<a id="True-18" name="True-18" href="#True-18"></a>    <span style="color: #ababab; font-style: italic"># Convert temperature from Celsius to Kelvin</span>
<a id="True-19" name="True-19" href="#True-19"></a>    <span style="color: #d0d0d0">T</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">t</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">273.15</span>
<a id="True-20" name="True-20" href="#True-20"></a>    <span style="color: #ababab; font-style: italic"># Reference temperature in Kelvin</span>
<a id="True-21" name="True-21" href="#True-21"></a>    <span style="color: #d0d0d0">T0</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">293.15</span>
<a id="True-22" name="True-22" href="#True-22"></a>    
<a id="True-23" name="True-23" href="#True-23"></a>    <span style="color: #ababab; font-style: italic"># Reference temperature in Kelvin for saturation vapor pressure</span>
<a id="True-24" name="True-24" href="#True-24"></a>    <span style="color: #d0d0d0">T01</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">273.16</span>
<a id="True-25" name="True-25" href="#True-25"></a>    
<a id="True-26" name="True-26" href="#True-26"></a>    <span style="color: #ababab; font-style: italic"># Calculate saturation vapor pressure constant</span>
<a id="True-27" name="True-27" href="#True-27"></a>    <span style="color: #d0d0d0">Csat</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">-</span><span style="color: #51b2fd">6.8346</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">(T01/T)**</span><span style="color: #51b2fd">1.261</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">4.6151</span>
<a id="True-28" name="True-28" href="#True-28"></a>    
<a id="True-29" name="True-29" href="#True-29"></a>    <span style="color: #ababab; font-style: italic"># Calculate saturation vapor pressure</span>
<a id="True-30" name="True-30" href="#True-30"></a>    <span style="color: #d0d0d0">rhosat</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">10</span><span style="color: #d0d0d0">**Csat</span>
<a id="True-31" name="True-31" href="#True-31"></a>    
<a id="True-32" name="True-32" href="#True-32"></a>    <span style="color: #ababab; font-style: italic"># Calculate relative humidity ratio</span>
<a id="True-33" name="True-33" href="#True-33"></a>    <span style="color: #d0d0d0">H</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">rhosat</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">rh</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">ps0</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">ps</span>
<a id="True-34" name="True-34" href="#True-34"></a>    
<a id="True-35" name="True-35" href="#True-35"></a>    <span style="color: #ababab; font-style: italic"># Calculate frequency-dependent term for attenuation due to water vapor</span>
<a id="True-36" name="True-36" href="#True-36"></a>    <span style="color: #d0d0d0">frn</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(ps</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">ps0)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">(T0/T)**</span><span style="color: #51b2fd">0.5</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">(</span><span style="color: #51b2fd">9</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">280</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">H</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.exp(-</span><span style="color: #51b2fd">4.17</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">((T0/T)**(</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">/</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">-</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)))</span>
<a id="True-37" name="True-37" href="#True-37"></a>    
<a id="True-38" name="True-38" href="#True-38"></a>    <span style="color: #ababab; font-style: italic"># Calculate frequency-dependent term for attenuation due to oxygen</span>
<a id="True-39" name="True-39" href="#True-39"></a>    <span style="color: #d0d0d0">fro</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(ps</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">ps0)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">(</span><span style="color: #51b2fd">24.0</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">4.04e4</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">H</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">(</span><span style="color: #51b2fd">0.02</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">H)</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">(</span><span style="color: #51b2fd">0.391</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">H))</span>
<a id="True-40" name="True-40" href="#True-40"></a>    
<a id="True-41" name="True-41" href="#True-41"></a>    <span style="color: #ababab; font-style: italic"># Calculate the attenuation coefficient</span>
<a id="True-42" name="True-42" href="#True-42"></a>    <span style="color: #d0d0d0">alpha</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">20</span><span style="color: #d0d0d0">/np.log(</span><span style="color: #51b2fd">10</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">f**</span><span style="color: #51b2fd">2</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">(</span><span style="color: #51b2fd">1.84e-11</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">(</span> <span style="color: #d0d0d0">(T0/T)**</span><span style="color: #51b2fd">0.5</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">ps</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">ps0</span> <span style="color: #d0d0d0">)+</span> <span style="color: #d0d0d0">(T/T0)**(-</span><span style="color: #51b2fd">2.5</span><span style="color: #d0d0d0">)*</span> <span style="color: #d0d0d0">(</span><span style="color: #51b2fd">0.10680</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.exp(-</span><span style="color: #51b2fd">3352</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">T)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">frn</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">(f**</span><span style="color: #51b2fd">2</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">frn</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">frn)+</span> <span style="color: #51b2fd">0.01278</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.exp(-</span><span style="color: #51b2fd">2239.1</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">T)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">fro</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">(f**</span><span style="color: #51b2fd">2</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">fro</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">fro)))</span>
<a id="True-43" name="True-43" href="#True-43"></a>    
<a id="True-44" name="True-44" href="#True-44"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">alpha</span>
</pre></div>
</div></div>
</div>
<section id="frequency-influence">
<h4>Frequency influence<a class="headerlink" href="#frequency-influence" title="Permalink to this heading">#</a></h4>
<p>Lets visualize the atmospheric absorption for different relative humidities and frequencies.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># temperature</span>
<span class="n">fs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> <span class="c1"># frequency range</span>
<span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fs</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># initiate alpha</span>
<span class="n">rhs</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span> <span class="c1"># relative humidity range</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="k">for</span> <span class="n">rh</span> <span class="ow">in</span> <span class="n">rhs</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
        <span class="n">alphas</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmospheric_absorption</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">rh</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">loglog</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">alphas</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;rh: </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="k">rh</span>)
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Absorption coefficient at </span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s1"> degrees&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Frequency[Hz]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Absorption coefficient [dB/m]&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;best&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/37c481e3bfaa2eaf16a7dafd54011824913afcf308181f902f7f8bdaf9cfe5a5.png" src="../_images/37c481e3bfaa2eaf16a7dafd54011824913afcf308181f902f7f8bdaf9cfe5a5.png" />
</div>
</div>
<p>As shown in the graph above, the frequency of the noise significantly influences the level of atmospheric absorption. Higher frequencies experience greater absorption, resulting in reduced sound levels. Generally, with a few exceptions, higher relative humidity contributes to lower levels of absorption.</p>
</section>
<section id="relative-humidity-influence">
<h4>Relative humidity influence<a class="headerlink" href="#relative-humidity-influence" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rh_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">f_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">63</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f_list</span><span class="p">:</span>
    <span class="n">Aatm</span> <span class="o">=</span> <span class="n">atmospheric_absorption</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">rh_list</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rh_list</span><span class="p">,</span> <span class="n">Aatm</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;f: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Relative Humidity (%)&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Absorption coefficient [dB/m]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/58790b9ebc7ea16e9dd5c011aea49505f8d41cc84112db56e8eda5c4f74b4aef.png" src="../_images/58790b9ebc7ea16e9dd5c011aea49505f8d41cc84112db56e8eda5c4f74b4aef.png" />
</div>
</div>
<p>As observed above, relative humidity also exerts a significant influence on atmospheric absorption. Particularly in the range of 10-30% relative humidity, there appears to be a notable increase in absorption.</p>
</section>
<section id="temperature-influence">
<h4>Temperature influence<a class="headerlink" href="#temperature-influence" title="Permalink to this heading">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">f_list</span> <span class="o">=</span> <span class="p">[</span><span class="mi">63</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="mi">8000</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f_list</span><span class="p">:</span>
    <span class="n">Aatm</span> <span class="o">=</span> <span class="n">atmospheric_absorption</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t_list</span><span class="p">,</span> <span class="n">rh</span><span class="o">=</span><span class="mi">70</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_list</span><span class="p">,</span> <span class="n">Aatm</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;f = </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Temperature [°C]&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s1">&#39;Absorption coefficient [dB/m]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/bddfcdf8495a2cdbe4fabc0f9bfc77b09dc32ff24dab66f4c6928d5a02a24414.png" src="../_images/bddfcdf8495a2cdbe4fabc0f9bfc77b09dc32ff24dab66f4c6928d5a02a24414.png" />
</div>
</div>
<p>As seen from the above graph, temperature has a relatively minor impact on the overall level of absorption. In general, higher absorption rates are observed at lower temperatures.</p>
</section>
</section>
</section>
<span id="document-src/noise/ground_effect"></span><section class="tex2jax_ignore mathjax_ignore" id="ground-effect">
<h2>Ground Effect<a class="headerlink" href="#ground-effect" title="Permalink to this heading">#</a></h2>
<p>The total ground attenuation is calcuated as the sum of the attenuation in the source, receiver and middle region.</p>
<div class="math notranslate nohighlight">
\[
A_{gr} = A_s + A_r + A_m
\]</div>
<p>The ground factor is determined by the type of ground in the specified region. A ground factor of <span class="math notranslate nohighlight">\(G = 0\)</span> indicates hard ground, suggesting an amplifying effect on the sound power level. When <span class="math notranslate nohighlight">\(G = 1\)</span>, the ground is considered porous, indicating noise absorption. For values of <span class="math notranslate nohighlight">\(G\)</span> between 0 and 1, the ground is deemed mixed. The precise ground factor for wind turbine noise simulations is somewhat controversial, as a higher ground factor results in lower noise emission levels in simulations. Consequently, wind parks can be built closer to residential areas. However, typical values used generally fall between <span class="math notranslate nohighlight">\(G = 0.7 \)</span><span id="id1">[<a class="reference internal" href="src/introduction.html#id4" title="Blazing Star Wind Farm, LLC. Docket no. 16-686, blazing star i, technology change attachment b, 20189-146376-01. 2018. URL: https://www.edockets.state.mn.us/edockets/searchDocuments.do?method=showPoup&amp;documentId={409ED365-0000-CD11-8777-FBD4CC5B94A3}&amp;documentTitle=20189-146376-01 (visited on 2023-11-29).">7</a>]</span> and <span class="math notranslate nohighlight">\(G = 0.4\)</span> <span id="id2">[<a class="reference internal" href="src/introduction.html#id5" title="Etha Wind Oy. Noise study wind farm juurakko. 2014. URL: https://kalajoki.fi/wp-content/uploads/2020/11/Liite4_Juurakko_Noise_Study_CG200603-1AM.pdf (visited on 2023-11-29).">8</a>]</span>.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="calculation-of-ground-attenuation">
<h3>Calculation of ground attenuation<a class="headerlink" href="#calculation-of-ground-attenuation" title="Permalink to this heading">#</a></h3>
<p>The source and receiver attenuation <span class="math notranslate nohighlight">\(A_s\)</span> and <span class="math notranslate nohighlight">\(A_r\)</span> are generally only dependent on the ground factor <span class="math notranslate nohighlight">\(G\)</span> (except for f = 63 Hz where the attenuation is just equal to -1.5). However, for the 125, 250, 500, 1000 Hz octave bands, the attenuation is also dependant on the height <span class="math notranslate nohighlight">\(h\)</span> of the source or receiver above ground. <span class="math notranslate nohighlight">\(d_p\)</span> is the source-to-receiver distance, in metres, projected onto the ground planes.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
a' = 1.5 + 3.0 \cdot e^{-0.12 \cdot \left(h - 5\right)^2} \cdot \left(1 - e^{-\frac{d_p}{50}}\right) + 5.7 \cdot e^{-0.09 \cdot h^2} \cdot \left(1 - e^{-2.8 \cdot 10^{-6} \cdot d_p^2}\right) \\
b' = 1.5 + 8.6 \cdot e^{-0.09 \cdot h^2} \cdot \left(1 - e^{-\frac{d_p}{50}}\right) \\
c' = 1.5 + 14.0 \cdot e^{-0.46 \cdot h^2} \cdot \left(1 - e^{-\frac{d_p}{50}}\right) \\
d' = 1.5 + 5.0 \cdot e^{-0.9 \cdot h^2} \cdot \left(1 - e^{-\frac{d_p}{50}}\right)
\end{split}\]</div>
<p>The full calculatation for the attenuation in the source, receiver and middle region can be found in the table below.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p><strong>Nominal midband frequency [Hz]</strong></p></th>
<th class="head"><p><strong><span class="math notranslate nohighlight">\(A_s\)</span> or <span class="math notranslate nohighlight">\(A_r\)</span> [dB]</strong></p></th>
<th class="head"><p><strong><span class="math notranslate nohighlight">\(A_m\)</span> [dB]</strong></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>63</p></td>
<td><p><span class="math notranslate nohighlight">\(-1.5\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-3q\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>125</p></td>
<td><p><span class="math notranslate nohighlight">\(-1.5 + G\cdot a'(h)\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-3q(1-G)\)</span></p></td>
</tr>
<tr class="row-even"><td><p>250</p></td>
<td><p><span class="math notranslate nohighlight">\(-1.5 + G\cdot b'(h)\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-3q(1-G)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>500</p></td>
<td><p><span class="math notranslate nohighlight">\(-1.5 + G\cdot c'(h)\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-3q(1-G)\)</span></p></td>
</tr>
<tr class="row-even"><td><p>1000</p></td>
<td><p><span class="math notranslate nohighlight">\(-1.5 + G\cdot d'(h)\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-3q(1-G)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>2000</p></td>
<td><p><span class="math notranslate nohighlight">\(-1.5(1-G)\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-3q(1-G)\)</span></p></td>
</tr>
<tr class="row-even"><td><p>4000</p></td>
<td><p><span class="math notranslate nohighlight">\(-1.5(1-G)\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-3q(1-G)\)</span></p></td>
</tr>
<tr class="row-odd"><td><p>8000</p></td>
<td><p><span class="math notranslate nohighlight">\(-1.5(1-G)\)</span></p></td>
<td><p><span class="math notranslate nohighlight">\(-3q(1-G)\)</span></p></td>
</tr>
</tbody>
</table>
<p><em>Tab 1: Formulas for computing ground attenuation contributions in the octave bands, denoted as <span class="math notranslate nohighlight">\(A_s\)</span>, <span class="math notranslate nohighlight">\(A_r\)</span>, and <span class="math notranslate nohighlight">\(A_m\)</span> (Source: <span id="id3">[<a class="reference internal" href="src/introduction.html#id11" title="Technical Committee ISO/TC 43/SC 1. ISO 9613-2:1996, Acoustics — Attenuation of sound during propagation outdoors — Part 2: General method of calculation. Technical Report, International Organization for Standardization, Geneva, Switzerland, 1996. URL: https://www.iso.org/standard/20649.html (visited on 2023-08-06).">13</a>]</span>).</em></p>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}
q = \begin{cases}
1 - \frac{30(h_s + h_r)}{d_p} &amp; \text{if } d_p &gt; 30(h_s + h_r)\\
0 &amp; \text{if } d_p \leq 30(h_s + h_r)
\end{cases}
\end{split}\]</div>
<p>As it can be seen from the table above, when the ground factor <span class="math notranslate nohighlight">\(G=0\)</span>, indicating a hard and reflecting ground, the attenuation at both the source and receiver is -1.5 dB. This implies that the sound power level measured at the receiver is estimated to be 3 dB higher due to the ground effect.</p>
<section id="octave-band-125-hz-to-1000-hz">
<h4>Octave band 125 Hz to 1000 Hz<a class="headerlink" href="#octave-band-125-hz-to-1000-hz" title="Permalink to this heading">#</a></h4>
<p>As previously noted, the ground attenuation at the source and receiver for the octave bands 125 Hz, 250 Hz, 500 Hz, and 1000 Hz is determined using the prime functions defined earlier. These functions are dependent on the height of the source or receiver above the ground. The impact of height on the prime factor is illustrated below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">125</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>
<span class="n">dp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">2000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">hs</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mf">7.5</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.75</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">]]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fs</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">hs</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
        <span class="n">prime_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span>
        <span class="n">prime_formulas</span> <span class="o">=</span> <span class="p">[</span>
            <span class="mf">1.5</span> <span class="o">+</span> <span class="mf">3.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.12</span><span class="o">*</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="mi">5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dp</span><span class="o">/</span><span class="mi">50</span><span class="p">))</span> <span class="o">+</span> <span class="mf">5.7</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.09</span> <span class="o">*</span> <span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">2.8</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="n">dp</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span>
            <span class="mf">1.5</span> <span class="o">+</span> <span class="mf">8.6</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.09</span><span class="o">*</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dp</span><span class="o">/</span><span class="mi">50</span><span class="p">)),</span>
            <span class="mf">1.5</span> <span class="o">+</span> <span class="mf">14.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.46</span><span class="o">*</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dp</span><span class="o">/</span><span class="mi">50</span><span class="p">)),</span>
            <span class="mf">1.5</span> <span class="o">+</span> <span class="mf">5.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.9</span><span class="o">*</span><span class="n">h</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">dp</span><span class="o">/</span><span class="mi">50</span><span class="p">))</span>
        <span class="p">]</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">dp</span><span class="p">,</span> <span class="n">prime_formulas</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;h = </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prime_labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; [dB]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;f = </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2"> Hz&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$d_p$ [m]&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.02</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">.102</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;lower left&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">borderaxespad</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/98cadd3374df541c18866cc9fa058577aea1fd7a9cc284c10995ad4de27f4d80.png" src="../_images/98cadd3374df541c18866cc9fa058577aea1fd7a9cc284c10995ad4de27f4d80.png" />
</div>
</div>
<p>As observed earlier, the functions <span class="math notranslate nohighlight">\(a'\)</span>, <span class="math notranslate nohighlight">\(b'\)</span>, <span class="math notranslate nohighlight">\(c'\)</span> and <span class="math notranslate nohighlight">\(d'\)</span> all share a minimum limit of 1.5 dB. However, their overall values are dependent on the height of the source/receiver and the projected distance between them. Notably, the prime functions enable attenuations <span class="math notranslate nohighlight">\(A_s\)</span> and <span class="math notranslate nohighlight">\(A_r\)</span> to surpass those of other octave bands, particularly in more porous terrains characterized by a higher ground factor. In such cases, these octave bands possess the capacity to absorb a substantial amount of noise.</p>
</section>
</section>
</section>
<span id="document-src/noise/barrier_attenuation"></span><section class="tex2jax_ignore mathjax_ignore" id="barrier-attenuation">
<h2>Barrier Attenuation<a class="headerlink" href="#barrier-attenuation" title="Permalink to this heading">#</a></h2>
<p>When obstacles are positioned between the point source and the receiver in the line-of-sight, these barriers exert a damping effect on the noise perceived by the receiver. As noise rays encounter a barrier, diffraction occurs in the direction of the shortest path around the barrier. The ISO 9613-2 standard provides methods for calculating both lateral and vertical diffraction around barriers. However, since this model specifically incorporates terrain barriers (excluding barrier attenuation from screens or buildings), ISO 17534-3 suggests ignoring lateral diffractions <span id="id1">[<a class="reference internal" href="src/introduction.html#id13" title="Technical Committee ISO/TC 43/SC 1. ISO 17534-3:2015, Acoustics — Software for the calculation of sound outdoors — Part 3: Recommendations for quality assured implementation of ISO 9613-2 in software according to ISO 17534-1. Technical Report, International Organization for Standardization, Geneva, Switzerland, 2015. URL: https://www.iso.org/standard/66128.html (visited on 2023-08-06).">14</a>]</span>. Additionally, ISO 17534 outlines how higher-order diffractions should be handled, and this approach is integrated into the model. ISO 17534 specifies that the diffraction path should be treated like a tight ribbon extending from the source to the receiver.</p>
<a class="bg-primary reference internal image-reference" href="../_images/diffraction_path.png"><img alt="diffraction_path" class="bg-primary" src="../_images/diffraction_path.png" style="width: 400px;" /></a>
<p><em>Fig 1: Diffraction path from the source to the receiver over multiple barriers (Source: <span id="id2">[<a class="reference internal" href="src/introduction.html#id13" title="Technical Committee ISO/TC 43/SC 1. ISO 17534-3:2015, Acoustics — Software for the calculation of sound outdoors — Part 3: Recommendations for quality assured implementation of ISO 9613-2 in software according to ISO 17534-1. Technical Report, International Organization for Standardization, Geneva, Switzerland, 2015. URL: https://www.iso.org/standard/66128.html (visited on 2023-08-06).">14</a>]</span>).</em></p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">ElevationHandler</span><span class="p">,</span> <span class="n">calc_diffraction</span><span class="p">,</span> <span class="n">calc_diffraction_path</span><span class="p">,</span> <span class="n">print_code</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="calculating-the-diffraction-path">
<h3>Calculating the diffraction path<a class="headerlink" href="#calculating-the-diffraction-path" title="Permalink to this heading">#</a></h3>
<p>The calculation of the diffraction path utilizes a recursive function called <code class="docutils literal notranslate"><span class="pre">diffraction_recursion</span></code>. The process begins with initiating the function using a straight line from the source to the receiver. Subsequently, the algorithm checks if any point along the terrain intersects with this line, indicating a collision between the line-of-sight and the terrain. In case of such a collision, the algorithm identifies the highest elevation difference between the line-of-sight and the terrain, designating the peak of the terrain at this point as a diffraction point. The original line is then split into two segments—one extending from the source to the diffraction point and the other from the diffraction point to the receiver. This recursive process continues until a path is defined from the source to the receiver without any terrain collisions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">calc_diffraction</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">calc_diffraction</span><span style="color: #d0d0d0">(source_height,</span> <span style="color: #d0d0d0">receiver_height,</span> <span style="color: #d0d0d0">terrain_x,</span> <span style="color: #d0d0d0">terrain_y):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">diffraction_recursion</span><span style="color: #d0d0d0">(terrain_x,</span> <span style="color: #d0d0d0">terrain_y,</span> <span style="color: #d0d0d0">xt_new,</span> <span style="color: #d0d0d0">yt_new,</span> <span style="color: #d0d0d0">start_i,</span> <span style="color: #d0d0d0">ylp,</span> <span style="color: #d0d0d0">diffraction_index):</span>
<a id="True-3" name="True-3" href="#True-3"></a>        <span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">calculate_line</span><span style="color: #d0d0d0">(xt,</span> <span style="color: #d0d0d0">ylp):</span>
<a id="True-4" name="True-4" href="#True-4"></a>            <span style="color: #d0d0d0">slope</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(ylp[-</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">ylp[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">(xt[-</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">xt[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])</span>
<a id="True-5" name="True-5" href="#True-5"></a>            <span style="color: #d0d0d0">intercept</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">ylp[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">slope</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">xt[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span>
<a id="True-6" name="True-6" href="#True-6"></a>            <span style="color: #d0d0d0">yl</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">slope</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">xt</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">intercept</span>
<a id="True-7" name="True-7" href="#True-7"></a>            <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">yl</span>
<a id="True-8" name="True-8" href="#True-8"></a>
<a id="True-9" name="True-9" href="#True-9"></a>        <span style="color: #ababab; font-style: italic"># Calculate line profile</span>
<a id="True-10" name="True-10" href="#True-10"></a>        <span style="color: #d0d0d0">yl</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">calculate_line(xt_new,</span> <span style="color: #d0d0d0">ylp)</span>
<a id="True-11" name="True-11" href="#True-11"></a>        <span style="color: #d0d0d0">diff</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(yl</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">yt_new)</span>
<a id="True-12" name="True-12" href="#True-12"></a>
<a id="True-13" name="True-13" href="#True-13"></a>        <span style="color: #ababab; font-style: italic"># Check if the line collides with terrain</span>
<a id="True-14" name="True-14" href="#True-14"></a>        <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">np.any(diff</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">-</span><span style="color: #51b2fd">1e-5</span><span style="color: #d0d0d0">):</span>
<a id="True-15" name="True-15" href="#True-15"></a>            <span style="color: #d0d0d0">yi_peak</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.argmin(diff)</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">start_i</span>
<a id="True-16" name="True-16" href="#True-16"></a>            <span style="color: #d0d0d0">yimax</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.argmin(diff)</span>  <span style="color: #ababab; font-style: italic"># Splitting index</span>
<a id="True-17" name="True-17" href="#True-17"></a>            <span style="color: #d0d0d0">diffraction_index.append([terrain_x[yi_peak],</span> <span style="color: #d0d0d0">terrain_y[yi_peak]])</span>
<a id="True-18" name="True-18" href="#True-18"></a>
<a id="True-19" name="True-19" href="#True-19"></a>            <span style="color: #ababab; font-style: italic"># Recursively process the left side of the splitting point</span>
<a id="True-20" name="True-20" href="#True-20"></a>            <span style="color: #d0d0d0">xt0,</span> <span style="color: #d0d0d0">yt0</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">xt_new[:yimax],</span> <span style="color: #d0d0d0">yt_new[:yimax]</span>
<a id="True-21" name="True-21" href="#True-21"></a>            <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #2fbccd">len</span><span style="color: #d0d0d0">(xt0)</span> <span style="color: #d0d0d0">&gt;</span> <span style="color: #51b2fd">2</span><span style="color: #d0d0d0">:</span>
<a id="True-22" name="True-22" href="#True-22"></a>                <span style="color: #d0d0d0">ylp0</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">calculate_line(xt0,</span> <span style="color: #d0d0d0">[yl[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">yt_new[yimax]])</span>
<a id="True-23" name="True-23" href="#True-23"></a>                <span style="color: #d0d0d0">diffraction_recursion(terrain_x,</span> <span style="color: #d0d0d0">terrain_y,</span> <span style="color: #d0d0d0">xt0,</span> <span style="color: #d0d0d0">yt0,</span> <span style="color: #d0d0d0">start_i,</span> <span style="color: #d0d0d0">ylp0,</span> <span style="color: #d0d0d0">diffraction_index)</span>
<a id="True-24" name="True-24" href="#True-24"></a>
<a id="True-25" name="True-25" href="#True-25"></a>            <span style="color: #ababab; font-style: italic"># Recursively process the right side of the splitting point</span>
<a id="True-26" name="True-26" href="#True-26"></a>            <span style="color: #d0d0d0">xt1,</span> <span style="color: #d0d0d0">yt1</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">xt_new[yimax</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">:],</span> <span style="color: #d0d0d0">yt_new[yimax</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">:]</span>
<a id="True-27" name="True-27" href="#True-27"></a>            <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #2fbccd">len</span><span style="color: #d0d0d0">(xt1)</span> <span style="color: #d0d0d0">&gt;</span> <span style="color: #51b2fd">2</span><span style="color: #d0d0d0">:</span>
<a id="True-28" name="True-28" href="#True-28"></a>                <span style="color: #d0d0d0">start_i</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">yimax</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">1</span>
<a id="True-29" name="True-29" href="#True-29"></a>                <span style="color: #d0d0d0">ylp1</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">calculate_line(xt1,</span> <span style="color: #d0d0d0">[yt_new[yimax],</span> <span style="color: #d0d0d0">yl[-</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]])</span>
<a id="True-30" name="True-30" href="#True-30"></a>                <span style="color: #d0d0d0">diffraction_recursion(terrain_x,</span> <span style="color: #d0d0d0">terrain_y,</span> <span style="color: #d0d0d0">xt1,</span> <span style="color: #d0d0d0">yt1,</span> <span style="color: #d0d0d0">start_i,</span> <span style="color: #d0d0d0">ylp1,</span> <span style="color: #d0d0d0">diffraction_index)</span>
<a id="True-31" name="True-31" href="#True-31"></a>
<a id="True-32" name="True-32" href="#True-32"></a>    <span style="color: #ababab; font-style: italic"># Initialize variables</span>
<a id="True-33" name="True-33" href="#True-33"></a>    <span style="color: #d0d0d0">diffraction_index</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">terrain_y[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">source_height]]</span>
<a id="True-34" name="True-34" href="#True-34"></a>    <span style="color: #d0d0d0">ylp</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[terrain_y[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">source_height,</span> <span style="color: #d0d0d0">terrain_y[-</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">receiver_height]</span>
<a id="True-35" name="True-35" href="#True-35"></a>    <span style="color: #d0d0d0">xt_new,</span> <span style="color: #d0d0d0">yt_new</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">terrain_x,</span> <span style="color: #d0d0d0">terrain_y</span>
<a id="True-36" name="True-36" href="#True-36"></a>    <span style="color: #d0d0d0">start_i</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">0</span>
<a id="True-37" name="True-37" href="#True-37"></a>
<a id="True-38" name="True-38" href="#True-38"></a>    <span style="color: #ababab; font-style: italic"># Perform recursion to identify diffraction points</span>
<a id="True-39" name="True-39" href="#True-39"></a>    <span style="color: #d0d0d0">diffraction_recursion(terrain_x,</span> <span style="color: #d0d0d0">terrain_y,</span> <span style="color: #d0d0d0">xt_new,</span> <span style="color: #d0d0d0">yt_new,</span> <span style="color: #d0d0d0">start_i,</span> <span style="color: #d0d0d0">ylp,</span> <span style="color: #d0d0d0">diffraction_index)</span>
<a id="True-40" name="True-40" href="#True-40"></a>
<a id="True-41" name="True-41" href="#True-41"></a>    <span style="color: #ababab; font-style: italic"># Sort and append the final point</span>
<a id="True-42" name="True-42" href="#True-42"></a>    <span style="color: #d0d0d0">diffraction_index</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.array(diffraction_index)</span>
<a id="True-43" name="True-43" href="#True-43"></a>    <span style="color: #d0d0d0">diffraction_index</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">diffraction_index[np.argsort(diffraction_index[:,</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])]</span>
<a id="True-44" name="True-44" href="#True-44"></a>    <span style="color: #d0d0d0">diffraction_index</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.vstack((diffraction_index,</span> <span style="color: #d0d0d0">np.array([terrain_x[-</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">terrain_y[-</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">receiver_height])))</span>
<a id="True-45" name="True-45" href="#True-45"></a>
<a id="True-46" name="True-46" href="#True-46"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">diffraction_index</span>
</pre></div>
</div></div>
</div>
<section id="demonstration-of-code">
<h4>Demonstration of code<a class="headerlink" href="#demonstration-of-code" title="Permalink to this heading">#</a></h4>
<p>Here’s an example illustrating the calculation of the diffraction path between two points in the terrain.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">terrain_data</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">([</span><span class="mf">11.9</span><span class="p">,</span> <span class="mf">12.1</span><span class="p">,</span> <span class="mf">54.9</span><span class="p">,</span> <span class="mf">55.1</span><span class="p">],</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">])</span><span class="o">.</span><span class="n">map_array</span>

<span class="n">start_pixel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="mi">55</span><span class="p">)</span>
<span class="n">end_pixel</span> <span class="o">=</span> <span class="p">(</span><span class="mi">170</span><span class="p">,</span> <span class="mi">155</span><span class="p">)</span>
<span class="n">source_height</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">receiver_height</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">end_pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">start_pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start_pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">length</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start_pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end_pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">length</span><span class="p">)</span>
<span class="n">distance_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
<span class="n">elevation_values</span> <span class="o">=</span> <span class="n">terrain_data</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">x_coords</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">y_coords</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
<span class="n">diffraction_path</span> <span class="o">=</span> <span class="n">calc_diffraction</span><span class="p">(</span><span class="n">source_height</span><span class="p">,</span> <span class="n">receiver_height</span><span class="p">,</span> <span class="n">distance_points</span><span class="p">,</span> <span class="n">elevation_values</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">terrain_plot</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">terrain_data</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span><span class="s2">&quot;terrain&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">start_pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">end_pixel</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">start_pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">end_pixel</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="s1">&#39;ro:&#39;</span><span class="p">)</span>
<span class="n">colorbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">terrain_plot</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Terrain Elevation [m]&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">distance_points</span><span class="p">,</span> <span class="n">elevation_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Terrain Elevation&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">diffraction_path</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Diffraction Path&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">diffraction_path</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Diffraction Point(s) = </span><span class="si">{</span><span class="n">diffraction_path</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">2</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;None&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">],</span> <span class="p">[</span><span class="n">elevation_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">source_height</span><span class="p">,</span> <span class="n">elevation_values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">receiver_height</span><span class="p">],</span> <span class="s1">&#39;ro:&#39;</span><span class="p">,</span>
             <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Direct Line-of-Sight&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;dp [m]&quot;</span><span class="p">,</span>
            <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;h [m]&quot;</span><span class="p">)</span>
<span class="n">legend</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9bff9bc8d4ef861644cd1463ea534b23ca26b0cdabfdcd8e01973c0bc1e779fc.png" src="../_images/9bff9bc8d4ef861644cd1463ea534b23ca26b0cdabfdcd8e01973c0bc1e779fc.png" />
</div>
</div>
</section>
</section>
<section id="calculation-of-barrier-attenuation">
<h3>Calculation of barrier attenuation<a class="headerlink" href="#calculation-of-barrier-attenuation" title="Permalink to this heading">#</a></h3>
<p>The total attenuation caused by a barrier, denoted as <span class="math notranslate nohighlight">\(D_z\)</span>, can be computed using the formula:</p>
<div class="math notranslate nohighlight">
\[D_z = 10 \log_{10}\left(3 + \left(\frac{C_2}{\lambda}\right) C_3 z K_{met}\right)\]</div>
<p><span class="math notranslate nohighlight">\(\lambda\)</span> represents the sound wavelength, <span class="math notranslate nohighlight">\(C_2 = 20\)</span> and is a reflection constant, <span class="math notranslate nohighlight">\(C_3\)</span> is a diffraction constant, <span class="math notranslate nohighlight">\(z\)</span> is the difference between the path lengths of diffracted and direct sound, calculated as <span class="math notranslate nohighlight">\(z = (d_{ss} + e + d_{sr}) - d\)</span>, where <span class="math notranslate nohighlight">\(e\)</span> represents the distance between the diffraction edges in the case of multiple diffractions. The correction factor for meteorological conditions, <span class="math notranslate nohighlight">\(K_{met}\)</span>, is defined as:</p>
<div class="math notranslate nohighlight">
\[
K_{met} = \exp\left(-\frac{1}{2000} \sqrt{\frac{d_{ss} \cdot d_{sr} \cdot d}{2 z}}\right)
\]</div>
<p>The diffraction constant <span class="math notranslate nohighlight">\(C_3\)</span> is defined as:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
C_3 = \begin{cases}
1 &amp; \text{if } e \leq 0\\
\frac{1 + \left(\frac{5 \cdot \lambda}{e}\right)^2}{\frac{1}{3} + \left(\frac{5 \cdot \lambda}{e}\right)^2} &amp; \text{if } e &gt; 0
\end{cases}
\end{split}\]</div>
<section id="visualization-of-diffraction-length">
<h4>Visualization of Diffraction Length<a class="headerlink" href="#visualization-of-diffraction-length" title="Permalink to this heading">#</a></h4>
<p>Presented below is a concise visualization illustrating the disparity between the direct path and the diffraction path. It’s crucial to observe that when these two distances diverge, the noise is anticipated to intersect with the terrain, and barrier attenuation is factored into the calculation for the sound pressure level at that location. Conversely, if the diffraction path and direct path align, indicating no collision with the terrain, the barrier attenuation is disregarded.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">map_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="mf">11.9</span><span class="p">,</span> <span class="mf">12.1</span><span class="p">,</span> <span class="mf">54.9</span><span class="p">,</span> <span class="mf">55.1</span><span class="p">]</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span>

<span class="n">point_source_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[{</span>
        <span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span>

<span class="n">dp</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">dss</span><span class="p">,</span> <span class="n">dsr</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">calc_diffraction_path</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">)</span>

<span class="n">diff_path</span> <span class="o">=</span> <span class="n">dsr</span><span class="o">+</span><span class="n">dss</span><span class="o">+</span><span class="n">e</span>
<span class="n">diff_path</span><span class="p">[</span><span class="n">diff_path</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">diff_path</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">pcm1</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">map_array</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;terrain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm1</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Elevation [m]&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">pcm2</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;terrain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm2</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Direct path to receiver, d [m]&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">pcm3</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">diff_path</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;terrain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm3</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;Diffraction path to receiver, ($d_</span><span class="si">{sr}</span><span class="s2"> + e + d_</span><span class="si">{ss}</span><span class="s2">$) [m]&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">pcm4</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="p">(</span><span class="n">diff_path</span><span class="o">-</span><span class="n">d</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;terrain&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">pcm4</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Difference between direct and diffraction path [m]&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>


<span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">():</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Longitude&quot;</span><span class="p">,</span>
           <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>
    
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/bec3e3e509478e10593dedf226507f01773d1ba6d4e41798e918285b33cadd46.png" src="../_images/bec3e3e509478e10593dedf226507f01773d1ba6d4e41798e918285b33cadd46.png" />
</div>
</div>
</section>
<section id="meteorological-conditions">
<h4>Meteorological conditions<a class="headerlink" href="#meteorological-conditions" title="Permalink to this heading">#</a></h4>
<p>Here is a brief illustration showcasing the impact of meteorological conditions through the correction factor <span class="math notranslate nohighlight">\(K_{met}\)</span> for various barrier heights (<span class="math notranslate nohighlight">\(h\)</span>) positioned between the sound source and the receiver. When the diffraction path and the direct path are equal (<span class="math notranslate nohighlight">\(z \leq 0\)</span>), the correction factor is equal to <span class="math notranslate nohighlight">\(K_{met} = 1\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># height barrier relative to source and receiver</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">h</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">hb</span><span class="p">):</span>
    <span class="n">dss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">d</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
    <span class="n">dsr</span> <span class="o">=</span> <span class="n">dss</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">dsr</span> <span class="o">+</span> <span class="n">dss</span><span class="p">)</span> <span class="o">-</span> <span class="n">d</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">0</span>
    <span class="n">Kmet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2000</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">dss</span> <span class="o">*</span> <span class="n">dsr</span> <span class="o">*</span> <span class="n">d</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">z</span><span class="p">)))</span>
    <span class="n">Kmet</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">semilogx</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">Kmet</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;h = </span><span class="si">{</span><span class="n">h</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Distance Source - Receiver [m]&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="sa">r</span><span class="s2">&quot;$K_</span><span class="si">{met}</span><span class="s2">$&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3033be4e95851a11025fb0a6b433ec6dfad756d6c10ea433c66a0cf12c74d5f6.png" src="../_images/3033be4e95851a11025fb0a6b433ec6dfad756d6c10ea433c66a0cf12c74d5f6.png" />
</div>
</div>
<p>As evident from the above plot, the meteorological correction factor significantly decreases at longer distances <span class="math notranslate nohighlight">\(d\)</span> between the source and the receiver. This results in a notable limitation of the barrier attenuation to <span class="math notranslate nohighlight">\(D_z = 10 \log_{10}(3)\)</span> for distances exceeding 1000 meters between the source and the receiver.</p>
</section>
</section>
</section>
<span id="document-src/noise/verification"></span><section class="tex2jax_ignore mathjax_ignore" id="verification-of-results">
<h2>Verification of Results<a class="headerlink" href="#verification-of-results" title="Permalink to this heading">#</a></h2>
<p>In order to evaluate the validity and accuracy of the program’s results, several test cases were compared against the ISO 9613-2 implementation conducted by <span id="id1">MAS Environmental Ltd [<a class="reference internal" href="src/introduction.html#id3" title="MAS Environmental Ltd. dBmap.net Noise Mapping Tool. URL: https://noisetools.net/dbmap/ (visited on 2023-11-29).">11</a>]</span>. The software was tested using identical test cases created on both <a class="reference external" href="http://dBmap.net">dBmap.net</a> and in a Jupyter Notebook, demonstrating the level of attenuation in various environments. This comparison allowed for an assessment of the program’s performance and its adherence to the ISO standard.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">ElevationHandlerTest</span><span class="p">,</span> <span class="n">solve_noise_map</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">RectBivariateSpline</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="simulation-setup">
<h3>Simulation Setup<a class="headerlink" href="#simulation-setup" title="Permalink to this heading">#</a></h3>
<p>The simulations utilize a custom class called <code class="docutils literal notranslate"><span class="pre">ElevationHandlerTest</span></code> designed to manage elevation data instead of deriving it from the SRTM30 source. In these simulations, the terrain is considered flat, except for barrier evaluation. The scenario involves a point source positioned at an elevation of 1 meter and a receiver at ground level (0 meters). The environmental conditions are standardized with a temperature of 15°C, relative humidity at 70%. The simulations focus on a specific octave band (1000 Hz) with a Sound Pressure Level (SPL) set to 100 dB(A). The point source is positioned at x = 20 and a receiver located at x = 100.</p>
<section id="flat-ground-with-ground-factor-of-0">
<h4>Flat ground with ground factor of 0<a class="headerlink" href="#flat-ground-with-ground-factor-of-0" title="Permalink to this heading">#</a></h4>
<a class="bg-primary reference internal image-reference" href="../_images/ground_factor0.png"><img alt="ground_factor0" class="bg-primary" src="../_images/ground_factor0.png" style="width: 1000px;" /></a>
<p><em>Fig 1: Simulation with flat ground and a ground factor of 0 (<a class="reference external" href="https://dbmap.net/803qv">Simulation Source</a>).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;octave_band&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}}])</span>

<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">210</span><span class="p">]</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="n">map_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">map_shape</span><span class="p">)</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandlerTest</span><span class="p">(</span><span class="n">map_array</span><span class="p">,</span> <span class="n">map_boundaries</span><span class="p">)</span>
<span class="n">LDW</span> <span class="o">=</span> <span class="n">solve_noise_map</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">ground_factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">receiver</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>

<span class="n">interp_spline</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">)</span>
<span class="n">receiver_value</span> <span class="o">=</span> <span class="n">interp_spline</span><span class="p">(</span><span class="n">receiver</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">receiver</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot; Source Point&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">receiver</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Receiver = </span><span class="si">{</span><span class="n">receiver_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> dB(A)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/4a5be9914869822c93ad6ccc951a1c8bafc410301aefac9b2a044be134e27014.png" src="../_images/4a5be9914869822c93ad6ccc951a1c8bafc410301aefac9b2a044be134e27014.png" />
</div>
</div>
</section>
<section id="flat-ground-with-ground-factor-of-0-5">
<h4>Flat ground with ground factor of 0.5<a class="headerlink" href="#flat-ground-with-ground-factor-of-0-5" title="Permalink to this heading">#</a></h4>
<a class="bg-primary reference internal image-reference" href="../_images/ground_factor05.png"><img alt="ground_factor0" class="bg-primary" src="../_images/ground_factor05.png" style="width: 1000px;" /></a>
<p><em>Fig 2: Simulation with flat ground and a ground factor of 0.5 (<a class="reference external" href="https://dbmap.net/v38b2/">Simulation Source</a>).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;octave_band&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}}])</span>

<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">210</span><span class="p">]</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="n">map_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">map_shape</span><span class="p">)</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandlerTest</span><span class="p">(</span><span class="n">map_array</span><span class="p">,</span> <span class="n">map_boundaries</span><span class="p">)</span>
<span class="n">LDW</span> <span class="o">=</span> <span class="n">solve_noise_map</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">ground_factor</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="n">receiver</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">interp_spline</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">)</span>
<span class="n">receiver_value</span> <span class="o">=</span> <span class="n">interp_spline</span><span class="p">(</span><span class="n">receiver</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">receiver</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot; Source Point&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">receiver</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Receiver = </span><span class="si">{</span><span class="n">receiver_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> dB(A)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3dea2a6f5183581314f2d90089e0465ad8b48bf9bfac777fcb69937a65dc642e.png" src="../_images/3dea2a6f5183581314f2d90089e0465ad8b48bf9bfac777fcb69937a65dc642e.png" />
</div>
</div>
</section>
<section id="flat-ground-with-ground-factor-of-1">
<h4>Flat ground with ground factor of 1<a class="headerlink" href="#flat-ground-with-ground-factor-of-1" title="Permalink to this heading">#</a></h4>
<a class="bg-primary reference internal image-reference" href="../_images/ground_factor1.png"><img alt="ground_factor1" class="bg-primary" src="../_images/ground_factor1.png" style="width: 1000px;" /></a>
<p><em>Fig 3: Simulation with flat ground and a ground factor of 1 (<a class="reference external" href="https://dbmap.net/267yt">Simulation Source</a>).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;octave_band&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}}])</span>

<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">210</span><span class="p">]</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="n">map_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">map_shape</span><span class="p">)</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandlerTest</span><span class="p">(</span><span class="n">map_array</span><span class="p">,</span> <span class="n">map_boundaries</span><span class="p">)</span>
<span class="n">LDW</span> <span class="o">=</span> <span class="n">solve_noise_map</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">ground_factor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">receiver</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">interp_spline</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">)</span>
<span class="n">receiver_value</span> <span class="o">=</span> <span class="n">interp_spline</span><span class="p">(</span><span class="n">receiver</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">receiver</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot; Source Point&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">receiver</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Receiver = </span><span class="si">{</span><span class="n">receiver_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> dB(A)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e7da0c96279e37a009020e25d286c63dcc589b6cf2a841e996375f79931ead85.png" src="../_images/e7da0c96279e37a009020e25d286c63dcc589b6cf2a841e996375f79931ead85.png" />
</div>
</div>
</section>
<section id="simulation-with-a-single-barrier">
<h4>Simulation with a single barrier<a class="headerlink" href="#simulation-with-a-single-barrier" title="Permalink to this heading">#</a></h4>
<a class="bg-primary reference internal image-reference" href="../_images/single_barrier.png"><img alt="single_barrier" class="bg-primary" src="../_images/single_barrier.png" style="width: 1000px;" /></a>
<p><em>Fig 4: Simulation with a single barrier and a ground factor of 0 (<a class="reference external" href="https://dbmap.net/k7e24">Simulation Source</a>).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;octave_band&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}}])</span>

<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">210</span><span class="p">]</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="n">map_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">map_shape</span><span class="p">)</span>
<span class="n">map_array</span><span class="p">[:,</span><span class="mi">80</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># add barrier</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandlerTest</span><span class="p">(</span><span class="n">map_array</span><span class="p">,</span> <span class="n">map_boundaries</span><span class="p">)</span>
<span class="n">LDW</span> <span class="o">=</span> <span class="n">solve_noise_map</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">ground_factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">receiver</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">interp_spline</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">)</span>
<span class="n">receiver_value</span> <span class="o">=</span> <span class="n">interp_spline</span><span class="p">(</span><span class="n">receiver</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">receiver</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot; Source Point&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">receiver</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Receiver = </span><span class="si">{</span><span class="n">receiver_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> dB(A)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Barrier&quot;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7e21d155002d97eac7b02ca0bc41a999f6002adae91b0884d980d7e4799f98b8.png" src="../_images/7e21d155002d97eac7b02ca0bc41a999f6002adae91b0884d980d7e4799f98b8.png" />
</div>
</div>
<p>As seen in the above figures, the calculations from both <a class="reference external" href="http://dBmap.net">dBmap.net</a> and the program shows good agreement. Both simulations adhere to the ISO 9613-2 limits, which prescribe an attenuation of 20 dB(A) for single diffraction and 25 dB(A) for multiple diffraction. In this specific scenario with a single barrier lacking thickness, only one diffraction occurs, and the barrier’s attenuation is accordingly capped at 20 dB(A).</p>
</section>
<section id="double-barrier">
<h4>Double Barrier<a class="headerlink" href="#double-barrier" title="Permalink to this heading">#</a></h4>
<a class="bg-primary reference internal image-reference" href="../_images/double_barrier.png"><img alt="single_barrier" class="bg-primary" src="../_images/double_barrier.png" style="width: 1000px;" /></a>
<p><em>Fig 5: Simulation with double barriers and a ground factor of 0 (<a class="reference external" href="https://dbmap.net/wcga6">Simulation Source</a>).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;octave_band&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;1000&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}}])</span>

<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">210</span><span class="p">]</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">]</span>
<span class="n">map_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">map_shape</span><span class="p">)</span>
<span class="n">map_array</span><span class="p">[:,</span><span class="mi">80</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># add barrier</span>
<span class="n">map_array</span><span class="p">[:,</span><span class="mi">140</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span> <span class="c1"># add barrier 2</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandlerTest</span><span class="p">(</span><span class="n">map_array</span><span class="p">,</span> <span class="n">map_boundaries</span><span class="p">)</span>
<span class="n">LDW</span> <span class="o">=</span> <span class="n">solve_noise_map</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">ground_factor</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">receiver</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">]</span>
<span class="n">interp_spline</span> <span class="o">=</span> <span class="n">RectBivariateSpline</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">)</span>
<span class="n">receiver_value</span> <span class="o">=</span> <span class="n">interp_spline</span><span class="p">(</span><span class="n">receiver</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">receiver</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">cl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">elevation_handler</span><span class="o">.</span><span class="n">long_range</span><span class="p">,</span> <span class="n">elevation_handler</span><span class="o">.</span><span class="n">lat_range</span><span class="p">,</span> <span class="n">LDW</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot; Source Point&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">receiver</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Receiver = </span><span class="si">{</span><span class="n">receiver_value</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> dB(A)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Barrier&quot;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">70</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5f22e76d691cabbadec5c450e2b0e6116841aa8837edb7d256507933bc2e8a8c.png" src="../_images/5f22e76d691cabbadec5c450e2b0e6116841aa8837edb7d256507933bc2e8a8c.png" />
</div>
</div>
</section>
</section>
<section id="comment-on-the-results">
<h3>Comment on the results<a class="headerlink" href="#comment-on-the-results" title="Permalink to this heading">#</a></h3>
<p>As it can be seen from the figures above, the alignment between the industrial ISO 9613-2 standard implementation and the implementation in this Jupyter Notebook is nearly flawless. The minor discrepancy between the two codes can likely be attributed to the Jupyter Notebook’s use of discrete steps to depict the environment, introducing small rounding errors when elements (such as the source or receiver) are not precisely centered within the cells. Nevertheless, the observed error generally remains below 1% of that found in the industrial code.</p>
</section>
</section>
</div>
</section>
<span id="document-src/shadow/shadow_map"></span><section class="tex2jax_ignore mathjax_ignore" id="shadow-map">
<h1>Shadow Map<a class="headerlink" href="#shadow-map" title="Permalink to this heading">#</a></h1>
<p>This chapter outlines the shadow mapping process, employing ray tracing to precisely delineate the patterns of shadow flickering attributed to a wind park. Through this method, a reliable estimation is obtained, facilitating a good assessment of the potential impact of shadow flickering on neighboring residents in the vicinity of the wind park.</p>
<section id="what-is-shadow-flicker">
<h2>What is Shadow Flicker?<a class="headerlink" href="#what-is-shadow-flicker" title="Permalink to this heading">#</a></h2>
<p>Shadow flicker occurs when the sun shines through the rotating blades of a wind turbine, creating a dynamic shadow. This phenomenon raises concerns within nearby communities when the intermittent shadow from the turbine’s rotating blades passes over buildings or homes, leading to the perception of a recurrent flicker with alternating light and dark periods through windows.</p>
<p>Given the specific sun angle required for this effect, shadow flicker is relatively uncommon, manifesting in restricted areas and lasting only a few hours annually. Nevertheless, when it does occur, it has the potential to become a nuisance for homeowners situated in close proximity to the turbines. Therefore, the government imposes stringent regulations on wind park developers to ensure that the impact of shadow flickering remains below specified thresholds (e.g., Denmark’s limit of 10 hours per year) for neighboring residents. If instances arise where shadow flickering surpasses these defined limits, curtailment measures may become necessary.</p>
<a class="bg-primary reference internal image-reference" href="../_images/shadow-flicker.png"><img alt="shadow-flickering" class="bg-primary" src="../_images/shadow-flicker.png" style="width: 300px;" /></a>
<p><em>Fig 1: Shadow flickering becomes more pronounced in the evening due to the lower altitude of the sun, resulting in longer shadows cast by the turbines. (<a class="reference external" href="https://energyfollower.com/wind-turbine-shadow-flicker/">Image Source</a>)</em></p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.cython</span> <span class="kn">import</span> <span class="n">solve_shadow_map</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">ElevationHandler</span><span class="p">,</span> <span class="n">shadow_map_solver</span><span class="p">,</span> <span class="n">import_point_source_data</span><span class="p">,</span> <span class="n">calc_extent</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">from</span> <span class="nn">cartopy.io.img_tiles</span> <span class="kn">import</span> <span class="n">GoogleTiles</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
</pre></div>
</div>
</div>
</details>
</div>
</section>
<section id="running-the-script">
<h2>Running the Script<a class="headerlink" href="#running-the-script" title="Permalink to this heading">#</a></h2>
<p>To execute the shadow flickering calculator, the <code class="docutils literal notranslate"><span class="pre">shadow_map_solver</span></code> function requires details about the terrain elevation of the target area and specifications of the wind park turbines. This essential information is acquired by utilizing the <code class="docutils literal notranslate"><span class="pre">ElevationHandler</span></code> and <code class="docutils literal notranslate"><span class="pre">import_point_source_data</span></code> functions. The time frame for the shadow mapping is determined by setting the start and end dates. The script then runs the shadow mapping solver, producing a cumulative shadow map that includes the entire wind park.</p>
<p>To generate an accurate shadow map, it is crucial to minimize the time interval between iterations to avoid creating gaps in the map. A default interval of freq = “10min” is currently used. To encompass the entire wind turbine rotor disc in the simulation, the rotor disc is approximated as a collection of points, each representing the starting point of a ray from the sun to the ground. To optimize simulation time, the minimum point density of the rotor disc is calculated based on terrain resolution and solar altitude angle.</p>
<p>To further expedite calculations, the main script has been converted to C using Cython. Despite these optimizations, the function remains computationally intensive, and the runtime can extend to several minutes depending on the number of turbines in the wind park and the terrain resolution.</p>
</section>
<section id="displaying-to-results">
<h2>Displaying to Results<a class="headerlink" href="#displaying-to-results" title="Permalink to this heading">#</a></h2>
<p>Once the script completes its iteration across individual wind turbines, the aggregated results can be visualized overlaid on an image from Google Maps.</p>
<section id="wind-park-juurakko">
<h3>Wind Park Juurakko<a class="headerlink" href="#wind-park-juurakko" title="Permalink to this heading">#</a></h3>
<p>Juurakko Wind Park, situated in Kalajoki, Finland, is a wind facility boasting a capacity of 40 MW. Constructed in 2022, it comprises seven Nordex N163 turbines, each with a capacity of 5.7 MW and a hub height reaching 148 meters and a rotor diameter of 163 meters <span id="id1">[<a class="reference internal" href="src/introduction.html#id5" title="Etha Wind Oy. Noise study wind farm juurakko. 2014. URL: https://kalajoki.fi/wp-content/uploads/2020/11/Liite4_Juurakko_Noise_Study_CG200603-1AM.pdf (visited on 2023-11-29).">8</a>]</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">import_point_source_data</span><span class="p">(</span><span class="s2">&quot;Juurakko.json&quot;</span><span class="p">)</span> <span class="c1"># load wind park data</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span> <span class="c1"># resolution of map data (in pixels)</span>
<span class="n">dist</span> <span class="o">=</span> <span class="mi">3000</span> <span class="c1"># distance from turbines to the edge of the map (in meters)</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">calc_extent</span><span class="p">(</span><span class="n">point_source_data</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span> <span class="c1"># calculate map boundaries (min/max longitude and latitude)</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span> <span class="c1"># Initiate Elevation Handler (Takes care of the map downloads)</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2023-01-01 00:00:00&#39;</span> <span class="c1"># Start date</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2023-12-31 23:59:59&#39;</span> <span class="c1"># End date</span>
<span class="n">processes</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># Processes for multiprocessing</span>

<span class="n">cum_shadow_map</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">shadow_map_solver</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="n">processes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">imagery</span> <span class="o">=</span> <span class="n">GoogleTiles</span><span class="p">(</span><span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;satellite&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">imagery</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">)</span>

<span class="n">cp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">cum_shadow_map</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> 
           <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Wind Turbines&quot;</span><span class="p">,</span>
           <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Shadow Hour(s)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">imagery</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="c1"># Deterine Image Resolution</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/65963c8c6763f87b93828f460038e29cb5e2fedbb01f719b7f29fd3ab0a5e485.png" src="../_images/65963c8c6763f87b93828f460038e29cb5e2fedbb01f719b7f29fd3ab0a5e485.png" />
</div>
</div>
</section>
<section id="wind-park-provestenen">
<h3>Wind Park Prøvestenen<a class="headerlink" href="#wind-park-provestenen" title="Permalink to this heading">#</a></h3>
<p>The Prøvestenen Wind Park, located in Copenhagen, Denmark, comprises three turbines with a combined capacity of 6.0 MW. The turbines utilized in this facility are the Vestas V80-2.0 MW VCS Mark 7 models, boasting a hub height of 67 meters and a rotor diameter of 80 meters. This wind park was established in the year 2013.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">import_point_source_data</span><span class="p">(</span><span class="s2">&quot;Prøvestenen.json&quot;</span><span class="p">)</span> <span class="c1"># load wind park data</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span> <span class="c1"># resolution of map data (in pixels)</span>
<span class="n">dist</span> <span class="o">=</span> <span class="mi">3000</span> <span class="c1"># distance from turbines to the edge of the map (in meters)</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">calc_extent</span><span class="p">(</span><span class="n">point_source_data</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span> <span class="c1"># calculate map boundaries (min/max longitude and latitude)</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span> <span class="c1"># Initiate Elevation Handler (Takes care of the map downloads)</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2023-01-01 00:00:00&#39;</span> <span class="c1"># Start date</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2023-12-31 23:59:59&#39;</span> <span class="c1"># End date</span>
<span class="n">processes</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1"># Processes for multiprocessing</span>

<span class="n">cum_shadow_map</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">shadow_map_solver</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="n">processes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">imagery</span> <span class="o">=</span> <span class="n">GoogleTiles</span><span class="p">(</span><span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;satellite&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">imagery</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">)</span>

<span class="n">cp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">cum_shadow_map</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> 
           <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Wind Turbines&quot;</span><span class="p">,</span>
           <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Shadow Hour(s)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">imagery</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="c1"># Deterine Image Resolution</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/6117493c1b035136b77572141bb6c078029302616b1844feaa19563605df0ca9.png" src="../_images/6117493c1b035136b77572141bb6c078029302616b1844feaa19563605df0ca9.png" />
</div>
</div>
</section>
<section id="wind-park-ostrup-fictive">
<h3>Wind Park Østrup (Fictive)<a class="headerlink" href="#wind-park-ostrup-fictive" title="Permalink to this heading">#</a></h3>
<p>Due to lack of shadow flickering map to easily compare against, a fictive wind park in Østrup Denmark was used for a low level comparison. The park consists of two Vestas V136 3.45 MW wind turbines with a hub height of 82 meters and a rotor diameter of 136 meters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">import_point_source_data</span><span class="p">(</span><span class="s2">&quot;Østrup.json&quot;</span><span class="p">)</span> <span class="c1"># load wind park data</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">]</span> <span class="c1"># resolution of map data (in pixels)</span>
<span class="n">dist</span> <span class="o">=</span> <span class="mi">2000</span> <span class="c1"># distance from turbines to the edge of the map (in meters)</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">calc_extent</span><span class="p">(</span><span class="n">point_source_data</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span> <span class="c1"># calculate map boundaries (min/max longitude and latitude)</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span> <span class="c1"># Initiate Elevation Handler (Takes care of the map downloads)</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2023-01-01 00:00:00&#39;</span> <span class="c1"># Start date</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2023-12-31 23:59:59&#39;</span> <span class="c1"># End date</span>
<span class="n">processes</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># Processes for multiprocessing</span>

<span class="n">cum_shadow_map</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">shadow_map_solver</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">processes</span> <span class="o">=</span> <span class="n">processes</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;10min&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="n">imagery</span> <span class="o">=</span> <span class="n">GoogleTiles</span><span class="p">(</span><span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;satellite&quot;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="n">imagery</span><span class="o">.</span><span class="n">crs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">)</span>

<span class="n">levels</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>

<span class="n">cp</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">cum_shadow_map</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;jet&quot;</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span><span class="n">levels</span> <span class="o">=</span> <span class="n">levels</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">point_source_data</span><span class="o">.</span><span class="n">longitude</span><span class="p">,</span> <span class="n">point_source_data</span><span class="o">.</span><span class="n">latitude</span><span class="p">,</span> 
           <span class="n">marker</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Wind Turbines&quot;</span><span class="p">,</span>
           <span class="n">transform</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">())</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cp</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Shadow Hour(s)&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">imagery</span><span class="p">,</span> <span class="mi">14</span><span class="p">)</span> <span class="c1"># Deterine Image Resolution</span>
<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/017f3cc196dca9c2d5f60857b770f81178fcdfc93761584ffd5dda053644f304.png" src="../_images/017f3cc196dca9c2d5f60857b770f81178fcdfc93761584ffd5dda053644f304.png" />
</div>
</div>
<a class="bg-primary reference internal image-reference" href="../_images/shadow_flicker_ostrup.png"><img alt="shadow-flicker_ostrup" class="bg-primary" src="../_images/shadow_flicker_ostrup.png" style="width: 700px;" /></a>
<p><em>Fig 2: Shadow flickering from fictive wind park in Ørstrup, Denmark calculated using WindPro.</em></p>
<p>As seen from the comparison, it is clear that the calculated annual hours of shadow flickering align quite well between the two models. Nevertheless, the WindPro model anticipates a higher occurrence of shadow flickering, attributing it to the elongated shadows cast during the early and late hours of the day. This is likely a result of the applied solar altitude limit set at 5 degrees, where calculations cease if the sun’s altitude falls below this threshold. This limit is in place to optimize computational efficiency. It may be beneficial to consider lowering this limit for enhanced accuracy in the results.</p>
</section>
</section>
<div class="toctree-wrapper compound">
<span id="document-src/shadow/fast_voxel_traversal"></span><section class="tex2jax_ignore mathjax_ignore" id="fast-voxel-traversal-algorithm-for-ray-tracing">
<h2>Fast Voxel Traversal Algorithm for Ray Tracing<a class="headerlink" href="#fast-voxel-traversal-algorithm-for-ray-tracing" title="Permalink to this heading">#</a></h2>
<p>The calculate the ray tracing path through the voxel enviroment, the Fast Voxel Traversal Algorithm for Ray Tracing by <span id="id1">Amanatides and Woo [<a class="reference internal" href="src/introduction.html#id2" title="John Amanatides and Andrew Woo. A fast voxel traversal algorithm for ray tracing. Proceedings of EuroGraphics, 1987.">1</a>]</span> was used. This important paper presents an efficient algorithm for traversing voxels (3D pixels) in a grid during the ray tracing process. Ray tracing is a rendering technique widely used in computer graphics to simulate the way light interacts with objects in a scene. For the shadow flickering calculations, it is used to predict, where the induvidual rays will intersect with the terrain, and thus estimating which area will be affected by the shadow cast by the turbines.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">voxel_traversal</span><span class="p">,</span> <span class="n">print_code</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The traversal algorithm is divided into two phases: initialization and incremental traversal. In the initialization phase, the algorithm begins by locating the voxel containing the ray’s origin. If the ray’s origin is outside the grid, the entry point where the ray intersects the grid is determined, and that voxel becomes the starting point. The current voxel index is then set to the coordinates of the starting voxel. Additionally, the “step” variable is initialized to either 1 or -1, indicating whether the ray increments or decrements as it crosses voxel boundaries. This determination is made based on the sign of the x, y, and z components of the ray direction.</p>
<p>Next, the algorithm calculates the value of t at which the ray crosses the first vertical voxel boundary and stores it in the variable tMax. The minimum of these three values (x, y, and z) indicates the maximum distance the ray can travel while remaining in the current voxel. Finally, the algorithm computes tDelta, representing how far along the ray it must move (in units of t) for the horizontal component of the movement to equal the width of a voxel.</p>
<p>In the incremental phase of the traversal algorithm, the process is straightforward. The algorithm loops until it encounters a voxel with a boolean value equal to True (indicating a terrain collision) or until it falls out of the end of the grid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">voxel_traversal</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">voxel_traversal</span><span style="color: #d0d0d0">(origin,</span> <span style="color: #d0d0d0">direction,</span> <span style="color: #d0d0d0">grid3D,</span> <span style="color: #d0d0d0">verbose=</span><span style="color: #6ebf26; font-weight: bold">False</span><span style="color: #d0d0d0">):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #d0d0d0">boxSize</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;maxBound&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;minBound&#39;</span><span style="color: #d0d0d0">]</span>
<a id="True-3" name="True-3" href="#True-3"></a>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">cur_vox</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.floor(((origin</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;minBound&#39;</span><span style="color: #d0d0d0">])</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">boxSize)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&quot;n&quot;</span><span style="color: #d0d0d0">])</span>
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #d0d0d0">visited_vox</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[]</span>
<a id="True-6" name="True-6" href="#True-6"></a>    <span style="color: #d0d0d0">step</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.ones(</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">)</span>
<a id="True-7" name="True-7" href="#True-7"></a>    <span style="color: #d0d0d0">tVoxel</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.empty(</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">)</span>
<a id="True-8" name="True-8" href="#True-8"></a>
<a id="True-9" name="True-9" href="#True-9"></a>    <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">direction[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&gt;=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">:</span>
<a id="True-10" name="True-10" href="#True-10"></a>      <span style="color: #d0d0d0">tVoxel[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(cur_vox[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">][</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span>
<a id="True-11" name="True-11" href="#True-11"></a>    <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-12" name="True-12" href="#True-12"></a>      <span style="color: #d0d0d0">tVoxel[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]/</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">][</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span>
<a id="True-13" name="True-13" href="#True-13"></a>      <span style="color: #d0d0d0">step[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">-</span><span style="color: #51b2fd">1</span>
<a id="True-14" name="True-14" href="#True-14"></a>    
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">direction[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&gt;=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">:</span>
<a id="True-16" name="True-16" href="#True-16"></a>      <span style="color: #d0d0d0">tVoxel[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]=</span> <span style="color: #d0d0d0">(cur_vox[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">][</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span>
<a id="True-17" name="True-17" href="#True-17"></a>    <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-18" name="True-18" href="#True-18"></a>      <span style="color: #d0d0d0">tVoxel[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">][</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span>
<a id="True-19" name="True-19" href="#True-19"></a>      <span style="color: #d0d0d0">step[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">-</span><span style="color: #51b2fd">1</span>
<a id="True-20" name="True-20" href="#True-20"></a>    
<a id="True-21" name="True-21" href="#True-21"></a>    <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">direction[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&gt;=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">:</span>
<a id="True-22" name="True-22" href="#True-22"></a>      <span style="color: #d0d0d0">tVoxel[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(cur_vox[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">][</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span>
<a id="True-23" name="True-23" href="#True-23"></a>    <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-24" name="True-24" href="#True-24"></a>      <span style="color: #d0d0d0">tVoxel[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">][</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span>
<a id="True-25" name="True-25" href="#True-25"></a>      <span style="color: #d0d0d0">step[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">-</span><span style="color: #51b2fd">1</span>
<a id="True-26" name="True-26" href="#True-26"></a>
<a id="True-27" name="True-27" href="#True-27"></a>    <span style="color: #d0d0d0">voxelMax</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;minBound&#39;</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">tVoxel*boxSize</span>
<a id="True-28" name="True-28" href="#True-28"></a>    <span style="color: #d0d0d0">tMax</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(voxelMax</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">origin)</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">direction</span>
<a id="True-29" name="True-29" href="#True-29"></a>    <span style="color: #d0d0d0">voxelSize</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">boxSize</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">]</span>
<a id="True-30" name="True-30" href="#True-30"></a>    <span style="color: #d0d0d0">tDelta</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">voxelSize</span> <span style="color: #d0d0d0">/</span> <span style="color: #2fbccd">abs</span><span style="color: #d0d0d0">(direction)</span>
<a id="True-31" name="True-31" href="#True-31"></a>    <span style="color: #d0d0d0">visited_vox.append(cur_vox.copy())</span>
<a id="True-32" name="True-32" href="#True-32"></a>    <span style="color: #6ebf26; font-weight: bold">while</span> <span style="color: #d0d0d0">(cur_vox[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">][</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])</span> <span style="color: #6ebf26; font-weight: bold">and</span> <span style="color: #d0d0d0">(cur_vox[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&gt;=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">)</span> <span style="color: #6ebf26; font-weight: bold">and</span> <span style="color: #d0d0d0">(cur_vox[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">][</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">])</span> <span style="color: #6ebf26; font-weight: bold">and</span> <span style="color: #d0d0d0">(cur_vox[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&gt;=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">)</span> <span style="color: #6ebf26; font-weight: bold">and</span> <span style="color: #d0d0d0">(cur_vox[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">grid3D[</span><span style="color: #ed9d13">&#39;n&#39;</span><span style="color: #d0d0d0">][</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">])</span> <span style="color: #6ebf26; font-weight: bold">and</span> <span style="color: #d0d0d0">(cur_vox[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&gt;=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">):</span>
<a id="True-33" name="True-33" href="#True-33"></a>      <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">verbose:</span>
<a id="True-34" name="True-34" href="#True-34"></a>        <span style="color: #2fbccd">print</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">f&#39;Intersection: voxel = ({</span><span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}, {</span><span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">}, {</span><span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span><span style="color: #ed9d13">})&#39;</span><span style="color: #d0d0d0">)</span>
<a id="True-35" name="True-35" href="#True-35"></a>
<a id="True-36" name="True-36" href="#True-36"></a>      <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]:</span>
<a id="True-37" name="True-37" href="#True-37"></a>        <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]:</span>
<a id="True-38" name="True-38" href="#True-38"></a>          <span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">step[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span>
<a id="True-39" name="True-39" href="#True-39"></a>          <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">tDelta[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span>
<a id="True-40" name="True-40" href="#True-40"></a>        <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-41" name="True-41" href="#True-41"></a>          <span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">step[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span>
<a id="True-42" name="True-42" href="#True-42"></a>          <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">tDelta[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span>
<a id="True-43" name="True-43" href="#True-43"></a>      <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-44" name="True-44" href="#True-44"></a>        <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">&lt;</span> <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]:</span>
<a id="True-45" name="True-45" href="#True-45"></a>          <span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">step[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span>
<a id="True-46" name="True-46" href="#True-46"></a>          <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">tDelta[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]</span>
<a id="True-47" name="True-47" href="#True-47"></a>        <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-48" name="True-48" href="#True-48"></a>          <span style="color: #d0d0d0">cur_vox[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">step[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span>
<a id="True-49" name="True-49" href="#True-49"></a>          <span style="color: #d0d0d0">tMax[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">tDelta[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span>
<a id="True-50" name="True-50" href="#True-50"></a>      <span style="color: #d0d0d0">visited_vox.append(cur_vox.copy())</span>
<a id="True-51" name="True-51" href="#True-51"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">visited_vox</span>
</pre></div>
</div></div>
</div>
<p>In the following test, the code is evaluated using a specified starting origin, direction, and boundaries. The function is configured to be verbose, printing the index of each intersected voxel during the process.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.5</span><span class="p">,</span> <span class="mf">5.4</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">])</span>
<span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">])</span>
<span class="n">grid3D</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;minBound&quot;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
          <span class="s2">&quot;maxBound&quot;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">]),</span>
        <span class="s2">&quot;n&quot;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">])}</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">voxel_traversal</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">grid3D</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intersection: voxel = (5.0, 5.0, 13.0)
Intersection: voxel = (5.0, 5.0, 12.0)
Intersection: voxel = (5.0, 5.0, 11.0)
Intersection: voxel = (5.0, 4.0, 11.0)
Intersection: voxel = (5.0, 4.0, 10.0)
Intersection: voxel = (4.0, 4.0, 10.0)
Intersection: voxel = (4.0, 4.0, 9.0)
Intersection: voxel = (4.0, 4.0, 8.0)
Intersection: voxel = (4.0, 4.0, 7.0)
Intersection: voxel = (4.0, 3.0, 7.0)
Intersection: voxel = (4.0, 3.0, 6.0)
Intersection: voxel = (3.0, 3.0, 6.0)
Intersection: voxel = (3.0, 3.0, 5.0)
Intersection: voxel = (3.0, 3.0, 4.0)
Intersection: voxel = (3.0, 3.0, 3.0)
Intersection: voxel = (3.0, 2.0, 3.0)
Intersection: voxel = (3.0, 2.0, 2.0)
Intersection: voxel = (2.0, 2.0, 2.0)
Intersection: voxel = (2.0, 2.0, 1.0)
Intersection: voxel = (2.0, 2.0, 0.0)
</pre></div>
</div>
</div>
</div>
<p>By visualizing the voxel indices intersected by the <code class="docutils literal notranslate"><span class="pre">voxel_traversal</span></code> function and the ray as a 3D quiver plot, it can be demonstrated that all voxels touched by the quiver are accurately accounted for.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">grid3D</span><span class="p">[</span><span class="s2">&quot;maxBound&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">grid3D</span><span class="p">[</span><span class="s2">&quot;minBound&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">grid3D</span><span class="p">[</span><span class="s2">&quot;n&quot;</span><span class="p">]</span>
<span class="n">ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">x_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ids</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">y_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">z_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ids</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span>

<span class="n">x_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ids</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">y_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">z_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ids</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">x_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">y_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">y_min</span><span class="p">,</span> <span class="n">y_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">z_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">z_min</span><span class="p">,</span> <span class="n">z_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">,</span> <span class="n">z_range</span><span class="p">,</span>
                      <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>  <span class="c1"># define voxel grid</span>

<span class="n">voxel_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_range</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_range</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

<span class="n">voxel_array</span><span class="p">[</span><span class="n">ids</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">x_min</span><span class="p">,</span> <span class="n">ids</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">y_min</span><span class="p">,</span> <span class="n">ids</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">z_min</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">voxels</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">voxel_array</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Voxels&quot;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">origin</span><span class="o">-</span><span class="n">grid3D</span><span class="p">[</span><span class="s2">&quot;minBound&quot;</span><span class="p">])</span><span class="o">/</span><span class="n">scale</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">direction</span><span class="o">/</span><span class="n">scale</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Ray&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">aspect</span><span class="o">=</span><span class="s2">&quot;equal&quot;</span><span class="p">,</span>
       <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
       <span class="n">zlabel</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Ray Traversal in Voxel Environment&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c61d9f4fb5ae42ee45ec6a3a27097418935c199a96c989a8d7c8af0c3851d992.png" src="../_images/c61d9f4fb5ae42ee45ec6a3a27097418935c199a96c989a8d7c8af0c3851d992.png" />
</div>
</div>
</section>
<span id="document-src/shadow/sun_calc"></span><section class="tex2jax_ignore mathjax_ignore" id="solar-calculations">
<h2>Solar Calculations<a class="headerlink" href="#solar-calculations" title="Permalink to this heading">#</a></h2>
<p>In shadow flickering calculations, determining the sun’s path for a specified longitude and latitude is important for precise simulation of the shadow dynamics induced by wind turbines.</p>
<p>The altitude and azimuth positions of the sun fluctuate throughout the day and across seasons. Computing the sun’s path for a particular longitude and latitude allows us to model the dynamic sun positions over time, thereby capturing the temporal variations in shadow patterns.</p>
<p>The calculations presented in this chapter are based on the principles outlined in <span id="id1">Quae.nl [<a class="reference internal" href="src/introduction.html#id9" title="Quae.nl. Astronomy answers: position of the sun. 2021. URL: https://www.aa.quae.nl/en/reken/zonpositie.html (visited on 2023-11-27).">5</a>]</span>.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">print_code</span><span class="p">,</span> <span class="n">solar_angles_to_vector</span><span class="p">,</span> <span class="n">solar_position</span><span class="p">,</span> <span class="n">add_solar_axis</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">cartopy.io.img_tiles</span> <span class="kn">import</span> <span class="n">GoogleTiles</span>
<span class="kn">import</span> <span class="nn">cartopy.crs</span> <span class="k">as</span> <span class="nn">ccrs</span>
<span class="kn">from</span> <span class="nn">cartopy.mpl.gridliner</span> <span class="kn">import</span> <span class="n">LATITUDE_FORMATTER</span><span class="p">,</span> <span class="n">LONGITUDE_FORMATTER</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="calculate-azimuth-and-altitude-of-sun">
<h3>Calculate Azimuth and Altitude of Sun<a class="headerlink" href="#calculate-azimuth-and-altitude-of-sun" title="Permalink to this heading">#</a></h3>
<p>The key objective of solar calculations is to estimate the azimuth and altitude of the sun at a specified longitude, latitude, date, and time. The following code snippet achieves excactly this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">solar_position</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">solar_position</span><span style="color: #d0d0d0">(date,</span> <span style="color: #d0d0d0">lat,</span> <span style="color: #d0d0d0">lng):</span>
<a id="True-2" name="True-2" href="#True-2"></a><span style="color: #666666">    </span><span style="color: #ed9d13">&quot;&quot;&quot;</span>
<a id="True-3" name="True-3" href="#True-3"></a><span style="color: #ed9d13">    Calculate the azimuth and altitude of the sun for a given date, latitude and longitude.</span>
<a id="True-4" name="True-4" href="#True-4"></a>
<a id="True-5" name="True-5" href="#True-5"></a><span style="color: #ed9d13">    Parameters:</span>
<a id="True-6" name="True-6" href="#True-6"></a><span style="color: #ed9d13">    date (datetime): Date to calculate for</span>
<a id="True-7" name="True-7" href="#True-7"></a><span style="color: #ed9d13">    lat (float): Latitude in degrees</span>
<a id="True-8" name="True-8" href="#True-8"></a><span style="color: #ed9d13">    lng (float): Longitude in degrees</span>
<a id="True-9" name="True-9" href="#True-9"></a><span style="color: #ed9d13">    </span>
<a id="True-10" name="True-10" href="#True-10"></a><span style="color: #ed9d13">    Returns:</span>
<a id="True-11" name="True-11" href="#True-11"></a><span style="color: #ed9d13">    dict: Azimuth and altitude in radians</span>
<a id="True-12" name="True-12" href="#True-12"></a><span style="color: #ed9d13">    &quot;&quot;&quot;</span>
<a id="True-13" name="True-13" href="#True-13"></a>
<a id="True-14" name="True-14" href="#True-14"></a>    <span style="color: #ababab; font-style: italic"># Constants</span>
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #d0d0d0">rad</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.pi</span> <span style="color: #d0d0d0">/</span> <span style="color: #51b2fd">180</span>
<a id="True-16" name="True-16" href="#True-16"></a>    <span style="color: #d0d0d0">epochStart</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">datetime(</span><span style="color: #51b2fd">1970</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)</span> 
<a id="True-17" name="True-17" href="#True-17"></a>    <span style="color: #d0d0d0">J1970</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">2440588</span>
<a id="True-18" name="True-18" href="#True-18"></a>    <span style="color: #d0d0d0">J2000</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">2451545</span>
<a id="True-19" name="True-19" href="#True-19"></a>    <span style="color: #d0d0d0">dayMs</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">24</span> <span style="color: #d0d0d0">*</span> <span style="color: #51b2fd">60</span> <span style="color: #d0d0d0">*</span> <span style="color: #51b2fd">60</span> <span style="color: #d0d0d0">*</span> <span style="color: #51b2fd">1000</span>
<a id="True-20" name="True-20" href="#True-20"></a>    <span style="color: #d0d0d0">e</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #51b2fd">23.4397</span> <span style="color: #ababab; font-style: italic"># obliquity of the Earth</span>
<a id="True-21" name="True-21" href="#True-21"></a>
<a id="True-22" name="True-22" href="#True-22"></a>    <span style="color: #ababab; font-style: italic"># Convert date to required formats</span>
<a id="True-23" name="True-23" href="#True-23"></a>    <span style="color: #d0d0d0">ms</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(date</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">epochStart).total_seconds()</span> <span style="color: #d0d0d0">*</span> <span style="color: #51b2fd">1000</span>
<a id="True-24" name="True-24" href="#True-24"></a>    <span style="color: #d0d0d0">julian</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">ms</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">dayMs</span> <span style="color: #d0d0d0">-</span> <span style="color: #51b2fd">0.5</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">J1970</span> 
<a id="True-25" name="True-25" href="#True-25"></a>    <span style="color: #d0d0d0">days</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">julian</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">J2000</span>
<a id="True-26" name="True-26" href="#True-26"></a>
<a id="True-27" name="True-27" href="#True-27"></a>    <span style="color: #ababab; font-style: italic"># Calculate right ascension and declination</span>
<a id="True-28" name="True-28" href="#True-28"></a>    <span style="color: #d0d0d0">M</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">(</span><span style="color: #51b2fd">357.5291</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">0.98560028</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">days)</span> <span style="color: #ababab; font-style: italic"># Solar mean anomaly</span>
<a id="True-29" name="True-29" href="#True-29"></a>    <span style="color: #d0d0d0">C</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">(</span><span style="color: #51b2fd">1.9148</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.sin(M)</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">0.02</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.sin(</span><span style="color: #51b2fd">2</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">M)</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">0.0003</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.sin(</span><span style="color: #51b2fd">3</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">M))</span> <span style="color: #ababab; font-style: italic"># Equation of center</span>
<a id="True-30" name="True-30" href="#True-30"></a>    <span style="color: #d0d0d0">P</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #51b2fd">102.9372</span> <span style="color: #ababab; font-style: italic"># Perihelion of Earth</span>
<a id="True-31" name="True-31" href="#True-31"></a>    <span style="color: #d0d0d0">L</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">M</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">C</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">P</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">np.pi</span> <span style="color: #ababab; font-style: italic"># Ecliptic longitude</span>
<a id="True-32" name="True-32" href="#True-32"></a>    <span style="color: #d0d0d0">dec</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.arcsin(np.sin(</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(e)</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">np.cos(</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.sin(e)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.sin(L))</span> 
<a id="True-33" name="True-33" href="#True-33"></a>    <span style="color: #d0d0d0">ra</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.arctan2(np.sin(L)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(e),</span> <span style="color: #d0d0d0">np.cos(L))</span>
<a id="True-34" name="True-34" href="#True-34"></a>
<a id="True-35" name="True-35" href="#True-35"></a>    <span style="color: #ababab; font-style: italic"># Calculate sidereal time</span>
<a id="True-36" name="True-36" href="#True-36"></a>    <span style="color: #d0d0d0">lw</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">-lng</span>
<a id="True-37" name="True-37" href="#True-37"></a>    <span style="color: #d0d0d0">st</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">(</span><span style="color: #51b2fd">280.16</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">360.9856235</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">days)</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">lw</span>
<a id="True-38" name="True-38" href="#True-38"></a>
<a id="True-39" name="True-39" href="#True-39"></a>    <span style="color: #ababab; font-style: italic"># Calculate azimuth and altitude</span>
<a id="True-40" name="True-40" href="#True-40"></a>    <span style="color: #d0d0d0">H</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">st</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">ra</span>
<a id="True-41" name="True-41" href="#True-41"></a>    <span style="color: #d0d0d0">az</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.radians(</span><span style="color: #51b2fd">180</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">np.arctan2(np.sin(H),</span> <span style="color: #d0d0d0">np.cos(H)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.sin(rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">lat)</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">np.tan(dec)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">lat))</span>
<a id="True-42" name="True-42" href="#True-42"></a>    <span style="color: #d0d0d0">alt</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.arcsin(np.sin(rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">lat)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.sin(dec)</span> <span style="color: #d0d0d0">+</span> <span style="color: #d0d0d0">np.cos(rad</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">lat)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(dec)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(H))</span>
<a id="True-43" name="True-43" href="#True-43"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">az,</span> <span style="color: #d0d0d0">alt</span>
</pre></div>
</div></div>
</div>
<section id="test-of-script">
<h4>Test of Script<a class="headerlink" href="#test-of-script" title="Permalink to this heading">#</a></h4>
<p>Here is a brief test of the script, where the azimuth and altitude of the sun are determined in Copenhagen on the 6th of June at 12 o’clock.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2023</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">lat</span> <span class="o">=</span> <span class="mf">55.692858003050134</span> <span class="c1"># Copenhagen</span>
<span class="n">lng</span> <span class="o">=</span> <span class="mf">12.599278148554639</span>

<span class="n">az</span><span class="p">,</span> <span class="n">alt</span> <span class="o">=</span> <span class="n">solar_position</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lng</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Azimuth: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">az</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> degrees&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Altitude: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">alt</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> degrees&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Azimuth: 200.86 degrees
Altitude: 56.33 degrees
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="convertion-to-unit-vector">
<h3>Convertion to Unit Vector<a class="headerlink" href="#convertion-to-unit-vector" title="Permalink to this heading">#</a></h3>
<p>Thereafter, the altitude and azimuth position of the sun is converted into a unit vector, such that it can be used by the ray tracing algorithm.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">solar_angles_to_vector</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">solar_angles_to_vector</span><span style="color: #d0d0d0">(azimuth,</span> <span style="color: #d0d0d0">altitude):</span>
<a id="True-2" name="True-2" href="#True-2"></a><span style="color: #666666">    </span><span style="color: #ed9d13">&quot;&quot;&quot;</span>
<a id="True-3" name="True-3" href="#True-3"></a><span style="color: #ed9d13">    Convert solar azimuth and altitude angles to a 3D vector</span>
<a id="True-4" name="True-4" href="#True-4"></a>
<a id="True-5" name="True-5" href="#True-5"></a><span style="color: #ed9d13">    Args:</span>
<a id="True-6" name="True-6" href="#True-6"></a><span style="color: #ed9d13">        azimuth (float): Solar azimuth angle in radians</span>
<a id="True-7" name="True-7" href="#True-7"></a><span style="color: #ed9d13">        altitude (float): Solar altitude angle in radians</span>
<a id="True-8" name="True-8" href="#True-8"></a>
<a id="True-9" name="True-9" href="#True-9"></a><span style="color: #ed9d13">    Returns:</span>
<a id="True-10" name="True-10" href="#True-10"></a><span style="color: #ed9d13">        vec (np.ndarray): Normalized 3D vector representing sun direction from origin</span>
<a id="True-11" name="True-11" href="#True-11"></a><span style="color: #ed9d13">    &quot;&quot;&quot;</span>
<a id="True-12" name="True-12" href="#True-12"></a>    <span style="color: #d0d0d0">azimuth</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">azimuth+np.pi/</span><span style="color: #51b2fd">2</span>
<a id="True-13" name="True-13" href="#True-13"></a>
<a id="True-14" name="True-14" href="#True-14"></a>    <span style="color: #ababab; font-style: italic"># Calculate 3D vector components</span>
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #d0d0d0">x</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">-np.cos(azimuth)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(altitude)</span>
<a id="True-16" name="True-16" href="#True-16"></a>    <span style="color: #d0d0d0">y</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.sin(azimuth)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(altitude)</span>
<a id="True-17" name="True-17" href="#True-17"></a>    <span style="color: #d0d0d0">z</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.sin(altitude)</span>
<a id="True-18" name="True-18" href="#True-18"></a>
<a id="True-19" name="True-19" href="#True-19"></a>    <span style="color: #ababab; font-style: italic"># Normalize to unit vector</span>
<a id="True-20" name="True-20" href="#True-20"></a>    <span style="color: #d0d0d0">vec</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.array([x,</span> <span style="color: #d0d0d0">y,</span> <span style="color: #d0d0d0">z])</span>
<a id="True-21" name="True-21" href="#True-21"></a>    <span style="color: #d0d0d0">vec</span> <span style="color: #d0d0d0">/=</span> <span style="color: #d0d0d0">np.linalg.norm(vec)</span>
<a id="True-22" name="True-22" href="#True-22"></a>
<a id="True-23" name="True-23" href="#True-23"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">vec</span>
</pre></div>
</div></div>
</div>
<section id="id2">
<h4>Test of Script<a class="headerlink" href="#id2" title="Permalink to this heading">#</a></h4>
<p>Below a small test of the script can be found. Note that the vector defines the direction vector from the ground towards the sun.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vec</span> <span class="o">=</span> <span class="n">solar_angles_to_vector</span><span class="p">(</span><span class="mi">135</span><span class="p">,</span> <span class="mi">179</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Components of unit vector:</span><span class="se">\n</span><span class="s2">X: </span><span class="si">{</span><span class="n">vec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Y: </span><span class="si">{</span><span class="n">vec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">Z: </span><span class="si">{</span><span class="n">vec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Components of unit vector:
X: -0.09
Y: 0.99
Z: 0.07
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="solar-analemma">
<h3>Solar Analemma<a class="headerlink" href="#solar-analemma" title="Permalink to this heading">#</a></h3>
<p>An analemma is a figure-eight curve that illustrates the Sun’s changing position at the same time each day throughout the year. This curve can be generated by plotting the Sun’s location from a fixed spot on Earth daily or by graphing its declination against time. The size and shape of the analemma are influenced by the observer’s position, providing a visual representation of the Sun’s varying position throughout the year.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2023-01-01 12:00:00&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2023-12-31 12:00:00&#39;</span>
<span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;W&quot;</span><span class="p">)</span>
<span class="n">sun_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">date_range</span><span class="p">),</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Solar Analemma&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">date_range</span><span class="p">):</span>
    <span class="n">az</span><span class="p">,</span> <span class="n">alt</span> <span class="o">=</span> <span class="n">solar_position</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lng</span><span class="p">)</span>
    <span class="n">sun_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">az</span><span class="p">,</span> <span class="n">alt</span>

<span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">sun_pos</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">date_range</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%U&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scat</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s1">&#39;Week of Year&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Azimuth [deg]&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Altitude [deg]&quot;</span><span class="p">,</span>
       <span class="n">aspect</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b9b8e1e4dd779da95b8e19c805fabaa458e79ceb57adc266f6360ebe8eaa5820.png" src="../_images/b9b8e1e4dd779da95b8e19c805fabaa458e79ceb57adc266f6360ebe8eaa5820.png" />
</div>
</div>
</section>
<section id="position-of-the-sun-throughout-the-day">
<h3>Position of the sun throughout the day<a class="headerlink" href="#position-of-the-sun-throughout-the-day" title="Permalink to this heading">#</a></h3>
<p>Using the previously displayed functions, the path of the sun throughout the day can be mapped you as below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2023-06-15 00:00:00&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2023-06-15 23:59:59&#39;</span>
<span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;min&quot;</span><span class="p">)</span>
<span class="n">sun_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">date_range</span><span class="p">),</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">sun_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">date_range</span><span class="p">),</span> <span class="mi">3</span><span class="p">])</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">date_range</span><span class="p">):</span>
    <span class="n">az</span><span class="p">,</span> <span class="n">alt</span> <span class="o">=</span> <span class="n">solar_position</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lng</span><span class="p">)</span>
    <span class="n">sun_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">az</span><span class="p">,</span> <span class="n">alt</span>
    <span class="n">sun_vec</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">solar_angles_to_vector</span><span class="p">((</span><span class="n">az</span><span class="p">),</span> <span class="p">(</span><span class="n">alt</span><span class="p">))</span>

<span class="n">hours_of_day</span> <span class="o">=</span> <span class="n">date_range</span><span class="o">.</span><span class="n">hour</span> <span class="o">+</span> <span class="n">date_range</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mi">60</span>
<span class="n">scat</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">sun_pos</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">hours_of_day</span><span class="p">)</span>
<span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">scat</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Hour of the Day&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Azimuth [deg]&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Altitude [deg]&quot;</span><span class="p">,</span>
       <span class="n">aspect</span> <span class="o">=</span> <span class="s2">&quot;auto&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/a29c4c3c73102fbe861e24076f2b7cdd4618589fdf8c80dcf0402cf49e7af933.png" src="../_images/a29c4c3c73102fbe861e24076f2b7cdd4618589fdf8c80dcf0402cf49e7af933.png" />
</div>
</div>
<p>Alternatively, the information can also be displayed using two plots as seen below:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plots for solar zenith and solar azimuth angles</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Solar Position&#39;</span><span class="p">)</span>

<span class="c1"># plot for solar zenith angle</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">date_range</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">sun_pos</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Solar azimuth angle (degree)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (hour)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%H&#39;</span><span class="p">))</span>

<span class="c1"># plot for solar azimuth angle</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">date_range</span><span class="p">,</span>  <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">sun_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Solar altitude angle (degree)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Time (hour)&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mdates</span><span class="o">.</span><span class="n">DateFormatter</span><span class="p">(</span><span class="s1">&#39;%H&#39;</span><span class="p">))</span>

<span class="p">[</span><span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axs</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5b4e1f71fd06531961cdadd561ba414f5fdc9df4d7bffbd89ac9ff08f0a1940d.png" src="../_images/5b4e1f71fd06531961cdadd561ba414f5fdc9df4d7bffbd89ac9ff08f0a1940d.png" />
</div>
</div>
</section>
<section id="sun-path-on-a-polar-graph">
<h3>Sun path on a polar graph<a class="headerlink" href="#sun-path-on-a-polar-graph" title="Permalink to this heading">#</a></h3>
<p>Finally, utilizing the functions to showcase the sun path on a polar graph provides a clear visualization of the solar trajectory throughout the day and across seasons. This proves to be an effective tool for comprehending solar dynamics in various geographic locations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">positive_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sun_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">if</span> <span class="n">positive_indices</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">first_azimuth</span><span class="p">,</span> <span class="n">last_azimuth</span> <span class="o">=</span> <span class="n">sun_pos</span><span class="p">[</span><span class="n">positive_indices</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># Create a unit circle</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">circle_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)])</span>
<span class="n">sunrise_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">first_azimuth</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">first_azimuth</span><span class="p">)]])</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">circle_coords</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Horizon&quot;</span><span class="p">)</span> <span class="c1"># circle</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">first_azimuth</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">first_azimuth</span><span class="p">)],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Sunrise: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">first_azimuth</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">°&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">last_azimuth</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">last_azimuth</span><span class="p">)],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Sunset: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">last_azimuth</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">°&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sun_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">][</span><span class="n">sun_vec</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sun_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">][</span><span class="n">sun_vec</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;g-&quot;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Path of Sun (Day)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Solar Position&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/e44433eadea5393068ee8d8b01cf22b313d2ba433cafa315444fc95c266edab1.png" src="../_images/e44433eadea5393068ee8d8b01cf22b313d2ba433cafa315444fc95c266edab1.png" />
</div>
</div>
<p>Furthermore, this solar position can when be plotted on a map.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">proj</span> <span class="o">=</span> <span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">()</span>
<span class="n">size</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="c1"># size of map radius</span>
<span class="n">extent</span> <span class="o">=</span> <span class="p">[</span><span class="n">lng</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">lng</span> <span class="o">+</span> <span class="n">size</span><span class="p">,</span> <span class="n">lat</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">lat</span> <span class="o">+</span> <span class="n">size</span><span class="p">]</span><span class="c1"># Specify the map extent (latitude and longitude bounds)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;projection&#39;</span><span class="p">:</span> <span class="n">proj</span><span class="p">},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_extent</span><span class="p">(</span><span class="n">extent</span><span class="p">,</span> <span class="n">crs</span><span class="o">=</span><span class="n">proj</span><span class="p">)</span>
<span class="n">imagery</span> <span class="o">=</span> <span class="n">GoogleTiles</span><span class="p">(</span><span class="n">style</span> <span class="o">=</span> <span class="s2">&quot;satellite&quot;</span><span class="p">)</span> <span class="c1"># Valid styles: street, satellite, terrain, only_streets</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_image</span><span class="p">(</span><span class="n">imagery</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span> <span class="c1"># 16</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Longitude&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Latitude&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Solar Position for Longitude: </span><span class="si">{</span><span class="n">lng</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, Latitude: </span><span class="si">{</span><span class="n">lat</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> and Date: &quot;</span> <span class="o">+</span> <span class="n">start_date</span><span class="p">[:</span><span class="mi">10</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">add_solar_axis</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">circle_coords</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span> <span class="c1"># circle</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">first_azimuth</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">first_azimuth</span><span class="p">)],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Sunrise: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">first_azimuth</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">°&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">last_azimuth</span><span class="p">)],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">last_azimuth</span><span class="p">)],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Sunset: </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">last_azimuth</span><span class="p">)</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">°&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sun_vec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sun_vec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Path of Sun&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span> <span class="o">=</span> <span class="s2">&quot;upper left&quot;</span><span class="p">)</span>

<span class="n">gl</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">gridlines</span><span class="p">(</span><span class="n">crs</span><span class="o">=</span><span class="n">ccrs</span><span class="o">.</span><span class="n">PlateCarree</span><span class="p">(),</span> <span class="n">draw_labels</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">gl</span><span class="o">.</span><span class="n">top_labels</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">right_labels</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">gl</span><span class="o">.</span><span class="n">xformatter</span> <span class="o">=</span> <span class="n">LONGITUDE_FORMATTER</span>
<span class="n">gl</span><span class="o">.</span><span class="n">yformatter</span> <span class="o">=</span> <span class="n">LATITUDE_FORMATTER</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/c33ffcbef002a6b4de512b426cd4d979f8f3ea245525b3a2fbef476498d944f9.png" src="../_images/c33ffcbef002a6b4de512b426cd4d979f8f3ea245525b3a2fbef476498d944f9.png" />
</div>
</div>
</section>
</section>
<span id="document-src/shadow/rotor_point_cloud"></span><section class="tex2jax_ignore mathjax_ignore" id="rotor-point-cloud">
<h2>Rotor Point Cloud<a class="headerlink" href="#rotor-point-cloud" title="Permalink to this heading">#</a></h2>
<p>In the context of the shadow mapping simulation, the points constituting the turbine rotor disc are employed to accurately represent its geometry. Positioned strategically, these points serve as the origins for rays projected from the sun to the ground, effectively modeling the complete rotor disc. This arrangement enables a good approximation of shadow dynamics. This section provides insights into the calculation process of the rotor point cloud.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">print_code</span><span class="p">,</span> <span class="n">rotor_point_spacing</span><span class="p">,</span> <span class="n">generate_turbine</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="point-spacing">
<h3>Point Spacing<a class="headerlink" href="#point-spacing" title="Permalink to this heading">#</a></h3>
<p>To approximate the rotor disc, firstly, a distribution of points is made across the entire rotor disc. This is done with the two following functions:</p>
<p>The first function, <code class="docutils literal notranslate"><span class="pre">rotor_point_spacing</span></code>, calculates the spacing of points within the rotor disc of a wind turbine. It adjusts the vertical grid element size based on the rotor angle, determines the grid resolution, and computes the number of points needed for each radius within the rotor disc. The function then generates lists of radii (r_list) and corresponding numbers of points per radius (n_list) based on the calculated grid resolution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">rotor_point_spacing</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">rotor_point_spacing</span><span style="color: #d0d0d0">(diameter,</span> <span style="color: #d0d0d0">grid_element_size,</span> <span style="color: #d0d0d0">angle):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #d0d0d0">grid_element_size[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">grid_element_size[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.tan(angle)</span>
<a id="True-3" name="True-3" href="#True-3"></a>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">grid_resolution</span> <span style="color: #d0d0d0">=</span> <span style="color: #2fbccd">min</span><span style="color: #d0d0d0">(grid_element_size[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">grid_element_size[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]**</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">*np.abs(np.tan(angle)))</span>
<a id="True-5" name="True-5" href="#True-5"></a>
<a id="True-6" name="True-6" href="#True-6"></a>    <span style="color: #d0d0d0">n_radius</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.ceil(diameter/(grid_resolution)).astype(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">)</span>
<a id="True-7" name="True-7" href="#True-7"></a>    <span style="color: #d0d0d0">r_list</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.linspace(</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">diameter/</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">n_radius)</span>
<a id="True-8" name="True-8" href="#True-8"></a>    
<a id="True-9" name="True-9" href="#True-9"></a>    <span style="color: #d0d0d0">n_list</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.ones(r_list.shape)</span>
<a id="True-10" name="True-10" href="#True-10"></a>    
<a id="True-11" name="True-11" href="#True-11"></a>    <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">i</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #d0d0d0">np.arange(</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">,</span> <span style="color: #2fbccd">len</span><span style="color: #d0d0d0">(n_list)):</span>
<a id="True-12" name="True-12" href="#True-12"></a>        <span style="color: #d0d0d0">points_per_radius</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.ceil(</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">*r_list[i]*np.pi/grid_resolution).astype(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">)</span>
<a id="True-13" name="True-13" href="#True-13"></a>        <span style="color: #d0d0d0">n_list[i]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">points_per_radius</span>
<a id="True-14" name="True-14" href="#True-14"></a>    
<a id="True-15" name="True-15" href="#True-15"></a>
<a id="True-16" name="True-16" href="#True-16"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">r_list,</span> <span style="color: #d0d0d0">n_list</span>
</pre></div>
</div></div>
</div>
<p>The second function, <code class="docutils literal notranslate"><span class="pre">generate_turbine</span></code>, uses the information obtained from the first function to create a 3D point cloud representing the wind turbine’s rotor disc. It considers the specified number of points along the radial and angular dimensions, the orientation of the turbine, and its coordinates. The function iterates through each radius and angle, calculating the relative Cartesian coordinates of each point within the rotor disc, and adjusts the coordinates based on the turbine’s overall position. The resulting 3D point cloud captures the spatial distribution of points within the wind turbine’s rotor disc.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">generate_turbine</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">generate_turbine</span><span style="color: #d0d0d0">(r_list,</span> <span style="color: #d0d0d0">n_angle,</span> <span style="color: #d0d0d0">n_vector,</span> <span style="color: #d0d0d0">turbine_cord):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">iteration</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">0</span>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">rotor_angle</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.arctan(n_vector[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]/n_vector[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">])+np.pi/</span><span style="color: #51b2fd">2</span>
<a id="True-5" name="True-5" href="#True-5"></a>    
<a id="True-6" name="True-6" href="#True-6"></a>    <span style="color: #d0d0d0">points</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.zeros([</span><span style="color: #2fbccd">sum</span><span style="color: #d0d0d0">(n_angle).astype(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">),</span><span style="color: #51b2fd">3</span><span style="color: #d0d0d0">])</span> <span style="color: #ababab; font-style: italic"># initiate result point (1 extra for center point)</span>
<a id="True-7" name="True-7" href="#True-7"></a>    
<a id="True-8" name="True-8" href="#True-8"></a>    <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">i,</span> <span style="color: #d0d0d0">r</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #2fbccd">enumerate</span><span style="color: #d0d0d0">(r_list):</span>
<a id="True-9" name="True-9" href="#True-9"></a>        <span style="color: #d0d0d0">angle_list</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.linspace(</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">2</span><span style="color: #d0d0d0">*np.pi*(</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">-</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">/n_angle[i]),</span> <span style="color: #d0d0d0">n_angle[i].astype(</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">))</span>
<a id="True-10" name="True-10" href="#True-10"></a>        <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">j,</span> <span style="color: #d0d0d0">angle</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #2fbccd">enumerate</span><span style="color: #d0d0d0">(angle_list):</span>
<a id="True-11" name="True-11" href="#True-11"></a>            <span style="color: #d0d0d0">x_rel</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">r</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(angle)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(rotor_angle)</span>
<a id="True-12" name="True-12" href="#True-12"></a>            <span style="color: #d0d0d0">y_rel</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">r</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.cos(angle)</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.sin(rotor_angle)</span>
<a id="True-13" name="True-13" href="#True-13"></a>            <span style="color: #d0d0d0">z_rel</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">r</span> <span style="color: #d0d0d0">*</span> <span style="color: #d0d0d0">np.sin(angle)</span>
<a id="True-14" name="True-14" href="#True-14"></a>            
<a id="True-15" name="True-15" href="#True-15"></a>            <span style="color: #d0d0d0">points[iteration,:]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.array([x_rel,</span> <span style="color: #d0d0d0">y_rel,</span> <span style="color: #d0d0d0">z_rel])</span>
<a id="True-16" name="True-16" href="#True-16"></a>            
<a id="True-17" name="True-17" href="#True-17"></a>            <span style="color: #d0d0d0">iteration</span> <span style="color: #d0d0d0">+=</span> <span style="color: #51b2fd">1</span>
<a id="True-18" name="True-18" href="#True-18"></a>    <span style="color: #d0d0d0">points</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">turbine_cord</span>
<a id="True-19" name="True-19" href="#True-19"></a>
<a id="True-20" name="True-20" href="#True-20"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">points</span>
</pre></div>
</div></div>
</div>
<p>Given a set of input parameters, the rotor points can be calculated:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">diameter</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">grid_element_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="nb">float</span><span class="p">)</span>
<span class="n">n_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="n">turbine_cord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
<span class="n">r_list</span><span class="p">,</span> <span class="n">n_angle</span> <span class="o">=</span> <span class="n">rotor_point_spacing</span><span class="p">(</span><span class="n">diameter</span><span class="p">,</span> <span class="n">grid_element_size</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">generate_turbine</span><span class="p">(</span><span class="n">r_list</span><span class="p">,</span> <span class="n">n_angle</span><span class="p">,</span> <span class="n">n_vector</span><span class="p">,</span> <span class="n">turbine_cord</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The points are thereafter displayed in a scatter plot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
       <span class="n">zlabel</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
       <span class="n">aspect</span> <span class="o">=</span> <span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;3D Turbine Points&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cd76afa6d00a8d044cb0bcd8de0b82927ba4d7db6dce1ccbb1cd2bedbc4539f5.png" src="../_images/cd76afa6d00a8d044cb0bcd8de0b82927ba4d7db6dce1ccbb1cd2bedbc4539f5.png" />
</div>
</div>
<section id="convertion-to-voxel-points">
<h4>Convertion to Voxel points<a class="headerlink" href="#convertion-to-voxel-points" title="Permalink to this heading">#</a></h4>
<p>The ray tracing algorithm operates within a voxel environment, requiring only a single ray origin for each voxel. Consequently, the algorithm identifies all the voxels in contact with the points in the rotor disc. The center of each individual voxel is then utilized as the new ray origin. Since the rays travel in parallel during each temporal iteration of the shadow map solving algorithm, any error introduced by this approximation should be negligible.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">voxel_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">points</span> <span class="o">/</span> <span class="n">grid_element_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">voxel_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">voxel_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">min_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">voxel_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># Find the minimum value along each column (axis=0)</span>
<span class="n">shifted_indices</span> <span class="o">=</span> <span class="n">voxel_indices</span> <span class="o">-</span> <span class="n">min_values</span> <span class="c1"># Add the absolute minimum value to shift all elements in each column</span>
<span class="n">grid_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">shifted_indices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># Define grid dimensions based on the shifted indices</span>
<span class="n">occupied_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">grid_dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span> <span class="c1"># Create an empty grid to represent the occupied voxels</span>
<span class="n">occupied_grid</span><span class="p">[</span><span class="n">shifted_indices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">shifted_indices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">shifted_indices</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Mark the occupied voxels in the grid</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">voxels</span><span class="p">(</span><span class="n">occupied_grid</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">azim</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
       <span class="n">zlabel</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;3D Turbine Voxels&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/7524f257d6fc855376b6e3e0a588eedd651b8bfb86f3dd69648bccb13bc8de00.png" src="../_images/7524f257d6fc855376b6e3e0a588eedd651b8bfb86f3dd69648bccb13bc8de00.png" />
</div>
</div>
<p>The original rotor disc points and the reduced voxel points can then be compared:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">turbine_points</span> <span class="o">=</span> <span class="p">(</span><span class="n">voxel_indices</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]))</span> <span class="o">*</span> <span class="n">grid_element_size</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">subplot_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;projection&quot;</span><span class="p">:</span> <span class="s2">&quot;3d&quot;</span><span class="p">},</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">turbine_points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Voxel Rotor Points&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">points</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Original Rotor Points&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span> <span class="s2">&quot;X&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span>
       <span class="n">zlabel</span> <span class="o">=</span> <span class="s2">&quot;Z&quot;</span><span class="p">,</span>
       <span class="n">aspect</span> <span class="o">=</span> <span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="n">azim</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;3D Turbine Points Comparison&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Percentage reduction in points: </span><span class="si">{</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">turbine_points</span><span class="p">))</span><span class="o">/</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/cc1a242354e56712a5c754b8b894fa43a7f4c95b2481bf89347842cdae310aa8.png" src="../_images/cc1a242354e56712a5c754b8b894fa43a7f4c95b2481bf89347842cdae310aa8.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Percentage reduction in points: 45.96%
</pre></div>
</div>
</div>
</div>
<p>Depending on the terrain resolution and turbine configuration, this optimization has the potential to reduce the computational time of the calculation by half.</p>
</section>
</section>
</section>
<span id="document-src/shadow/multiprocessing"></span><section class="tex2jax_ignore mathjax_ignore" id="multiprocessing">
<h2>Multiprocessing<a class="headerlink" href="#multiprocessing" title="Permalink to this heading">#</a></h2>
<p>To enhance the performance of the shadow map solver, multiprocessing has been implemented. Given the CPU-intensive nature of the task, multiprocessing is employed to distribute solar ray vectors (and consequently the datetime range) among multiple processes, allowing parallel execution. The extent of optimization naturally depends on the hardware specifications. However, on a moderately equipped laptop running 10 processes concurrently, a fourfold reduction in computational time can be anticipated.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">solar_angles_to_vector</span><span class="p">,</span> <span class="n">solar_position</span><span class="p">,</span> <span class="n">rotor_point_spacing</span><span class="p">,</span> <span class="n">generate_turbine</span><span class="p">,</span> <span class="n">generate_voxel_map</span><span class="p">,</span> <span class="n">print_code</span><span class="p">,</span> <span class="n">multiprocessing</span>
<span class="kn">from</span> <span class="nn">src.cython</span> <span class="kn">import</span> <span class="n">solve_shadow_map</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>The code operates by dividing the sun rays into n processes using <code class="docutils literal notranslate"><span class="pre">rays</span> <span class="pre">=</span> <span class="pre">sun_vec[process::processes]</span></code>. These processes are executed in parallel, and their results are subsequently combined to calculate the cumulative shadow flickering time.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">multiprocessing</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">multiprocessing</span><span style="color: #d0d0d0">(func,</span> <span style="color: #d0d0d0">points,</span> <span style="color: #d0d0d0">sun_vec,</span> <span style="color: #d0d0d0">minBound,</span> <span style="color: #d0d0d0">maxBound,</span> <span style="color: #d0d0d0">voxel_map,</span> <span style="color: #d0d0d0">processes):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #d0d0d0">pool</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">mp.Pool(processes=processes)</span>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">results</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[]</span>
<a id="True-4" name="True-4" href="#True-4"></a>    
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">process</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #2fbccd">range</span><span style="color: #d0d0d0">(processes):</span>
<a id="True-6" name="True-6" href="#True-6"></a>        <span style="color: #d0d0d0">rays</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">sun_vec[process::processes]</span>
<a id="True-7" name="True-7" href="#True-7"></a>        <span style="color: #d0d0d0">result</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">pool.apply_async(func,</span> <span style="color: #d0d0d0">args=(points,</span> <span style="color: #d0d0d0">rays,</span> <span style="color: #d0d0d0">minBound,</span> <span style="color: #d0d0d0">maxBound,</span> <span style="color: #d0d0d0">voxel_map))</span>
<a id="True-8" name="True-8" href="#True-8"></a>        <span style="color: #d0d0d0">results.append(result)</span>
<a id="True-9" name="True-9" href="#True-9"></a>    
<a id="True-10" name="True-10" href="#True-10"></a>    <span style="color: #d0d0d0">pool.close()</span>
<a id="True-11" name="True-11" href="#True-11"></a>    <span style="color: #d0d0d0">pool.join()</span>
<a id="True-12" name="True-12" href="#True-12"></a>    
<a id="True-13" name="True-13" href="#True-13"></a>    <span style="color: #d0d0d0">shadow_map</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.zeros(voxel_map.shape[:</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">])</span>
<a id="True-14" name="True-14" href="#True-14"></a>    
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">p,</span> <span style="color: #d0d0d0">result</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #2fbccd">enumerate</span><span style="color: #d0d0d0">(results):</span>
<a id="True-16" name="True-16" href="#True-16"></a>        <span style="color: #6ebf26; font-weight: bold">try</span><span style="color: #d0d0d0">:</span>
<a id="True-17" name="True-17" href="#True-17"></a>            <span style="color: #d0d0d0">temp_array</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">result.get()</span>
<a id="True-18" name="True-18" href="#True-18"></a>            <span style="color: #d0d0d0">shadow_map</span> <span style="color: #d0d0d0">+=</span> <span style="color: #d0d0d0">temp_array</span>
<a id="True-19" name="True-19" href="#True-19"></a>        <span style="color: #6ebf26; font-weight: bold">except</span> <span style="color: #bbbbbb">Exception</span> <span style="color: #6ebf26; font-weight: bold">as</span> <span style="color: #d0d0d0">e:</span>
<a id="True-20" name="True-20" href="#True-20"></a>            <span style="color: #2fbccd">print</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">f&quot;Error occurred for process {</span><span style="color: #d0d0d0">p</span><span style="color: #ed9d13">}: {</span><span style="color: #d0d0d0">e</span><span style="color: #ed9d13">}&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-21" name="True-21" href="#True-21"></a>    
<a id="True-22" name="True-22" href="#True-22"></a>    <span style="color: #d0d0d0">np.savetxt(Path.joinpath(ROOT_DIR,</span> <span style="color: #ed9d13">&quot;temp/shadow_map.txt&quot;</span><span style="color: #d0d0d0">),</span> <span style="color: #d0d0d0">shadow_map)</span>
<a id="True-23" name="True-23" href="#True-23"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">shadow_map</span>
</pre></div>
</div></div>
</div>
<section id="code-test">
<h3>Code test<a class="headerlink" href="#code-test" title="Permalink to this heading">#</a></h3>
<p>To test the code, a number of sun rays and rotor points are defined for a given time frame.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate sun ray vectors # </span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2023-01-01 00:00:00&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2023-12-30 23:59:59&#39;</span>
<span class="n">latitude</span> <span class="o">=</span> <span class="mi">55</span>
<span class="n">longitude</span> <span class="o">=</span> <span class="mi">12</span>
<span class="n">date_range</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;10min&quot;</span><span class="p">)</span>
<span class="n">sun_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">date_range</span><span class="p">),</span> <span class="mi">2</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">date</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">date_range</span><span class="p">):</span>
    <span class="n">az</span><span class="p">,</span> <span class="n">alt</span> <span class="o">=</span> <span class="n">solar_position</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">)</span>
    <span class="n">sun_pos</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">az</span><span class="p">,</span> <span class="n">alt</span>
<span class="n">sun_pos</span> <span class="o">=</span> <span class="n">sun_pos</span><span class="p">[</span><span class="n">sun_pos</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">5</span><span class="p">)]</span>
<span class="n">sun_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">sun_pos</span><span class="p">),</span> <span class="mi">3</span><span class="p">])</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pos</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sun_pos</span><span class="p">):</span>
    <span class="n">sun_vec</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">solar_angles_to_vector</span><span class="p">(</span><span class="o">*</span><span class="n">pos</span><span class="p">)</span>

<span class="c1"># Generate turbine points #</span>
<span class="n">diameter</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">n_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">turbine_cord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">4.302e6</span><span class="p">,</span> <span class="mf">3.666e6</span><span class="p">,</span> <span class="mi">230</span><span class="p">])</span>
<span class="n">grid_element_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>
<span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">45</span><span class="p">)</span>
<span class="n">r_list</span><span class="p">,</span> <span class="n">n_angle</span> <span class="o">=</span> <span class="n">rotor_point_spacing</span><span class="p">(</span><span class="n">diameter</span><span class="p">,</span> <span class="n">grid_element_size</span><span class="p">,</span> <span class="n">angle</span><span class="p">)</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">generate_turbine</span><span class="p">(</span><span class="n">r_list</span><span class="p">,</span> <span class="n">n_angle</span><span class="p">,</span> <span class="n">n_vector</span><span class="p">,</span> <span class="n">turbine_cord</span><span class="p">)</span>

<span class="c1"># Generate voxel map #</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">9.65</span><span class="p">,</span> <span class="mf">9.75</span><span class="p">,</span> <span class="mf">56.05</span><span class="p">,</span> <span class="mf">56.15</span><span class="p">])</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
<span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">voxel_map</span><span class="p">,</span> <span class="n">map_array</span> <span class="o">=</span> <span class="n">generate_voxel_map</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">shape</span><span class="p">)</span>

<span class="c1"># Solve #</span>
<span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">sun_vec</span> <span class="o">=</span> <span class="n">sun_vec</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">minBound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">map_array</span><span class="p">)],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">maxBound</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">map_array</span><span class="p">)],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="n">voxel_map</span> <span class="o">=</span> <span class="n">voxel_map</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The code can then be executed using the <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">processes</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">shadow_map</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">(</span><span class="n">solve_shadow_map</span><span class="o">.</span><span class="n">solve_shadow_map_cy</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">sun_vec</span><span class="p">,</span> <span class="n">minBound</span><span class="p">,</span> <span class="n">maxBound</span><span class="p">,</span> <span class="n">voxel_map</span><span class="p">,</span> <span class="n">processes</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The result is displayed using a contour plot below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ct</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">shadow_map</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;twilight&quot;</span><span class="p">,</span> <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Longitude&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;Latitude&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ray Tracing Collisions with Terrain&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/0e7ef3965452aca0eaf61186dfe7bd1a17e7f1f1e0c37a3ccba6141e0871173d.png" src="../_images/0e7ef3965452aca0eaf61186dfe7bd1a17e7f1f1e0c37a3ccba6141e0871173d.png" />
</div>
</div>
<p>As the shadow map results have not been normalized with the sampling rate of the sun ray calculation, the plot displays the amount of ray tracing collisions with the terrain and the to total amount of hours.</p>
</section>
</section>
</div>
</section>
<span id="document-src/visual/visual_impact"></span><section class="tex2jax_ignore mathjax_ignore" id="visual-impact-assesment">
<h1>Visual Impact Assesment<a class="headerlink" href="#visual-impact-assesment" title="Permalink to this heading">#</a></h1>
<p>As part of the Environmental Impact Assessment preceding the construction of a wind park, the visual impact of integrating the wind turbines into the landscape is assessed by simulating their placement in nearby images. To accurately represent the turbines, it is crucial that they are appropriately warped and scaled within the image, providing a proper understanding of their impact on the landscape. In this program, image data is retrieved from Google Street View through their API. Subsequently, the turbines are inserted into the image by converting a .obj file to an image and appropriately scaling it using a pinhole camera model.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">ElevationHandler</span><span class="p">,</span> <span class="n">visual_impact_assesment</span><span class="p">,</span> <span class="n">calc_extent</span><span class="p">,</span> <span class="n">import_point_source_data</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="test-of-function">
<h2>Test of function<a class="headerlink" href="#test-of-function" title="Permalink to this heading">#</a></h2>
<p>Here are three instances showcasing the code in action. It is versatile enough to accommodate either pre-existing .json files or directly utilize pandas dataframes as input.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">import_point_source_data</span><span class="p">(</span><span class="s2">&quot;Prøvestenen.json&quot;</span><span class="p">)</span> <span class="c1"># load wind park data</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span> <span class="c1"># resolution of map data (in pixels)</span>
<span class="n">dist</span> <span class="o">=</span> <span class="mi">3000</span> <span class="c1"># distance from turbines to the edge of the map (in meters)</span>
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">calc_extent</span><span class="p">(</span><span class="n">point_source_data</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span> <span class="c1"># calculate map boundaries (min/max longitude and latitude)</span>
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span> <span class="c1"># Initiate Elevation Handler (Takes care of the map downloads)</span>
<span class="n">camera_coord</span> <span class="o">=</span> <span class="p">[</span><span class="mf">12.633587898367413</span><span class="p">,</span> <span class="mf">55.6716853762531</span><span class="p">]</span> <span class="c1"># 55., 12.</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">60</span><span class="p">])</span> <span class="c1"># roll, tilt and yaw (tilt should be 0)</span>

<span class="n">visual_impact_assesment</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">camera_coord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">fov</span> <span class="o">=</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/b5faea4ef1a9a41e7608569b66499be64536d9bb8e0052e230834804fc873113.png" src="../_images/b5faea4ef1a9a41e7608569b66499be64536d9bb8e0052e230834804fc873113.png" />
</div>
</div>
<p>The figure above illustrates that, owing to minor inaccuracies in the calculation method—likely stemming from slight discrepancies in the Coordinate Reference Systems employed—the turbine positions do not precisely align with their real-world counterparts. Nevertheless, the scaling of the turbines is notably accurate, and their positions deviate by no more than a few meters, as evident in the depiction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">55.66533363371845</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">12.533636688214754</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
        <span class="s2">&quot;d&quot;</span> <span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s2">&quot;wind_dir&quot;</span> <span class="p">:</span> <span class="mi">220</span><span class="p">}])</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">dist</span> <span class="o">=</span> <span class="mi">1000</span> 
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">calc_extent</span><span class="p">(</span><span class="n">point_source_data</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span> 
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span> 
<span class="n">camera_coord</span> <span class="o">=</span> <span class="p">[</span><span class="mf">12.5321515</span><span class="p">,</span> <span class="mf">55.666176</span><span class="p">]</span> 
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">70</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span> <span class="c1"># roll, tilt and yaw (tilt should be 0)</span>

<span class="n">visual_impact_assesment</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">camera_coord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">fov</span> <span class="o">=</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/5bbf12e5117bf7b7e2466b42329e6766c930a78176da91a2d54ad1d0d8ab4808.png" src="../_images/5bbf12e5117bf7b7e2466b42329e6766c930a78176da91a2d54ad1d0d8ab4808.png" />
</div>
</div>
<p>In the depicted image, a single turbine is positioned within Pasteurs Tårn in Copenhagen, as an illustration of the program’s capability to handle the warping of the turbine object. As the turbine approaches the image border, a subtle stretching effect is expected. Additionally, observe the alignment of the turbine’s height (130 meters), which is nearly equivalent to that of Pasteurs Tårn (128 meters).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_source_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;latitude&quot;</span><span class="p">:</span> <span class="mf">46.569692885046436</span><span class="p">,</span>
        <span class="s2">&quot;longitude&quot;</span><span class="p">:</span> <span class="mf">9.965257138033463</span><span class="p">,</span>
        <span class="s2">&quot;h&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
        <span class="s2">&quot;d&quot;</span> <span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s2">&quot;wind_dir&quot;</span> <span class="p">:</span> <span class="mi">220</span><span class="p">}])</span>
<span class="n">map_shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">dist</span> <span class="o">=</span> <span class="mi">5000</span> 
<span class="n">map_boundaries</span> <span class="o">=</span> <span class="n">calc_extent</span><span class="p">(</span><span class="n">point_source_data</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span> 
<span class="n">elevation_handler</span> <span class="o">=</span> <span class="n">ElevationHandler</span><span class="p">(</span><span class="n">map_boundaries</span><span class="p">,</span> <span class="n">map_shape</span><span class="p">)</span> 
<span class="n">camera_coord</span> <span class="o">=</span> <span class="p">[</span><span class="mf">9.923683012770276</span><span class="p">,</span> <span class="mf">46.57725126807395</span><span class="p">]</span> 
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">70</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span> <span class="c1"># roll, tilt and yaw (tilt should be 0)</span>

<span class="n">visual_impact_assesment</span><span class="p">(</span><span class="n">elevation_handler</span><span class="p">,</span> <span class="n">point_source_data</span><span class="p">,</span> <span class="n">camera_coord</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">fov</span> <span class="o">=</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/df6519f82387a356e2d596836a4beb4c7f3ccfdcb2060a649006b0a51b702f11.png" src="../_images/df6519f82387a356e2d596836a4beb4c7f3ccfdcb2060a649006b0a51b702f11.png" />
</div>
</div>
<p>In the example above, the program demonstrates its elevation handling capabilities. The individual heights of both the camera and turbine are considered during the placement of the turbine within the image. Consequently, it is crucial that the <code class="docutils literal notranslate"><span class="pre">map_boundaries</span></code> of the <code class="docutils literal notranslate"><span class="pre">ElevationHandler</span></code> encompasses both the camera and turbine coordinates.</p>
</section>
<div class="toctree-wrapper compound">
<span id="document-src/visual/google_street_view"></span><section class="tex2jax_ignore mathjax_ignore" id="google-street-view">
<h2>Google Street View<a class="headerlink" href="#google-street-view" title="Permalink to this heading">#</a></h2>
<p>To produce the visual impact assessment, the program uses the Google Street View API to retrieve images from various locations worldwide. This method provides a quick and efficient way of obtaining images from important areas, eliminating the need to dispatch an person physically for photography. While the photo quality may be somewhat lacking, this approach serves as an effective initial strategy for evaluating the visual impact of an adjacent wind park.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">get_api_key</span><span class="p">,</span> <span class="n">pull_street_view_image</span><span class="p">,</span> <span class="n">print_code</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
</pre></div>
</div>
</div>
</details>
</div>
<section id="street-view-api">
<h3>Street View API<a class="headerlink" href="#street-view-api" title="Permalink to this heading">#</a></h3>
<p>To access to images, a Google Street View API key is needed. The program should automatically prompt the user for a key the first time to program is executed. Elsewise, the api key is loaded for the text document <code class="docutils literal notranslate"><span class="pre">/assest/api_key.txt</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">pull_street_view_image</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">pull_street_view_image</span><span style="color: #d0d0d0">(api_key,</span> <span style="color: #d0d0d0">longitude,</span> <span style="color: #d0d0d0">latitude,</span> <span style="color: #d0d0d0">fov</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">90</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">heading</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">pitch</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">90</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">width</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">800</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">height</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">800</span><span style="color: #d0d0d0">):</span>
<a id="True-2" name="True-2" href="#True-2"></a><span style="color: #ababab; font-style: italic"># URL of the image you want to load</span>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">pitch</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">90</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">pitch</span> <span style="color: #ababab; font-style: italic"># correct for reference frame</span>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">image_url</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">f&quot;https://maps.googleapis.com/maps/api/streetview?size=800x800&amp;location={</span><span style="color: #d0d0d0">latitude</span><span style="color: #ed9d13">},{</span><span style="color: #d0d0d0">longitude</span><span style="color: #ed9d13">}&amp;fov={</span><span style="color: #d0d0d0">fov</span><span style="color: #ed9d13">}&amp;heading={</span><span style="color: #d0d0d0">heading</span><span style="color: #ed9d13">}&amp;pitch={</span><span style="color: #d0d0d0">pitch</span><span style="color: #ed9d13">}&amp;key={</span><span style="color: #d0d0d0">api_key</span><span style="color: #ed9d13">}&quot;</span>
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #6ebf26; font-weight: bold">try</span><span style="color: #d0d0d0">:</span>
<a id="True-6" name="True-6" href="#True-6"></a>        <span style="color: #ababab; font-style: italic"># Send an HTTP GET request to fetch the image</span>
<a id="True-7" name="True-7" href="#True-7"></a>        <span style="color: #d0d0d0">response</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">requests.get(image_url)</span>
<a id="True-8" name="True-8" href="#True-8"></a>        
<a id="True-9" name="True-9" href="#True-9"></a>        <span style="color: #ababab; font-style: italic"># Check if the request was successful (HTTP status code 200)</span>
<a id="True-10" name="True-10" href="#True-10"></a>        <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">response.status_code</span> <span style="color: #d0d0d0">==</span> <span style="color: #51b2fd">200</span><span style="color: #d0d0d0">:</span>
<a id="True-11" name="True-11" href="#True-11"></a>            <span style="color: #ababab; font-style: italic"># Get the image data as bytes</span>
<a id="True-12" name="True-12" href="#True-12"></a>            <span style="color: #d0d0d0">image_data</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">response.content</span>
<a id="True-13" name="True-13" href="#True-13"></a>            
<a id="True-14" name="True-14" href="#True-14"></a>            <span style="color: #ababab; font-style: italic"># Create a Pillow Image object from the image data</span>
<a id="True-15" name="True-15" href="#True-15"></a>            <span style="color: #d0d0d0">img</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">Image.open(BytesIO(image_data))</span>
<a id="True-16" name="True-16" href="#True-16"></a>            
<a id="True-17" name="True-17" href="#True-17"></a>        <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-18" name="True-18" href="#True-18"></a>            <span style="color: #2fbccd">print</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">f&quot;Failed to retrieve the image. Status code: {</span><span style="color: #d0d0d0">response.status_code</span><span style="color: #ed9d13">}&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-19" name="True-19" href="#True-19"></a>
<a id="True-20" name="True-20" href="#True-20"></a>    <span style="color: #6ebf26; font-weight: bold">except</span> <span style="color: #bbbbbb">Exception</span> <span style="color: #6ebf26; font-weight: bold">as</span> <span style="color: #d0d0d0">e:</span>
<a id="True-21" name="True-21" href="#True-21"></a>        <span style="color: #2fbccd">print</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">f&quot;An errorr occurred: {</span><span style="color: #2fbccd">str</span><span style="color: #d0d0d0">(e)</span><span style="color: #ed9d13">}&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-22" name="True-22" href="#True-22"></a>
<a id="True-23" name="True-23" href="#True-23"></a>    <span style="color: #ababab; font-style: italic"># img.save(f&quot;../../temp/site_img.png&quot;)</span>
<a id="True-24" name="True-24" href="#True-24"></a>    <span style="color: #d0d0d0">img.save(Path.joinpath(ROOT_DIR,</span> <span style="color: #ed9d13">&quot;temp/site_img.png&quot;</span><span style="color: #d0d0d0">))</span>
<a id="True-25" name="True-25" href="#True-25"></a>
<a id="True-26" name="True-26" href="#True-26"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">img</span>
</pre></div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">api_key</span> <span class="o">=</span> <span class="n">get_api_key</span><span class="p">()</span>
<span class="n">longitude</span> <span class="o">=</span> <span class="mf">12.5298105</span>
<span class="n">latitude</span> <span class="o">=</span> <span class="mf">55.6675831</span>
<span class="n">pull_street_view_image</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">fov</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span> <span class="n">heading</span> <span class="o">=</span> <span class="mi">180</span><span class="p">,</span> <span class="n">pitch</span> <span class="o">=</span> <span class="mi">90</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">400</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/ef1afeb69cd34810dda2533212ce497ae5d1286692068d6b5450c1ef95caec34.png" src="../_images/ef1afeb69cd34810dda2533212ce497ae5d1286692068d6b5450c1ef95caec34.png" />
</div>
</div>
<section id="further-development">
<h4>Further development<a class="headerlink" href="#further-development" title="Permalink to this heading">#</a></h4>
<p>Currently, the program is constrained to generating square 400x400 images. Nonetheless, for upcoming updates, it is straightforward to merge multiple Google Street View images, thereby creating a significantly broader field of view and attaining higher image resolution in terms of height.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fov</span> <span class="o">=</span> <span class="mi">60</span>
<span class="n">headings</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">360</span><span class="p">,</span> <span class="n">fov</span><span class="p">)</span>
<span class="n">image_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">heading</span> <span class="ow">in</span> <span class="n">headings</span><span class="p">:</span>
    <span class="n">new_image</span> <span class="o">=</span> <span class="n">pull_street_view_image</span><span class="p">(</span><span class="n">api_key</span><span class="p">,</span> <span class="n">longitude</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">heading</span><span class="o">=</span><span class="n">heading</span><span class="p">,</span> <span class="n">fov</span> <span class="o">=</span> <span class="n">fov</span><span class="p">)</span>
    
    <span class="c1"># Append the new image to the list</span>
    <span class="n">image_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_image</span><span class="p">)</span>

<span class="c1"># Calculate the total width needed for the final image</span>
<span class="n">total_width</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">img</span><span class="o">.</span><span class="n">width</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">image_list</span><span class="p">])</span>
<span class="n">max_height</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">img</span><span class="o">.</span><span class="n">height</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">image_list</span><span class="p">])</span>

<span class="c1"># Create a blank canvas for the final image</span>
<span class="n">final_image</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;RGB&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">total_width</span><span class="p">,</span> <span class="n">max_height</span><span class="p">))</span>

<span class="c1"># Paste each image onto the final image</span>
<span class="n">x_offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">image_list</span><span class="p">:</span>
    <span class="n">final_image</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="n">x_offset</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">x_offset</span> <span class="o">+=</span> <span class="n">img</span><span class="o">.</span><span class="n">width</span>

<span class="c1"># Display or save the final image</span>
<span class="n">display</span><span class="p">(</span><span class="n">final_image</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/319c50a964b35d957302f6f7c4b9ddba64a33844aff7caa16c8223d0cd6367b8.png" src="../_images/319c50a964b35d957302f6f7c4b9ddba64a33844aff7caa16c8223d0cd6367b8.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-src/visual/camera_calibration"></span><section class="tex2jax_ignore mathjax_ignore" id="camera-calibration">
<h2>Camera Calibration<a class="headerlink" href="#camera-calibration" title="Permalink to this heading">#</a></h2>
<p>For accurate transformation of the turbine within the Google Street View image, the derivation of the camera matrix is essential. This matrix computes the necessary transformations to convert between the camera coordinate system and the global coordinate system. The theoretical foundation and calculations in this section draw from the material presented by <span id="id1">Hartley and Zisserman [<a class="reference internal" href="src/introduction.html#id8" title="R. I. Hartley and A. Zisserman. Multiple View Geometry in Computer Vision. Cambridge University Press, ISBN: 0521540518, second edition, 2004.">3</a>]</span>.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">print_code</span><span class="p">,</span> <span class="n">intrinsic_parameters</span><span class="p">,</span> <span class="n">rotation_matrix</span><span class="p">,</span> <span class="n">extrinsic_parameters</span><span class="p">,</span> <span class="n">camera_matrix</span><span class="p">,</span> <span class="n">image_plane</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d.art3d</span> <span class="kn">import</span> <span class="n">Poly3DCollection</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>To establish a coherent framework, we begin by defining the global coordinate system. In this context, a right-handed coordinate system is employed, wherein positive changes in the x-axis represent longitudinal shifts, positive changes in the y-axis denote latitudinal shifts, and positive changes in the z-direction signify an increase in elevation.</p>
<a class="bg-primary reference internal image-reference" href="../_images/coord_sys.png"><img alt="coordinate-system" class="bg-primary" src="../_images/coord_sys.png" style="width: 100px;" /></a>
<p><em>Fig 1: Coordinate system used for the camera matrix calculations.</em></p>
<section id="intrinsic-parameters">
<h3>Intrinsic parameters<a class="headerlink" href="#intrinsic-parameters" title="Permalink to this heading">#</a></h3>
<p><span class="math notranslate nohighlight">\(K = \begin{bmatrix}
\alpha_x &amp; \gamma &amp; u_0 &amp; 0\\
0 &amp; \alpha_y &amp; v_0 &amp; 0\\
0 &amp; 0 &amp; 1 &amp; 0
\end{bmatrix}\)</span></p>
<p>The <span class="math notranslate nohighlight">\(K\)</span> matrix comprises five intrinsic parameters specific to the camera model being used. These parameters encompass essential factors such as the focal length, image sensor format, and camera principal point.</p>
<p>Two of these parameters, <span class="math notranslate nohighlight">\(\alpha_x = f \cdot m_x\)</span> and <span class="math notranslate nohighlight">\(\alpha_y = f \cdot m_y\)</span>, express the focal length in terms of pixels. Here, <span class="math notranslate nohighlight">\(m_x\)</span> and <span class="math notranslate nohighlight">\(m_y\)</span> represent the inverses of the width and height of a pixel on the projection plane, while <span class="math notranslate nohighlight">\(f\)</span> denotes the focal length measured in terms of distance. The skew coefficient between the x and y axes, denoted as <span class="math notranslate nohighlight">\(\gamma\)</span>, is typically assumed to be 0. The parameters <span class="math notranslate nohighlight">\(u_0\)</span> and <span class="math notranslate nohighlight">\(v_0\)</span> represent the principal point, ideally located at the center of the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="mf">0.02</span> <span class="c1"># focal length</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">]</span> <span class="c1"># shape of image in pixels</span>
<span class="n">fov</span> <span class="o">=</span> <span class="p">[</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">]</span>

<span class="n">K</span> <span class="o">=</span> <span class="n">intrinsic_parameters</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">fov</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">K</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[216.50635095   0.         125.        ]
 [  0.         216.50635095 125.        ]
 [  0.           0.           1.        ]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="extrinsic-parameters">
<h3>Extrinsic parameters<a class="headerlink" href="#extrinsic-parameters" title="Permalink to this heading">#</a></h3>
<section id="rotation-matrix">
<h4>Rotation Matrix<a class="headerlink" href="#rotation-matrix" title="Permalink to this heading">#</a></h4>
<p>A rotation matrix serves as a transformation matrix employed to execute rotations in space. It facilitates the determination of the necessary rotations for converting between the real-world coordinate system and the camera coordinates by utilizing Euler angles. For instance, following the convention below, the matrix plays a crucial role in this process.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">roll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span> <span class="c1"># roll (X)</span>
<span class="n">pitch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># tilt (Y)</span>
<span class="n">yaw</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># direction (Z)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">])</span> 
<span class="n">R</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s2">&quot;ZYX&quot;</span><span class="p">)</span>
<span class="nb">print</span> <span class="p">(</span><span class="n">R</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[ 1.000000e+00  0.000000e+00  0.000000e+00]
 [ 0.000000e+00  6.123234e-17 -1.000000e+00]
 [ 0.000000e+00  1.000000e+00  6.123234e-17]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="normalized-camera-matrix">
<h4>Normalized Camera Matrix<a class="headerlink" href="#normalized-camera-matrix" title="Permalink to this heading">#</a></h4>
<p>The normalized camera matrix, denoted as <span class="math notranslate nohighlight">\(C_N\)</span>, serves as a transformation matrix that enables the conversion of 3D points from a global coordinate system to 2D points within a camera coordinate system. It accounts for the displacement between the camera’s position and the origin of the global coordinate system.</p>
<p>Mathematically, the matrix can be expressed as:</p>
<p><span class="math notranslate nohighlight">\(C_N = R (I | -ñ)\)</span></p>
<p>Here:</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(R\)</span> represents the rotation matrix that describes the camera’s orientation within the global coordinate system.</p></li>
<li><p><span class="math notranslate nohighlight">\(I\)</span> denotes the identity matrix.</p></li>
<li><p><span class="math notranslate nohighlight">\(ñ\)</span> signifies the translation vector that indicates the camera’s position within the global coordinate system.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># 3D translation of camera origin and world origin</span>
<span class="n">C_N</span> <span class="o">=</span> <span class="n">extrinsic_parameters</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;C_N: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">C_N</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C_N: 
 [[ 1.000000e+00  0.000000e+00  0.000000e+00  0.000000e+00]
 [ 0.000000e+00  6.123234e-17 -1.000000e+00  0.000000e+00]
 [ 0.000000e+00  1.000000e+00  6.123234e-17  0.000000e+00]]
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="camera-matrix">
<h3>Camera Matrix<a class="headerlink" href="#camera-matrix" title="Permalink to this heading">#</a></h3>
<p>The camera matrix can be obtained by computing the cross product of the intrinsic and extrinsic parameters. This camera matrix enables a direct conversion between the 3D coordinate system and the 2D screen coordinate system.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">camera_matrix</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">camera_matrix</span><span style="color: #d0d0d0">(K,</span> <span style="color: #d0d0d0">C_N):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #d0d0d0">P</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">K</span> <span style="color: #d0d0d0">@</span> <span style="color: #d0d0d0">C_N</span>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">P</span>
</pre></div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">P</span> <span class="o">=</span> <span class="n">camera_matrix</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">C_N</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;P: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">P</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>P: 
 [[ 2.16506351e+02  1.25000000e+02  7.65404249e-15  0.00000000e+00]
 [ 0.00000000e+00  1.25000000e+02 -2.16506351e+02  0.00000000e+00]
 [ 0.00000000e+00  1.00000000e+00  6.12323400e-17  0.00000000e+00]]
</pre></div>
</div>
</div>
</div>
</section>
<section id="test-of-function">
<h3>Test of Function<a class="headerlink" href="#test-of-function" title="Permalink to this heading">#</a></h3>
<p>Let’s examine the functions by establishing a point in 3D space. The 2D screen coordinates can be determined through the cross product of the camera matrix and the 3D world coordinates, followed by normalizing the outcome.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">image_plane</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">image_plane</span><span style="color: #d0d0d0">(P,</span> <span style="color: #d0d0d0">point_coordinate):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #d0d0d0">point_coordinate</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.append(point_coordinate,</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)</span>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">res</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">P</span> <span style="color: #d0d0d0">@</span> <span style="color: #d0d0d0">point_coordinate</span>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">u,</span> <span style="color: #d0d0d0">v</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(res/res[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">])[:</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]</span>
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">u,</span> <span style="color: #d0d0d0">v</span>
</pre></div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">point_3D_origin</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">image_plane</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">point_3D_origin</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;U: </span><span class="si">{</span><span class="n">u</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> px</span><span class="se">\n</span><span class="s2">V: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> px&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>U: 125.0 px
V: 125.0 px
</pre></div>
</div>
</div>
</div>
<p>Let’s proceed to calculate the screen coordinates of a point in 3D space, covering the entire process from start to finish.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># INPUTS</span>
<span class="n">f</span> <span class="o">=</span> <span class="mf">0.1</span> <span class="c1"># focal length</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="mi">250</span><span class="p">,</span> <span class="mi">250</span><span class="p">]</span> <span class="c1"># shape of image in pixels</span>
<span class="n">fov</span> <span class="o">=</span> <span class="p">[</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">]</span>
<span class="n">K</span> <span class="o">=</span> <span class="n">intrinsic_parameters</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">shape</span><span class="p">,</span> <span class="n">fov</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">90</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">0</span><span class="p">)])</span> <span class="c1"># roll, pitch, yaw</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">rotation_matrix</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">)</span>
<span class="n">camera_origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="c1"># 3D translation of camera origin and world origin</span>
<span class="n">C_N</span> <span class="o">=</span> <span class="n">extrinsic_parameters</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">camera_origin</span><span class="p">)</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">camera_matrix</span><span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">C_N</span><span class="p">)</span>
<span class="n">turbine_origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">image_plane</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">turbine_origin</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;U: </span><span class="si">{</span><span class="n">u</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> px</span><span class="se">\n</span><span class="s2">V: </span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> px&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>U: 125.0 px
V: 125.0 px
</pre></div>
</div>
</div>
</div>
<p>To visualize what the camera sees, you can plot the calculated screen coordinates. Here’s an example of how you can achieve that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Point (</span><span class="si">{</span><span class="n">u</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">v</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> 
       <span class="n">ylim</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
       <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;U [px]&quot;</span><span class="p">,</span>
       <span class="n">ylabel</span> <span class="o">=</span> <span class="s2">&quot;V [px]&quot;</span><span class="p">,</span>
       <span class="n">aspect</span> <span class="o">=</span> <span class="s2">&quot;equal&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8743023f48f9ee872409d3020649ce2cb61c2105a7b160b9d097892b5971166d.png" src="../_images/8743023f48f9ee872409d3020649ce2cb61c2105a7b160b9d097892b5971166d.png" />
</div>
</div>
<section id="d-model">
<h4>3D Model<a class="headerlink" href="#d-model" title="Permalink to this heading">#</a></h4>
<p>To visualize the movement of the camera sensor with the rotation of the camera in relation to the world coordinate system, you can create a plot that includes the world origin, camera origin, and a point in 3D space. The plot will also feature a colored surface representing the inverted camera sensor, showing where the 3D point appears on the sensor along the line-of-sight between the camera and the point. If the line does not intersect the sensor, the point should not appear in the image. Here’s an example of how you can create such a plot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a 3D plot</span>
<span class="n">theta</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>

<span class="c1"># Define the origin for world coordinates and unit vectors along the world coordinates</span>
<span class="n">world_origin</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">world_x_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">world_y_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">world_z_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<span class="c1"># Define the origin for camera coordinates and unit vectors along the camera coordinates</span>
<span class="n">camera_x_vector</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="n">world_x_vector</span>
<span class="n">camera_y_vector</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="n">world_y_vector</span> 
<span class="n">camera_z_vector</span> <span class="o">=</span> <span class="n">R</span> <span class="o">@</span> <span class="n">world_z_vector</span>

<span class="c1"># Plot the world coordinate system with labels</span>
<span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="o">*</span><span class="n">world_origin</span><span class="p">,</span> <span class="o">*</span><span class="n">world_x_vector</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;World X-axis&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="o">*</span><span class="n">world_origin</span><span class="p">,</span> <span class="o">*</span><span class="n">world_y_vector</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;World Y-axis&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="o">*</span><span class="n">world_origin</span><span class="p">,</span> <span class="o">*</span><span class="n">world_z_vector</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;World Z-axis&#39;</span><span class="p">)</span>

<span class="c1"># Plot the camera coordinate system with labels</span>
<span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="o">*</span><span class="n">camera_origin</span><span class="p">,</span> <span class="o">*</span><span class="n">camera_x_vector</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Camera X-axis&#39;</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="o">*</span><span class="n">camera_origin</span><span class="p">,</span> <span class="o">*</span><span class="n">camera_y_vector</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Camera Y-axis&#39;</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="o">*</span><span class="n">camera_origin</span><span class="p">,</span> <span class="o">*</span><span class="n">camera_z_vector</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Camera Z-axis&#39;</span><span class="p">,</span> <span class="n">ls</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span><span class="p">)</span>

<span class="c1"># Plot the 3D point with a label</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">turbine_origin</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Point&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">world_origin</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;World Origin&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">camera_origin</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Camera Origin&quot;</span><span class="p">)</span>

<span class="c1">#### INPUTS #####</span>
<span class="n">f</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">vfov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>
<span class="n">hfov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mi">90</span><span class="p">)</span>

<span class="n">vl</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">vfov</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">f</span> <span class="c1"># vertical length</span>
<span class="n">hl</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">hfov</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">f</span> <span class="c1"># horizontal length</span>
<span class="n">zz</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="c1"># offset in z</span>
<span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">hl</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">hl</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">vl</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">vl</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">coord</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,kj-&gt;ki&#39;</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">xx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">yy</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">zz</span><span class="o">.</span><span class="n">ravel</span><span class="p">()])</span> <span class="o">+</span> <span class="n">camera_origin</span> <span class="c1"># &#39;ij,kj-&gt;ki&#39;</span>
<span class="n">vertices</span> <span class="o">=</span> <span class="p">[</span><span class="n">coord</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span> <span class="n">coord</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]]]</span>
<span class="n">surface</span> <span class="o">=</span> <span class="n">Poly3DCollection</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
<span class="n">surface</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_collection3d</span><span class="p">(</span><span class="n">surface</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">camera_origin</span><span class="p">,</span> <span class="n">turbine_origin</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;Line of Sight&quot;</span><span class="p">)</span>

<span class="n">s</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">world_origin</span><span class="p">,</span> <span class="n">camera_origin</span><span class="p">,</span> <span class="n">turbine_origin</span><span class="p">])</span>
<span class="nb">min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">/</span><span class="n">s</span><span class="o">-</span><span class="mi">1</span>
<span class="nb">max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="o">*</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">max</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">world_origin</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">max</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span><span class="o">+</span><span class="n">world_origin</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>

<span class="n">offset</span> <span class="o">=</span> <span class="n">camera_origin</span> <span class="o">-</span> <span class="n">turbine_origin</span>
<span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">offset</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="c1"># Set axis labels</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;Z&#39;</span><span class="p">)</span>

<span class="c1"># set range of plot</span>
<span class="n">coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">world_origin</span><span class="p">,</span> <span class="n">turbine_origin</span><span class="p">])</span>
<span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">max_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_range</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_range</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_range</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_range</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlim</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">max_range</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">max_range</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper center&#39;</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/dd8a7f0e981a63e0dbdef9f0a0ddd9542a3eac969f1be8302038859fd8d877eb.png" src="../_images/dd8a7f0e981a63e0dbdef9f0a0ddd9542a3eac969f1be8302038859fd8d877eb.png" />
</div>
</div>
</section>
</section>
</section>
<span id="document-src/visual/3d_object_to_image"></span><section class="tex2jax_ignore mathjax_ignore" id="convert-obj-file-to-png">
<h2>Convert OBJ file to PNG<a class="headerlink" href="#convert-obj-file-to-png" title="Permalink to this heading">#</a></h2>
<p>To produce images of wind turbines for visual impact assessment, the program loads .obj files and converts them into .png files. This conversion involves utilizing the view angle and wind direction to appropriately rotate the object file in the desired orientation.</p>
<div class="cell tag_hide-input tag_thebe-init docutils container">
<details class="hide above-input">
<summary aria-label="Toggle hidden content">
<span class="collapsed">Show code cell source</span>
<span class="expanded">Hide code cell source</span>
</summary>
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>
<span class="kn">from</span> <span class="nn">src.utils</span> <span class="kn">import</span> <span class="n">print_code</span><span class="p">,</span> <span class="n">load_and_normalize_obj</span><span class="p">,</span> <span class="n">plot_trisurface</span><span class="p">,</span> <span class="n">crop_image</span><span class="p">,</span> <span class="n">adjust_image</span><span class="p">,</span> <span class="n">plot_trisurface</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
</details>
</div>
<p>Initially, the program loads vertices and faces from the .obj file and normalizes them based on the total height of the wind turbine.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">load_and_normalize_obj</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">load_and_normalize_obj</span><span style="color: #d0d0d0">(file_path,</span> <span style="color: #d0d0d0">total_height</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #d0d0d0">V,</span> <span style="color: #d0d0d0">F</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[],</span> <span style="color: #d0d0d0">[]</span>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #6ebf26; font-weight: bold">with</span> <span style="color: #2fbccd">open</span><span style="color: #d0d0d0">(file_path)</span> <span style="color: #6ebf26; font-weight: bold">as</span> <span style="color: #d0d0d0">f:</span>
<a id="True-4" name="True-4" href="#True-4"></a>        <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">line</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #d0d0d0">f.readlines():</span>
<a id="True-5" name="True-5" href="#True-5"></a>            <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">line.startswith(</span><span style="color: #ed9d13">&#39;#&#39;</span><span style="color: #d0d0d0">):</span>
<a id="True-6" name="True-6" href="#True-6"></a>                <span style="color: #6ebf26; font-weight: bold">continue</span>
<a id="True-7" name="True-7" href="#True-7"></a>            <span style="color: #d0d0d0">values</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">line.split()</span>
<a id="True-8" name="True-8" href="#True-8"></a>            <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #6ebf26; font-weight: bold">not</span> <span style="color: #d0d0d0">values:</span>
<a id="True-9" name="True-9" href="#True-9"></a>                <span style="color: #6ebf26; font-weight: bold">continue</span>
<a id="True-10" name="True-10" href="#True-10"></a>            <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">values[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&#39;v&#39;</span><span style="color: #d0d0d0">:</span>
<a id="True-11" name="True-11" href="#True-11"></a>                <span style="color: #d0d0d0">V.append([</span><span style="color: #2fbccd">float</span><span style="color: #d0d0d0">(x)</span> <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">x</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #d0d0d0">values[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">:</span><span style="color: #51b2fd">4</span><span style="color: #d0d0d0">]])</span>
<a id="True-12" name="True-12" href="#True-12"></a>            <span style="color: #6ebf26; font-weight: bold">elif</span> <span style="color: #d0d0d0">values[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span> <span style="color: #d0d0d0">==</span> <span style="color: #ed9d13">&#39;f&#39;</span> <span style="color: #d0d0d0">:</span>
<a id="True-13" name="True-13" href="#True-13"></a>                <span style="color: #d0d0d0">F.append([</span><span style="color: #2fbccd">int</span><span style="color: #d0d0d0">(x.split(</span><span style="color: #ed9d13">&quot;/&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">)[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">])</span> <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">x</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #d0d0d0">values[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">:</span><span style="color: #51b2fd">4</span><span style="color: #d0d0d0">]])</span>
<a id="True-14" name="True-14" href="#True-14"></a>    <span style="color: #d0d0d0">V,</span> <span style="color: #d0d0d0">F</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.array(V),</span> <span style="color: #d0d0d0">np.array(F)-</span><span style="color: #51b2fd">1</span>
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #d0d0d0">V</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">(V</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">np.min(V[:,</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]))</span> <span style="color: #d0d0d0">/</span> <span style="color: #d0d0d0">(np.max(V[:,</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">])</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">np.min(V[:,</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">]))*total_height</span>
<a id="True-16" name="True-16" href="#True-16"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">V,</span> <span style="color: #d0d0d0">F</span>
</pre></div>
</div></div>
</div>
<p>The vertices are represented by points in 3D space, while the faces are defined by the indices of the vertices that form the face.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">V</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">load_and_normalize_obj</span><span class="p">(</span><span class="s2">&quot;../../assets/turbine.obj&quot;</span><span class="p">,</span> <span class="n">total_height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;V: &quot;</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">F: &quot;</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>V:  [[-0.38323411 -0.04002556  0.67077201]
 [-0.38322772 -0.03992025  0.67064993]
 [-0.38322314 -0.04018633  0.67075629]
 ...
 [ 0.19505491 -0.03958282  0.99919489]
 [ 0.19505738 -0.03963892  0.99921006]
 [ 0.1950604  -0.03974164  0.99916952]] 

F:  [[475 444 471]
 [477 492 471]
 [475 471 492]
 ...
 [388 583 348]
 [532 583 388]
 [466 532 388]]
</pre></div>
</div>
</div>
</div>
<p>Following that, the vertices and faces are loaded into <code class="docutils literal notranslate"><span class="pre">matplotlib</span></code>, and a 3D plot is created using <code class="docutils literal notranslate"><span class="pre">plt.plot_trisurf</span></code>. The background of the 3D plot is set to transparent and the image is thereafter saved as a .png file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">plot_trisurface</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">plot_trisurface</span><span style="color: #d0d0d0">(file_path,</span> <span style="color: #d0d0d0">elevation</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">azimuth</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">view_height</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">total_height</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">show_plot</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ebf26; font-weight: bold">True</span><span style="color: #d0d0d0">):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">V,</span> <span style="color: #d0d0d0">F</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">load_and_normalize_obj(file_path,</span> <span style="color: #d0d0d0">total_height</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">total_height)</span>
<a id="True-4" name="True-4" href="#True-4"></a>
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #d0d0d0">fig</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">plt.figure(figsize=(</span><span style="color: #51b2fd">6</span><span style="color: #d0d0d0">,</span><span style="color: #51b2fd">6</span><span style="color: #d0d0d0">))</span>
<a id="True-6" name="True-6" href="#True-6"></a>    <span style="color: #d0d0d0">ax</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">fig.add_subplot(</span><span style="color: #51b2fd">111</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">projection=</span><span style="color: #ed9d13">&quot;3d&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-7" name="True-7" href="#True-7"></a>
<a id="True-8" name="True-8" href="#True-8"></a>    <span style="color: #d0d0d0">plt.axis(</span><span style="color: #ed9d13">&#39;off&#39;</span><span style="color: #d0d0d0">)</span>
<a id="True-9" name="True-9" href="#True-9"></a>    <span style="color: #d0d0d0">plt.grid(visible=</span><span style="color: #6ebf26; font-weight: bold">None</span><span style="color: #d0d0d0">)</span>
<a id="True-10" name="True-10" href="#True-10"></a>    <span style="color: #d0d0d0">ax.view_init(elev=elevation,</span> <span style="color: #d0d0d0">azim=azimuth)</span>
<a id="True-11" name="True-11" href="#True-11"></a>
<a id="True-12" name="True-12" href="#True-12"></a>    <span style="color: #d0d0d0">tri</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">ax.plot_trisurf(V[:,</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">V[:,</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">F,</span> <span style="color: #d0d0d0">V[:,</span> <span style="color: #51b2fd">2</span><span style="color: #d0d0d0">],</span> <span style="color: #d0d0d0">linewidth=</span><span style="color: #51b2fd">0.1</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">antialiased=</span><span style="color: #6ebf26; font-weight: bold">True</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">closed=</span><span style="color: #6ebf26; font-weight: bold">True</span><span style="color: #d0d0d0">)</span>
<a id="True-13" name="True-13" href="#True-13"></a>    <span style="color: #d0d0d0">tri.set(facecolor</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;white&quot;</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">edgecolor</span> <span style="color: #d0d0d0">=</span> <span style="color: #ed9d13">&quot;gray&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-14" name="True-14" href="#True-14"></a>
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #d0d0d0">limits</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.array([</span><span style="color: #2fbccd">getattr</span><span style="color: #d0d0d0">(ax,</span> <span style="color: #ed9d13">f&quot;get_{</span><span style="color: #d0d0d0">axis</span><span style="color: #ed9d13">}lim&quot;</span><span style="color: #d0d0d0">)()</span> <span style="color: #6ebf26; font-weight: bold">for</span> <span style="color: #d0d0d0">axis</span> <span style="color: #6ebf26; font-weight: bold">in</span> <span style="color: #ed9d13">&quot;xyz&quot;</span><span style="color: #d0d0d0">])</span>
<a id="True-16" name="True-16" href="#True-16"></a>    <span style="color: #d0d0d0">lower_bound</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.minimum(</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">2</span><span style="color: #d0d0d0">*view_height</span> <span style="color: #d0d0d0">-</span> <span style="color: #d0d0d0">total_height)</span>
<a id="True-17" name="True-17" href="#True-17"></a>    <span style="color: #d0d0d0">upper_bound</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.maximum(total_height,</span> <span style="color: #51b2fd">2</span><span style="color: #d0d0d0">*view_height)</span>
<a id="True-18" name="True-18" href="#True-18"></a>    <span style="color: #d0d0d0">limits[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">,:]</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[lower_bound,</span> <span style="color: #d0d0d0">upper_bound]</span>
<a id="True-19" name="True-19" href="#True-19"></a>    <span style="color: #d0d0d0">ax.set(zlim=limits[</span><span style="color: #51b2fd">2</span><span style="color: #d0d0d0">,:],</span> <span style="color: #d0d0d0">aspect=</span><span style="color: #ed9d13">&quot;equal&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-20" name="True-20" href="#True-20"></a>
<a id="True-21" name="True-21" href="#True-21"></a>    <span style="color: #d0d0d0">plt.savefig(Path.joinpath(ROOT_DIR,</span> <span style="color: #ed9d13">&quot;temp/obj2png.png&quot;</span><span style="color: #d0d0d0">),</span> <span style="color: #d0d0d0">dpi=</span><span style="color: #51b2fd">600</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">transparent=</span><span style="color: #6ebf26; font-weight: bold">True</span><span style="color: #d0d0d0">)</span>
<a id="True-22" name="True-22" href="#True-22"></a>    <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">show_plot:</span>
<a id="True-23" name="True-23" href="#True-23"></a>        <span style="color: #d0d0d0">plt.show()</span>
<a id="True-24" name="True-24" href="#True-24"></a>    <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-25" name="True-25" href="#True-25"></a>        <span style="color: #d0d0d0">plt.close()</span> <span style="color: #ababab; font-style: italic"># prevent plot from showing</span>
</pre></div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_trisurface</span><span class="p">(</span><span class="s2">&quot;../../assets/turbine.obj&quot;</span><span class="p">,</span> <span class="n">azimuth</span><span class="o">=-</span><span class="mi">90</span><span class="p">)</span>    
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/9a7006ffe2f340cfc8d19db490fb10ae03a3cc69fa9a2def07ba7959bfd8d5b5.png" src="../_images/9a7006ffe2f340cfc8d19db490fb10ae03a3cc69fa9a2def07ba7959bfd8d5b5.png" />
</div>
</div>
<p>The image needs to be cropped to remove the axis from the plot. This is done be removing the 5 border pixels of the image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">crop_image</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">crop_image</span><span style="color: #d0d0d0">(file_path,</span> <span style="color: #d0d0d0">display_image</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ebf26; font-weight: bold">True</span><span style="color: #d0d0d0">):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #d0d0d0">pil_image</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">Image.open(file_path)</span>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #d0d0d0">pil_image</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">pil_image.crop((</span><span style="color: #51b2fd">5</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">5</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">pil_image.size[</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]-</span><span style="color: #51b2fd">5</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">pil_image.size[</span><span style="color: #51b2fd">1</span><span style="color: #d0d0d0">]-</span><span style="color: #51b2fd">5</span><span style="color: #d0d0d0">))</span>
<a id="True-4" name="True-4" href="#True-4"></a>    <span style="color: #d0d0d0">np_array</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.array(pil_image)</span>
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #d0d0d0">blank_px</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">[</span><span style="color: #51b2fd">255</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">255</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">255</span><span style="color: #d0d0d0">,</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">]</span>
<a id="True-6" name="True-6" href="#True-6"></a>    <span style="color: #d0d0d0">mask</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np_array</span> <span style="color: #d0d0d0">!=</span> <span style="color: #d0d0d0">blank_px</span>
<a id="True-7" name="True-7" href="#True-7"></a>    <span style="color: #d0d0d0">coords</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np.argwhere(mask)</span>
<a id="True-8" name="True-8" href="#True-8"></a>    <span style="color: #d0d0d0">x0,</span> <span style="color: #d0d0d0">y0,</span> <span style="color: #d0d0d0">z0</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">coords.min(axis=</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">)</span>
<a id="True-9" name="True-9" href="#True-9"></a>    <span style="color: #d0d0d0">x1,</span> <span style="color: #d0d0d0">y1,</span> <span style="color: #d0d0d0">z1</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">coords.max(axis=</span><span style="color: #51b2fd">0</span><span style="color: #d0d0d0">)</span> <span style="color: #d0d0d0">+</span> <span style="color: #51b2fd">1</span>
<a id="True-10" name="True-10" href="#True-10"></a>    <span style="color: #d0d0d0">cropped_box</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">np_array[x0:x1,</span> <span style="color: #d0d0d0">y0:y1,</span> <span style="color: #51b2fd">0</span><span style="color: #d0d0d0">:</span><span style="color: #51b2fd">4</span><span style="color: #d0d0d0">]</span>
<a id="True-11" name="True-11" href="#True-11"></a>    <span style="color: #d0d0d0">pil_image</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">Image.fromarray(cropped_box,</span> <span style="color: #ed9d13">&#39;RGBA&#39;</span><span style="color: #d0d0d0">)</span>
<a id="True-12" name="True-12" href="#True-12"></a>    <span style="color: #d0d0d0">pil_image.save(file_path)</span>
<a id="True-13" name="True-13" href="#True-13"></a>
<a id="True-14" name="True-14" href="#True-14"></a>    <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">display_image:</span>
<a id="True-15" name="True-15" href="#True-15"></a>        <span style="color: #d0d0d0">display(pil_image)</span>
<a id="True-16" name="True-16" href="#True-16"></a>
<a id="True-17" name="True-17" href="#True-17"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">pil_image</span>
</pre></div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pil_image</span> <span class="o">=</span> <span class="n">crop_image</span><span class="p">(</span><span class="s2">&quot;../../temp/obj2png.png&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/8d1a7db9a805c59212aa1ceced57ef2af5c86ebc34ba03c8c67a7944a0f1dbee.png" src="../_images/8d1a7db9a805c59212aa1ceced57ef2af5c86ebc34ba03c8c67a7944a0f1dbee.png" />
</div>
</div>
<p>Lastly, the image needs to be adjusted according to the weather conditions of the Google Street View image.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">print_code</span><span class="p">(</span><span class="n">adjust_image</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div class="highlight" style="background: #202020"><pre style="line-height: 125%;"><span></span><a id="True-1" name="True-1" href="#True-1"></a><span style="color: #6ebf26; font-weight: bold">def</span> <span style="color: #71adff">adjust_image</span><span style="color: #d0d0d0">(image_path,</span> <span style="color: #d0d0d0">brightness</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">contrast</span> <span style="color: #d0d0d0">=</span> <span style="color: #51b2fd">1</span><span style="color: #d0d0d0">,</span> <span style="color: #d0d0d0">display_image</span> <span style="color: #d0d0d0">=</span> <span style="color: #6ebf26; font-weight: bold">True</span><span style="color: #d0d0d0">):</span>
<a id="True-2" name="True-2" href="#True-2"></a>    <span style="color: #ababab; font-style: italic"># Load the image using PIL.</span>
<a id="True-3" name="True-3" href="#True-3"></a>    <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #2fbccd">isinstance</span><span style="color: #d0d0d0">(image_path,</span> <span style="color: #d0d0d0">(pathlib.PosixPath,</span> <span style="color: #2fbccd">str</span><span style="color: #d0d0d0">)):</span>
<a id="True-4" name="True-4" href="#True-4"></a>        <span style="color: #d0d0d0">image</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">Image.open(image_path)</span>
<a id="True-5" name="True-5" href="#True-5"></a>    <span style="color: #6ebf26; font-weight: bold">elif</span> <span style="color: #2fbccd">isinstance</span><span style="color: #d0d0d0">(image_path,</span> <span style="color: #d0d0d0">PIL.Image.Image):</span>
<a id="True-6" name="True-6" href="#True-6"></a>        <span style="color: #d0d0d0">image</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">image_path</span>
<a id="True-7" name="True-7" href="#True-7"></a>    <span style="color: #6ebf26; font-weight: bold">else</span><span style="color: #d0d0d0">:</span>
<a id="True-8" name="True-8" href="#True-8"></a>        <span style="color: #2fbccd">print</span><span style="color: #d0d0d0">(</span><span style="color: #ed9d13">f&quot;DataTypeError: {</span><span style="color: #2fbccd">type</span><span style="color: #d0d0d0">(image_path)</span><span style="color: #ed9d13">} is an unsupported DataType.&quot;</span><span style="color: #d0d0d0">)</span>
<a id="True-9" name="True-9" href="#True-9"></a>
<a id="True-10" name="True-10" href="#True-10"></a>    <span style="color: #ababab; font-style: italic"># Apply the brightness and contrast adjustments to the image.</span>
<a id="True-11" name="True-11" href="#True-11"></a>    <span style="color: #d0d0d0">enhancer</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">ImageEnhance.Brightness(image)</span>
<a id="True-12" name="True-12" href="#True-12"></a>    <span style="color: #d0d0d0">image</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">enhancer.enhance(brightness)</span>
<a id="True-13" name="True-13" href="#True-13"></a>
<a id="True-14" name="True-14" href="#True-14"></a>    <span style="color: #d0d0d0">enhancer</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">ImageEnhance.Contrast(image)</span>
<a id="True-15" name="True-15" href="#True-15"></a>    <span style="color: #d0d0d0">image</span> <span style="color: #d0d0d0">=</span> <span style="color: #d0d0d0">enhancer.enhance(contrast)</span>
<a id="True-16" name="True-16" href="#True-16"></a>
<a id="True-17" name="True-17" href="#True-17"></a>    <span style="color: #ababab; font-style: italic"># Save or display the adjusted image.</span>
<a id="True-18" name="True-18" href="#True-18"></a>    <span style="color: #ababab; font-style: italic"># image.save(&quot;../../temp/obj2png.png&quot;)</span>
<a id="True-19" name="True-19" href="#True-19"></a>    <span style="color: #d0d0d0">image.save(Path.joinpath(ROOT_DIR,</span> <span style="color: #ed9d13">&quot;temp/obj2png.png&quot;</span><span style="color: #d0d0d0">))</span>
<a id="True-20" name="True-20" href="#True-20"></a>    <span style="color: #6ebf26; font-weight: bold">if</span> <span style="color: #d0d0d0">display_image:</span>
<a id="True-21" name="True-21" href="#True-21"></a>        <span style="color: #d0d0d0">display(image)</span>
<a id="True-22" name="True-22" href="#True-22"></a>    <span style="color: #6ebf26; font-weight: bold">return</span> <span style="color: #d0d0d0">image</span>
</pre></div>
</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">image</span> <span class="o">=</span> <span class="n">adjust_image</span><span class="p">(</span><span class="s2">&quot;../../temp/obj2png.png&quot;</span><span class="p">,</span> <span class="n">brightness</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">contrast</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/40bc33a0f73067169063b02cfb803df4f3577b395883f252a4f8d91f526ff73c.png" src="../_images/40bc33a0f73067169063b02cfb803df4f3577b395883f252a4f8d91f526ff73c.png" />
</div>
</div>
<p>Currently, the program applies a fixed 50% reduction in contrast and brightness, as weather data hasn’t been integrated. This configuration is subject to adjustment in future iterations.</p>
</section>
</div>
</section>
<span id="document-src/bibliography"></span><section class="tex2jax_ignore mathjax_ignore" id="bibliography">
<h1>Bibliography<a class="headerlink" href="#bibliography" title="Permalink to this heading">#</a></h1>
<div class="docutils container" id="id1">
<div class="citation" id="id2" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></span>
<p>John Amanatides and Andrew Woo. A fast voxel traversal algorithm for ray tracing. <em>Proceedings of EuroGraphics</em>, 1987.</p>
</div>
<div class="citation" id="id7" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></span>
<p>Mihai Bugaru, Ovidiu Vasile, and Marian Neagoe. Recent Developments of Noise Attenuation Using Acoustic Barriers for a Specific Edge Geometry. <em>Computation</em>, 9(12):129, Dec 2021. Number: 12. URL: <a class="reference external" href="https://www.mdpi.com/2079-3197/9/12/129">https://www.mdpi.com/2079-3197/9/12/129</a> (visited on 2023-11-16), <a class="reference external" href="https://doi.org/10.3390/computation9120129">doi:10.3390/computation9120129</a>.</p>
</div>
<div class="citation" id="id8" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></span>
<p>R. I. Hartley and A. Zisserman. <em>Multiple View Geometry in Computer Vision</em>. Cambridge University Press, ISBN: 0521540518, second edition, 2004.</p>
</div>
<div class="citation" id="id10" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></span>
<p>NASA. Icesat - srtm30 documentation. 2000. URL: <a class="reference external" href="https://icesat.gsfc.nasa.gov/icesat/tools/SRTM30_Documentation.html">https://icesat.gsfc.nasa.gov/icesat/tools/SRTM30_Documentation.html</a> (visited on 2023-11-27).</p>
</div>
<div class="citation" id="id9" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></span>
<p>Quae.nl. Astronomy answers: position of the sun. 2021. URL: <a class="reference external" href="https://www.aa.quae.nl/en/reken/zonpositie.html">https://www.aa.quae.nl/en/reken/zonpositie.html</a> (visited on 2023-11-27).</p>
</div>
<div class="citation" id="id6" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></span>
<p>WindPro. Introduction to environmental calculations. 2002. URL: <a class="reference external" href="https://help.emd.dk/knowledgebase/content/windPRO3.6/c6-UK_WindPRO3.6-Environment.pdf">https://help.emd.dk/knowledgebase/content/windPRO3.6/c6-UK_WindPRO3.6-Environment.pdf</a> (visited on 2023-11-29).</p>
</div>
<div class="citation" id="id4" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>7<span class="fn-bracket">]</span></span>
<p>Blazing Star Wind Farm, LLC. Docket no. 16-686, blazing star i, technology change attachment b, 20189-146376-01. 2018. URL: <a class="reference external" href="https://www.edockets.state.mn.us/edockets/searchDocuments.do?method=showPoup&amp;documentId={409ED365-0000-CD11-8777-FBD4CC5B94A3}&amp;documentTitle=20189-146376-01">https://www.edockets.state.mn.us/edockets/searchDocuments.do?method=showPoup&amp;documentId={409ED365-0000-CD11-8777-FBD4CC5B94A3}&amp;documentTitle=20189-146376-01</a> (visited on 2023-11-29).</p>
</div>
<div class="citation" id="id5" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>8<span class="fn-bracket">]</span></span>
<p>Etha Wind Oy. Noise study wind farm juurakko. 2014. URL: <a class="reference external" href="https://kalajoki.fi/wp-content/uploads/2020/11/Liite4_Juurakko_Noise_Study_CG200603-1AM.pdf">https://kalajoki.fi/wp-content/uploads/2020/11/Liite4_Juurakko_Noise_Study_CG200603-1AM.pdf</a> (visited on 2023-11-29).</p>
</div>
<div class="citation" id="id14" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>9<span class="fn-bracket">]</span></span>
<p>Indenrigs og Boligministeriet. Bekendtgørelse om støj fra vindmøller. <em>Indenrigs og Boligmin. Bolig og planstyrelsen j.nr</em>, 2019. URL: <a class="reference external" href="https://www.retsinformation.dk/eli/lta/2019/135">https://www.retsinformation.dk/eli/lta/2019/135</a> (visited on 2023-08-06).</p>
</div>
<div class="citation" id="id15" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>10<span class="fn-bracket">]</span></span>
<p>Københavns Kommune. Vindmøller på prøvestenen. 2011. URL: <a class="reference external" href="https://www.kk.dk/sites/default/files/agenda/90ae9f00-a1e1-469e-bbd5-018f54baa076/491190df-8954-4ca4-b787-131c4a2ed031-bilag-6.pdf">https://www.kk.dk/sites/default/files/agenda/90ae9f00-a1e1-469e-bbd5-018f54baa076/491190df-8954-4ca4-b787-131c4a2ed031-bilag-6.pdf</a> (visited on 2023-08-06).</p>
</div>
<div class="citation" id="id3" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>11<span class="fn-bracket">]</span></span>
<p>MAS Environmental Ltd. dBmap.net Noise Mapping Tool. URL: <a class="reference external" href="https://noisetools.net/dbmap/">https://noisetools.net/dbmap/</a> (visited on 2023-11-29).</p>
</div>
<div class="citation" id="id12" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>12<span class="fn-bracket">]</span></span>
<p>Technical Committee ISO/TC 43/SC 1. ISO 9613-2:1996, Acoustics — Attenuation of sound during propagation outdoors — Part 1: Calculation of the absorption of Sound by the atmosphere. Technical Report, International Organization for Standardization, Geneva, Switzerland, 1993. URL: <a class="reference external" href="https://www.iso.org/standard/17426.html">https://www.iso.org/standard/17426.html</a> (visited on 2023-08-06).</p>
</div>
<div class="citation" id="id11" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>13<span class="fn-bracket">]</span></span>
<p>Technical Committee ISO/TC 43/SC 1. ISO 9613-2:1996, Acoustics — Attenuation of sound during propagation outdoors — Part 2: General method of calculation. Technical Report, International Organization for Standardization, Geneva, Switzerland, 1996. URL: <a class="reference external" href="https://www.iso.org/standard/20649.html">https://www.iso.org/standard/20649.html</a> (visited on 2023-08-06).</p>
</div>
<div class="citation" id="id13" role="doc-biblioentry">
<span class="label"><span class="fn-bracket">[</span>14<span class="fn-bracket">]</span></span>
<p>Technical Committee ISO/TC 43/SC 1. ISO 17534-3:2015, Acoustics — Software for the calculation of sound outdoors — Part 3: Recommendations for quality assured implementation of ISO 9613-2 in software according to ISO 17534-1. Technical Report, International Organization for Standardization, Geneva, Switzerland, 2015. URL: <a class="reference external" href="https://www.iso.org/standard/66128.html">https://www.iso.org/standard/66128.html</a> (visited on 2023-08-06).</p>
</div>
</div>
</div>
</section>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "FPWRasmussen/DTU-Special-Course",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./src"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/map/elevation_handler">Elevation Handler</a></li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/noise_map">Noise Map</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/geometrical_spreading_of_sound">Geometrical Spreading of Sound</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/atmospheric_attenuation">Atmospheric Attenuation</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/ground_effect">Ground Effect</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/barrier_attenuation">Barrier Attenuation</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/noise/verification">Barrier Verification</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/shadow_map">Shadow Map</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/fast_voxel_traversal">Fast Voxel Traversal</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/sun_calc">Solar Calculations</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/rotor_point_cloud">Rotor Point Cloud</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/shadow/multiprocessing">Multiprocessing</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/visual/visual_impact">Visual Impact</a><ul class="visible nav section-nav flex-column">
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/visual/google_street_view">Google Street View</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/visual/camera_calibration">Camera Calibration</a></li>
<li class="toctree-l2 toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/visual/3d_object_to_image">3D Object to Image</a></li>
</ul>
</li>
<li class="toctree-l1 toc-h1 nav-item toc-entry"><a class="reference internal nav-link" href="src/introduction.html#document-src/bibliography">Bibliography</a></li>
</ul>

  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Frederik P. W. Rasmussen
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2022.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>